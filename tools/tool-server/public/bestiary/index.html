<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epoch Bestiary Architect</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            background-color: #0f172a;
            color: #f1f5f9;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS ---
        const IconBase = ({ d, className, color }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={ className } style={ { color: color } }>
                { d }
            </svg>
        );

        const Database = (props) => <IconBase { ...props } d={ <><ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" /><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" /></> } />;
        const Save = (props) => <IconBase { ...props } d={ <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></> } />;
        const Trash2 = (props) => <IconBase { ...props } d={ <><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></> } />;
        const Plus = (props) => <IconBase { ...props } d={ <><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></> } />;
        const Shield = (props) => <IconBase { ...props } d={ <><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></> } />;
        const Heart = (props) => <IconBase { ...props } d={ <><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" /></> } />;
        const Globe = (props) => <IconBase { ...props } d={ <><circle cx="12" cy="12" r="10" /><line x1="2" y1="12" x2="22" y2="12" /><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" /></> } />;
        const Swords = (props) => <IconBase { ...props } d={ <><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5" /><line x1="13" y1="19" x2="19" y2="13" /><line x1="16" y1="16" x2="20" y2="20" /><line x1="19" y1="21" x2="21" y2="19" /><polyline points="14.5 6.5 18 3 21 3 21 6 17.5 9.5" /><line x1="5" y1="14" x2="9" y2="18" /><line x1="7" y1="17" x2="4" y2="20" /><line x1="2" y1="19" x2="4" y2="21" /></> } />;
        const Activity = (props) => <IconBase { ...props } d={ <><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></> } />;
        const Dna = (props) => <IconBase { ...props } d={ <><path d="M2 15c6.667-6 13.333 0 20-6" /><path d="M9 22c1.798-1.998 2.518-3.995 2.807-5.993" /><path d="M15 2c-1.798 1.998-2.518 3.995-2.807 5.993" /><path d="M17 12c-5.667 4-11.333-2-17 2" /></> } />;
        const Gem = (props) => <IconBase { ...props } d={ <><path d="M6 3h12l4 6-10 13L2 9z" /><path d="M11 3 8 9l4 13 4-13-3-6" /><path d="M2 9h20" /></> } />;
        const Flask = (props) => <IconBase { ...props } d={ <><path d="M10 2v7.31" /><path d="M14 2v7.31" /><path d="M8.5 2h7" /><path d="M14 9.3a6.5 6.5 0 1 1-4 0" /><path d="M5.52 16h12.96" /></> } />;
        const X = (props) => <IconBase { ...props } d={ <><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></> } />;
        const Droplet = (props) => <IconBase { ...props } d={ <><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z" /></> } />;
        const Zap = (props) => <IconBase { ...props } d={ <><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></> } />;
        const Wind = (props) => <IconBase { ...props } d={ <><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2" /></> } />;
        const Hammer = (props) => <IconBase { ...props } d={ <><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9" /><path d="M17.64 15 22 10.64" /><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25v-.86L16.01 4.6a5.56 5.56 0 0 0-3.94-1.64H11.2C10.43 2.96 9.25 3.32 8.7 4.1 8.21 4.8 8.44 5.8 9 6.45l2.42 2.42c.48.48.75 1.13.75 1.8v1.17c0 .85-.33 1.66-.93 2.26L10 15.34" /></> } />;
        const Sparkles = (props) => <IconBase { ...props } d={ <><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /><path d="M5 3v4" /><path d="M9 5H5" /><path d="M5 19v-4" /><path d="M9 19H5" /><path d="M19 5h-4" /><path d="M19 3v4" /><path d="M19 19h-4" /><path d="M19 15v4" /></> } />;
        const Copy = (props) => <IconBase { ...props } d={ <><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></> } />;

        // --- CONSTANTS & HELPERS ---
        // Collections are loaded from /api/collections/bestiary at startup.
        // See: tools/source_data/bestiary/manifest.json for the full list.

        // These remain inline as they map to React icon components (not serializable to JSON)
        const ATTACK_CATEGORY_ICONS = {
            "Piercing": Swords, "Slashing": Activity, "Blunt": Hammer,
            "Shredding": Wind, "Chemical": Droplet, "Energy": Zap
        };

        // Procedural expansion (runs once after collections load)
        function generateExpandedAttacks(baseAttacks, prefixes) {
            let expandedAttacks = {};
            // Base attacks first (with baseDamage as damage key)
            for (const [attackName, stats] of Object.entries(baseAttacks)) {
                expandedAttacks[attackName] = {
                    type: stats.type, effect: stats.effect,
                    damage: stats.baseDamage, anatomyTag: stats.anatomyTag
                };
            }
            // Prefixed variants
            for (const [attackName, stats] of Object.entries(baseAttacks)) {
                for (const [prefix, mods] of Object.entries(prefixes)) {
                    let [count, sides] = stats.baseDamage.split('d');
                    let newDamage = "0";
                    if (sides) {
                        let newCount = Math.max(1, parseInt(count) + mods.diceMod);
                        newDamage = `${newCount}d${sides}`;
                    }
                    expandedAttacks[`${prefix}${attackName}`] = {
                        type: stats.type, effect: stats.effect,
                        damage: newDamage, anatomyTag: stats.anatomyTag
                    };
                }
            }
            return expandedAttacks;
        }

        // Utility helpers (used before collections are destructured in BestiaryArchitect)
        const getCRColor = (cr) => {
            if (cr < 1) return "text-emerald-400 border-emerald-900/50 bg-emerald-900/20";
            if (cr <= 3) return "text-yellow-400 border-yellow-900/50 bg-yellow-900/20";
            if (cr <= 5) return "text-red-400 border-red-900/50 bg-red-900/20";
            return "text-purple-400 border-purple-900/50 bg-purple-900/20";
        };
        // --- LOADING WRAPPER ---
        function BestiaryApp() {
            const [collections, setCollections] = useState(null);
            const [savedData, setSavedData] = useState(null);
            const [loadError, setLoadError] = useState(null);

            useEffect(() => {
                // Connect heartbeat for auto-shutdown
                const heartbeat = new EventSource('/api/heartbeat');
                heartbeat.onerror = () => console.warn('[Heartbeat] Connection lost');

                const loadData = async () => {
                    try {
                        // 1. Load Manifest
                        const manifest = await fetch('./data/manifest.json').then(r => r.json());

                        // 2. Load all collections in parallel
                        const loadedCollections = {};
                        await Promise.all(Object.entries(manifest).map(async ([key, filename]) => {
                            loadedCollections[key] = await fetch(`./data/${filename}`).then(r => r.json());
                        }));

                        // Enrich attack categories with icon components
                        if (loadedCollections.attackCategories) {
                            for (const [key, val] of Object.entries(loadedCollections.attackCategories)) {
                                val.icon = ATTACK_CATEGORY_ICONS[key] || Swords;
                            }
                        }

                        // 3. Load saved user data
                        const saved = await fetch('/api/load/bestiary').then(r => r.json());

                        setCollections(loadedCollections);
                        setSavedData(saved);
                    } catch (err) {
                        console.error('Failed to load:', err);
                        setLoadError(err.message);
                    }
                };

                loadData();

                return () => heartbeat.close();
            }, []);



            if (loadError) return (
                <div className="flex items-center justify-center h-screen bg-slate-900 text-red-400">
                    <div className="text-center"><h1 className="text-2xl mb-2">Load Error</h1><p>{ loadError }</p></div>
                </div>
            );
            if (!collections) return (
                <div className="flex items-center justify-center h-screen bg-slate-900 text-slate-400">
                    <div className="text-center"><div className="animate-pulse text-2xl mb-2">⚙️</div><p>Loading collections...</p></div>
                </div>
            );

            return <BestiaryArchitect collections={ collections } savedData={ savedData } />;
        }

        // --- MAIN COMPONENT ---

        function BestiaryArchitect({ collections, savedData }) {
            // Destructure collections
            const {
                biomes: BIOMES, sizeIndices: SIZE_INDICES,
                attackCategories: ATTACK_CATEGORIES,
                harvestTypes: HARVEST_TYPES, anatomyParts: ANATOMY_PARTS,
                hardLootModifiers: HARD_LOOT_MODIFIERS, organicLootModifiers: ORGANIC_LOOT_MODIFIERS,
                baseAttacks: BASE_ATTACKS, prefixes: PREFIXES,
                realWorldData: REAL_WORLD_DATA,
                sizeAndAgeModifiers: SIZE_AND_AGE_MODIFIERS,
                conditionModifiers: CONDITION_MODIFIERS,
                biologicalUpgrades: BIOLOGICAL_UPGRADES,
                pigmentation: PIGMENTATION, patterns: PATTERNS,
                packMultipliers: PACK_MULTIPLIERS, maxPackLimits: MAX_PACK_LIMITS
            } = collections;

            const FULL_ATTACK_DATABASE = useMemo(
                () => generateExpandedAttacks(BASE_ATTACKS, PREFIXES),
                [BASE_ATTACKS, PREFIXES]
            );

            const getSizeName = (idx) => Object.keys(SIZE_INDICES).find(key => SIZE_INDICES[key] === idx) || "Medium";

            // --- SUB-COMPONENTS ---

            const CreatureDetailContent = ({ creature, hideHeader = false }) => {
                if (!creature) return null;

                // --- CALCULATIONS ---
                const breedingRate = (1.5 / (creature.cr + (creature.sizeIdx * 0.5))).toFixed(3);
                const metabolism = (creature.type === "Undead" || creature.type === "Construct") ? 0 : Math.pow(2, creature.sizeIdx - 4).toFixed(2);
                const meatYield = creature.sizeIdx * 5;
                const boneYield = creature.sizeIdx * 2;
                const hideType = creature.type === "Beast" ? (creature.sizeIdx > 4 ? "Thick Leather" : "Fur/Pelt") : "None";
                const crStyle = getCRColor(creature.cr);

                // Grouped Loot Table
                const groupedLoot = useMemo(() => {
                    const groups = {
                        "Skinning": [], "Butchering": [], "Extraction": [], "Sawing": [],
                        "Draining": [], "Plucking": [], "Scraping": [], "General": []
                    };

                    // 1. Inferred from Attacks (Direct Dictionary Lookup)
                    creature.attacks.forEach(atkName => {
                        const atkData = FULL_ATTACK_DATABASE[atkName];
                        if (atkData && atkData.anatomyTag) {
                            const anatomyInfo = ANATOMY_PARTS[atkData.anatomyTag];
                            if (anatomyInfo) {
                                const harvestMethod = anatomyInfo.defaultHarvest;
                                groups[harvestMethod].push({ source: atkData.anatomyTag, drops: anatomyInfo.baseDrops });
                            }
                        }
                    });

                    // 2. Base Carcass
                    groups["Butchering"].push({ source: "Carcass", drops: ["Raw Meat", "Animal Fat", "Bones"] });
                    if (hideType !== "None") groups["Skinning"].push({ source: "Carcass", drops: [hideType] });

                    // Clean empty groups
                    return Object.entries(groups).filter(([_, items]) => items.length > 0);
                }, [creature]);

                const packScenarios = [1, 2, 6, 10, 20].map(count => {
                    const mult = PACK_MULTIPLIERS.bounds.find(b => count <= b.maxCount)?.multiplier || 4.0;
                    const eCR = (creature.cr * count * mult).toFixed(1);
                    return { count, mult, eCR };
                });

                return (
                    <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 h-full">
                        {/* COL 1: COMBAT & STATS */ }
                        <div className="space-y-6">
                            <div className="bg-slate-800/50 p-4 rounded border border-slate-700">
                                <h3 className="text-xs uppercase font-bold text-slate-500 mb-4 flex items-center gap-2">
                                    <Shield className="w-4 h-4" /> Combat Stats
                                </h3>
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <div className="bg-slate-900 p-3 rounded text-center border border-slate-800">
                                        <div className="text-2xl font-bold text-red-400">{ creature.hp }</div>
                                        <div className="text-[10px] text-slate-500 uppercase">Hit Points</div>
                                    </div>
                                    <div className="bg-slate-900 p-3 rounded text-center border border-slate-800">
                                        <div className="text-2xl font-bold text-blue-400">{ creature.ac }</div>
                                        <div className="text-[10px] text-slate-500 uppercase">Armor Class</div>
                                    </div>
                                </div>
                                <h4 className="text-xs font-bold text-slate-400 mb-2 mt-6">Attack Registry</h4>
                                <div className="space-y-2">
                                    { creature.attacks.map(atk => {
                                        const details = FULL_ATTACK_DATABASE[atk];
                                        if (!details) return null;
                                        const CatIcon = ATTACK_CATEGORIES[details.type]?.icon || Swords;
                                        const catColor = ATTACK_CATEGORIES[details.type]?.color || 'text-white';
                                        return (
                                            <div key={ atk } className="flex justify-between items-center text-sm bg-slate-900 p-2 rounded border border-slate-800">
                                                <div className="flex items-center gap-2">
                                                    <CatIcon className={ `w-4 h-4 ${catColor}` } />
                                                    <span className="font-medium text-white">{ atk }</span>
                                                </div>
                                                <span className="text-xs text-slate-500 font-mono">{ details.damage }</span>
                                            </div>
                                        )
                                    }) }
                                </div>
                            </div>

                            <div className="bg-slate-800/50 p-4 rounded border border-slate-700">
                                <h3 className="text-xs uppercase font-bold text-slate-500 mb-4 flex items-center gap-2">
                                    <Activity className="w-4 h-4" /> Pack Threat Simulation
                                </h3>
                                <table className="w-full text-xs text-left">
                                    <thead className="text-slate-500 bg-slate-900/50">
                                        <tr>
                                            <th className="p-2">Count</th>
                                            <th className="p-2">Pack Mult</th>
                                            <th className="p-2 text-right">Effective CR</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-800">
                                        { packScenarios.map((s, i) => (
                                            <tr key={ i }>
                                                <td className="p-2 text-white">{ s.count } { s.count > 10 ? "(Horde)" : "" }</td>
                                                <td className="p-2 text-slate-400">x{ s.mult }</td>
                                                <td className="p-2 text-right font-mono font-bold text-orange-400">{ s.eCR }</td>
                                            </tr>
                                        )) }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* COL 2: MACRO & HARVEST */ }
                        <div className="space-y-6">
                            <div className="bg-slate-800/50 p-4 rounded border border-slate-700">
                                <h3 className="text-xs uppercase font-bold text-slate-500 mb-4 flex items-center gap-2">
                                    <Dna className="w-4 h-4" /> Biological Profile
                                </h3>
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center bg-slate-900 p-3 rounded border border-slate-800">
                                        <span className="text-xs text-slate-400">Size Class</span>
                                        <span className="text-sm font-bold text-emerald-400">{ getSizeName(creature.sizeIdx) } ({ creature.sizeIdx })</span>
                                    </div>
                                    <div>
                                        <div className="flex justify-between text-sm mb-1">
                                            <span className="text-slate-400">Breeding Rate</span>
                                            <span className="text-white font-mono">{ breedingRate } / yr</span>
                                        </div>
                                        <div className="w-full bg-slate-900 h-1.5 rounded-full overflow-hidden">
                                            <div className="bg-green-500 h-full" style={ { width: `${Math.min(100, breedingRate * 50)}%` } }></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div className="flex justify-between text-sm mb-1">
                                            <span className="text-slate-400">Metabolism Cost</span>
                                            <span className="text-white font-mono">{ metabolism } kcal/t</span>
                                        </div>
                                        <div className="w-full bg-slate-900 h-1.5 rounded-full overflow-hidden">
                                            <div className="bg-orange-500 h-full" style={ { width: `${Math.min(100, metabolism * 5)}%` } }></div>
                                        </div>
                                    </div>
                                    <div className="mt-4 bg-slate-900 p-2 rounded border border-slate-800">
                                        <div className="text-[10px] text-slate-500 mb-1">Biome Affinity</div>
                                        <div className="flex flex-wrap gap-1">
                                            { creature.biomes.map(b => (
                                                <span key={ b } className="text-[10px] bg-slate-800 text-slate-300 px-1.5 py-0.5 rounded">{ BIOMES[b]?.name }</span>
                                            )) }
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-slate-800/50 p-4 rounded border border-slate-700">
                                <h3 className="text-xs uppercase font-bold text-slate-500 mb-4 flex items-center gap-2">
                                    <Gem className="w-4 h-4" /> Resource Yields
                                </h3>
                                <div className="grid grid-cols-2 gap-3 text-center">
                                    <div className="bg-slate-900 p-3 rounded border border-slate-800">
                                        <div className="text-xl font-bold text-pink-400">{ meatYield } <span className="text-xs font-normal">lbs</span></div>
                                        <div className="text-[10px] text-slate-500 uppercase mt-1">Raw Meat</div>
                                    </div>
                                    <div className="bg-slate-900 p-3 rounded border border-slate-800">
                                        <div className="text-xl font-bold text-slate-200">{ boneYield } <span className="text-xs font-normal">lbs</span></div>
                                        <div className="text-[10px] text-slate-500 uppercase mt-1">Skeletal Mass</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* COL 3: LOOT TABLES */ }
                        <div className="bg-slate-800/50 p-4 rounded border border-slate-700 h-full flex flex-col">
                            <h3 className="text-xs uppercase font-bold text-slate-500 mb-4 flex items-center gap-2">
                                <Flask className="w-4 h-4" /> Inferred Loot Table
                            </h3>
                            <div className="space-y-4 overflow-y-auto flex-1 pr-2">
                                { groupedLoot.map(([method, items], i) => (
                                    <div key={ i } className="border border-slate-700 rounded overflow-hidden">
                                        <div className="bg-slate-900 px-3 py-2 border-b border-slate-700 flex justify-between items-center">
                                            <span className="text-xs font-bold text-emerald-400">Requires { method }</span>
                                            <span className="text-[10px] text-slate-500 flex items-center gap-1">
                                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></svg>
                                                { HARVEST_TYPES[method].baseTimeSeconds }s
                                            </span>
                                        </div>
                                        <div className="bg-slate-800/30 p-2 space-y-2">
                                            { items.map((item, j) => (
                                                <div key={ j } className="flex flex-col gap-1">
                                                    <span className="text-[10px] text-slate-500 ml-1">From: { item.source }</span>
                                                    <div className="flex flex-wrap gap-1">
                                                        { item.drops.map((drop, k) => (
                                                            <span key={ k } className="text-xs bg-slate-800 text-slate-300 px-2 py-1 rounded border border-slate-700 shadow-sm">
                                                                { drop }
                                                            </span>
                                                        )) }
                                                    </div>
                                                </div>
                                            )) }
                                        </div>
                                    </div>
                                )) }
                            </div>
                        </div>
                    </div>
                );
            }

            const CreatureDetailModal = ({ creature, onClose }) => {
                if (!creature) return null;
                const crStyle = getCRColor(creature.cr);

                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={ onClose }>
                        <div className="bg-slate-900 border border-slate-700 w-full max-w-5xl h-[90vh] overflow-hidden rounded-lg shadow-2xl flex flex-col" onClick={ e => e.stopPropagation() }>
                            {/* Header */ }
                            <div className="bg-slate-950 p-6 border-b border-slate-800 flex justify-between items-start sticky top-0 z-10">
                                <div>
                                    <h2 className="text-3xl font-bold text-white mb-1">{ creature.name }</h2>
                                    <div className="flex gap-2 text-sm">
                                        <span className={ `px-2 py-0.5 rounded border font-bold ${crStyle}` }>CR { creature.cr }</span>
                                        <span className="bg-slate-800 text-slate-400 px-2 py-0.5 rounded border border-slate-700">{ creature.type }</span>
                                        <span className="bg-emerald-900/50 text-emerald-300 px-2 py-0.5 rounded border border-emerald-800">Analog: { creature.base_template }</span>
                                    </div>
                                </div>
                                <button onClick={ onClose } className="p-2 bg-slate-800 hover:bg-slate-700 rounded text-slate-400 hover:text-white transition-colors">
                                    <X className="w-6 h-6" />
                                </button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-6">
                                <CreatureDetailContent creature={ creature } />
                            </div>
                        </div>
                    </div>
                );
            };

            const LootReferenceTab = () => (
                <div className="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-y-auto h-full bg-slate-900">
                    {/* COL 1: HARVESTING */ }
                    <div>
                        <h3 className="text-sm font-bold text-white mb-4 bg-slate-800 p-2 rounded flex items-center gap-2">
                            <svg className="w-4 h-4 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={ 2 } d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z" /></svg>
                            Harvest Methods
                        </h3>
                        <div className="space-y-2">
                            { Object.entries(HARVEST_TYPES).map(([key, val]) => (
                                <div key={ key } className="bg-slate-800/50 p-3 rounded border border-slate-700">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-sm font-bold text-emerald-400">{ key }</span>
                                        <span className="text-xs font-mono bg-slate-900 px-2 py-0.5 rounded border border-slate-700">{ val.baseTimeSeconds }s</span>
                                    </div>
                                    <div className="flex justify-between text-xs text-slate-400">
                                        <span>Requires: <span className="text-slate-200">{ val.toolNeeded }</span></span>
                                        <span>Check: <span className="text-slate-200">{ val.attribute }</span></span>
                                    </div>
                                </div>
                            )) }
                        </div>
                    </div>

                    {/* COL 2: MODIFIERS */ }
                    <div className="space-y-6">
                        <div>
                            <h3 className="text-sm font-bold text-white mb-4 bg-slate-800 p-2 rounded">Hard Loot Modifiers (Bone/Carapace)</h3>
                            <div className="space-y-1">
                                { Object.entries(HARD_LOOT_MODIFIERS).map(([key, val]) => (
                                    <div key={ key } className="flex justify-between items-center bg-slate-800/30 p-2 rounded border border-slate-700/50">
                                        <span className={ `text-sm font-medium ${val.valueMult < 1 ? 'text-red-400' : (val.valueMult > 2 ? 'text-purple-400' : 'text-blue-400')}` }>{ key }</span>
                                        <div className="text-xs text-slate-400 font-mono">
                                            x{ val.valueMult } Val
                                        </div>
                                    </div>
                                )) }
                            </div>
                        </div>
                        <div>
                            <h3 className="text-sm font-bold text-white mb-4 bg-slate-800 p-2 rounded">Organic Loot Modifiers (Meat/Glands)</h3>
                            <div className="space-y-1">
                                { Object.entries(ORGANIC_LOOT_MODIFIERS).map(([key, val]) => (
                                    <div key={ key } className="flex justify-between items-center bg-slate-800/30 p-2 rounded border border-slate-700/50">
                                        <span className={ `text-sm font-medium ${val.valueMult < 1 ? 'text-orange-400' : (val.valueMult > 2 ? 'text-pink-400' : 'text-emerald-400')}` }>{ key }</span>
                                        <div className="text-xs text-slate-400 font-mono">
                                            x{ val.valueMult } Val
                                        </div>
                                    </div>
                                )) }
                            </div>
                        </div>
                    </div>

                    {/* COL 3: ANATOMY */ }
                    <div>
                        <h3 className="text-sm font-bold text-white mb-4 bg-slate-800 p-2 rounded">Anatomy Parts Registry</h3>
                        <div className="space-y-2 overflow-y-auto max-h-[75vh] pr-2">
                            { Object.entries(ANATOMY_PARTS).map(([key, val]) => (
                                <div key={ key } className="bg-slate-800/50 p-3 rounded border border-slate-700">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-sm font-bold text-indigo-300">{ key }</span>
                                        <span className="text-[10px] uppercase bg-slate-900 px-1.5 py-0.5 rounded text-slate-400">{ val.defaultHarvest }</span>
                                    </div>
                                    <div className="flex flex-wrap gap-1">
                                        { val.baseDrops.map(drop => (
                                            <span key={ drop } className="text-xs bg-black/40 px-2 py-1 rounded text-slate-300 border border-slate-700">{ drop }</span>
                                        )) }
                                    </div>
                                </div>
                            )) }
                        </div>
                    </div>
                </div>
            );

            const ModifiersReferenceTab = () => (
                <div className="p-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 overflow-y-auto h-full bg-slate-900">
                    <div>
                        <h3 className="text-sm font-bold text-white mb-4 bg-slate-800 p-2 rounded">Age & Size Multipliers</h3>
                        { Object.entries(SIZE_AND_AGE_MODIFIERS).map(([key, val]) => (
                            <div key={ key } className="mb-2 bg-slate-800/50 p-2 rounded border border-slate-700 text-xs">
                                <div className="font-bold text-blue-300 flex justify-between">
                                    { key } <span className="text-slate-500">x{ val.crMult } CR</span>
                                </div>
                                <div className="grid grid-cols-2 gap-1 mt-1 text-slate-400">
                                    <span>HP: x{ val.hpMult }</span>
                                    <span>AC: { val.acMod > 0 ? '+' : '' }{ val.acMod }</span>
                                </div>
                            </div>
                        )) }
                    </div>
                    <div>
                        <h3 className="text-sm font-bold text-white mb-4 bg-slate-800 p-2 rounded">Conditions (State)</h3>
                        { Object.entries(CONDITION_MODIFIERS).map(([key, val]) => (
                            <div key={ key } className="mb-2 bg-slate-800/50 p-2 rounded border border-slate-700 text-xs">
                                <div className="font-bold text-orange-300 flex justify-between mb-1">
                                    { key } <span className="text-slate-500 font-mono">x{ val.crMult } CR</span>
                                </div>
                                <div className="text-slate-400 mb-1">AI: { val.behavior }</div>
                                { val.addedAttack && <div className="text-red-400">+ Atk: { val.addedAttack }</div> }
                            </div>
                        )) }
                    </div>
                    <div>
                        <h3 className="text-sm font-bold text-white mb-4 bg-slate-800 p-2 rounded">Biological Upgrades (Elite)</h3>
                        { Object.entries(BIOLOGICAL_UPGRADES).map(([key, val]) => (
                            <div key={ key } className="mb-2 bg-slate-800/50 p-2 rounded border border-slate-700 text-xs">
                                <div className="font-bold text-purple-300 flex justify-between mb-1">
                                    { key } <span className="text-slate-500 font-mono">x{ val.crMult } CR</span>
                                </div>
                                <div className="grid grid-cols-2 gap-1 mt-1 text-slate-400">
                                    <span>HP: x{ val.hpMult }</span>
                                    <span>AC: { val.acMod > 0 ? '+' : '' }{ val.acMod }</span>
                                </div>
                                { val.addedAttack && <div className="mt-1 text-red-400">+ Atk: { val.addedAttack }</div> }
                            </div>
                        )) }
                    </div>
                    <div>
                        <h3 className="text-sm font-bold text-white mb-4 bg-slate-800 p-2 rounded">Pigmentation (Stealth Mods)</h3>
                        { Object.entries(PIGMENTATION).map(([key, val]) => (
                            <div key={ key } className="mb-2 bg-slate-800/50 p-2 rounded border border-slate-700 text-xs">
                                <div className="font-bold text-emerald-300 flex justify-between mb-1">
                                    { key } <span className="text-slate-500">Stealth { val.stealthMod > 0 ? '+' : '' }{ val.stealthMod }</span>
                                </div>
                                <div className="text-slate-500 italic leading-tight">{ val.flavor }</div>
                            </div>
                        )) }
                        <h3 className="text-sm font-bold text-white mb-4 mt-6 bg-slate-800 p-2 rounded">Patterns</h3>
                        { Object.entries(PATTERNS).map(([key, val]) => (
                            <div key={ key } className="mb-2 bg-slate-800/50 p-2 rounded border border-slate-700 text-xs">
                                <div className="font-bold text-indigo-300 flex justify-between mb-1">
                                    { key } <span className="text-slate-500">Stealth { val.stealthMod > 0 ? '+' : '' }{ val.stealthMod }</span>
                                </div>
                                <div className="text-slate-500 italic leading-tight">{ val.flavor }</div>
                            </div>
                        )) }
                    </div>
                </div>
            );

            const ExperimentalTab = () => {
                const [currentEncounter, setCurrentEncounter] = useState(null);
                const [flavorText, setFlavorText] = useState("");
                const [imagePrompt, setImagePrompt] = useState("");
                const [apiKey, setApiKey] = useState("");
                const [generatedImage, setGeneratedImage] = useState(null);
                const [isGenerating, setIsGenerating] = useState(false);
                const [error, setError] = useState(null);

                const generateEncounter = () => {
                    // 1. Pick Base
                    const categories = Object.keys(REAL_WORLD_DATA);
                    const cat = categories[Math.floor(Math.random() * categories.length)];
                    const speciesKeys = Object.keys(REAL_WORLD_DATA[cat]);
                    const speciesKey = speciesKeys[Math.floor(Math.random() * speciesKeys.length)];
                    const base = REAL_WORLD_DATA[cat][speciesKey];

                    // 2. Pick Modifiers
                    const pick = (obj) => {
                        const keys = Object.keys(obj);
                        const k = keys[Math.floor(Math.random() * keys.length)];
                        return { key: k, ...obj[k] };
                    };

                    const age = pick(SIZE_AND_AGE_MODIFIERS);
                    const cond = pick(CONDITION_MODIFIERS);
                    const upg = pick(BIOLOGICAL_UPGRADES);
                    const pig = pick(PIGMENTATION);
                    const pat = pick(PATTERNS);

                    // 3. Compute Stats
                    const baseSizeIdx = SIZE_INDICES[base.size] || 4;
                    const newSizeIdx = Math.max(2, Math.min(16, baseSizeIdx + age.sizeStep));

                    const finalCR = parseFloat((base.cr * age.crMult * cond.crMult * upg.crMult).toFixed(2));
                    const finalHP = Math.floor(base.hp * age.hpMult * cond.hpMult * upg.hpMult);
                    const finalAC = base.ac + age.acMod + cond.acMod + upg.acMod;

                    // 4. Compute Attacks
                    let attacks = [...base.attacks];
                    [age.addedAttack, cond.addedAttack, upg.addedAttack].forEach(atk => {
                        if (atk && !attacks.includes(atk)) attacks.push(atk);
                    });

                    // 5. Construct Name
                    // Format: [Condition] [Pigmentation] [Pattern] [Age] [Upgrade] [Species]
                    // Filter out "Standard", "None", "Healthy" to avoid clutter names like "Healthy Standard None Wolf"
                    const parts = [];
                    if (cond.key !== "Healthy") parts.push(cond.key);
                    if (pig.key !== "Standard") parts.push(pig.key);
                    if (pat.key !== "None") parts.push(pat.key);
                    if (age.key !== "Standard") parts.push(age.key);
                    if (upg.key !== "None") parts.push(upg.key);
                    parts.push(speciesKey);
                    const fullName = parts.join(" ");

                    const encounter = {
                        id: crypto.randomUUID(),
                        name: fullName,
                        type: base.type,
                        sizeIdx: newSizeIdx,
                        cr: finalCR,
                        hp: finalHP,
                        ac: finalAC,
                        biomes: base.biomes,
                        attacks: attacks,
                        base_template: speciesKey,
                        // Store components for flavor text
                        components: { speciesKey, age, cond, upg, pig, pat }
                    };

                    setCurrentEncounter(encounter);
                    generateFlavor(encounter);
                    setGeneratedImage(null);
                    setError(null);
                };

                const generateFlavor = (enc) => {
                    const { speciesKey, age, cond, upg, pig, pat } = enc.components;
                    const sizeName = getSizeName(enc.sizeIdx);

                    let text = `A ${sizeName.toLowerCase()} ${speciesKey.toLowerCase()} dominates the view. `;
                    text += `Its hide is ${pig.key.toLowerCase()} (${pig.flavor.toLowerCase().replace('.', '')})`;
                    if (pat.key !== "None") {
                        text += `, broken by ${pat.key.toLowerCase()} markings (${pat.flavor.toLowerCase().replace('.', '')}).`;
                    } else {
                        text += ".";
                    }

                    text += ` The creature appears ${cond.key.toLowerCase()}, moving with ${cond.behavior.toLowerCase()} intent. `;

                    if (upg.key !== "None") {
                        text += `Distinctly, it shows signs of being ${upg.key.toLowerCase()}. `;
                    }

                    // Prompt generation logic
                    let prompt = `Fantasy concept art of a ${sizeName} ${speciesKey}, ${pig.key} color`;
                    if (pat.key !== "None") prompt += ` with ${pat.key} patterns`;
                    prompt += `. ${cond.key} condition, ${cond.behavior} stance.`;
                    if (upg.key !== "None") prompt += ` Features of ${upg.key} mutation.`;
                    prompt += ` Isometric RPG style, high definition, detailed texture, dark fantasy background.`;

                    setFlavorText(text);
                    setImagePrompt(prompt);
                };

                const handleImageGen = async () => {
                    if (!apiKey) {
                        setError("Please enter a valid Google Gemini API Key.");
                        return;
                    }
                    setIsGenerating(true);
                    setError(null);

                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                instances: [{ prompt: imagePrompt }],
                                parameters: { sampleCount: 1 }
                            })
                        });

                        const data = await response.json();

                        if (data.error) {
                            throw new Error(data.error.message || "API Error");
                        }

                        if (data.predictions && data.predictions[0]) {
                            const b64 = data.predictions[0].bytesBase64Encoded;
                            setGeneratedImage(`data:image/png;base64,${b64}`);
                        } else {
                            throw new Error("No image data returned.");
                        }

                    } catch (e) {
                        setError(e.message);
                    } finally {
                        setIsGenerating(false);
                    }
                };

                return (
                    <div className="flex flex-col h-full bg-slate-900">
                        {/* Top Bar - No Generate All */ }
                        <div className="p-6 border-b border-slate-800 bg-slate-950 flex justify-center">
                            <button
                                onClick={ generateEncounter }
                                className="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg shadow-indigo-900/50 flex items-center gap-3 transition-transform active:scale-95"
                            >
                                <Dna className="w-6 h-6" />
                                ENCOUNTER RANDOM ANOMALY
                            </button>
                        </div>

                        { !currentEncounter ? (
                            <div className="flex-1 flex items-center justify-center text-slate-600 flex-col gap-4">
                                <div className="w-16 h-16 rounded-full border-4 border-slate-800 border-t-indigo-600 animate-spin"></div>
                                <p>System Idle. Awaiting Generation...</p>
                            </div>
                        ) : (
                            <div className="flex-1 overflow-hidden flex">
                                {/* Left Panel: Visuals & Flavor */ }
                                <div className="w-1/3 border-r border-slate-800 p-6 overflow-y-auto flex flex-col gap-6">
                                    <div className="bg-slate-800/50 border border-slate-700 rounded-lg p-4">
                                        <h3 className="text-xs font-bold text-slate-400 uppercase mb-2">Visual Description</h3>
                                        <p className="text-sm text-slate-200 italic leading-relaxed">
                                            "{ flavorText }"
                                        </p>
                                        <div className="mt-4 flex gap-2">
                                            <button
                                                onClick={ () => navigator.clipboard.writeText(flavorText) }
                                                className="text-xs bg-slate-900 hover:bg-slate-800 text-slate-400 px-3 py-2 rounded border border-slate-700 flex items-center gap-2"
                                            >
                                                <Copy className="w-3 h-3" /> Copy Text
                                            </button>
                                            <button
                                                onClick={ () => navigator.clipboard.writeText(imagePrompt) }
                                                className="text-xs bg-slate-900 hover:bg-slate-800 text-slate-400 px-3 py-2 rounded border border-slate-700 flex items-center gap-2"
                                            >
                                                <Copy className="w-3 h-3" /> Copy Prompt
                                            </button>
                                        </div>
                                    </div>

                                    <div className="bg-black/40 border border-slate-700 rounded-lg aspect-square flex items-center justify-center overflow-hidden relative group">
                                        { generatedImage ? (
                                            <img src={ generatedImage } alt="Generated Creature" className="w-full h-full object-cover" />
                                        ) : (
                                            <div className="text-center p-6">
                                                { isGenerating ? (
                                                    <div className="flex flex-col items-center gap-3">
                                                        <div className="w-8 h-8 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                                                        <span className="text-xs text-indigo-400 animate-pulse">Generating Visualization...</span>
                                                    </div>
                                                ) : (
                                                    <>
                                                        <div className="text-slate-600 mb-2">No Visual Data</div>
                                                        <div className="text-[10px] text-slate-700">Use API below to render</div>
                                                    </>
                                                ) }
                                            </div>
                                        ) }
                                    </div>

                                    <div className="bg-slate-800/30 border border-slate-700/50 rounded p-4">
                                        <h3 className="text-xs font-bold text-slate-500 uppercase mb-3">Google Imagen (Optional)</h3>
                                        <input
                                            type="password"
                                            placeholder="Paste Gemini API Key Here"
                                            value={ apiKey }
                                            onChange={ (e) => setApiKey(e.target.value) }
                                            className="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-xs text-white mb-3 focus:border-indigo-500 outline-none"
                                        />
                                        { error && <div className="text-xs text-red-400 mb-3">{ error }</div> }
                                        <button
                                            onClick={ handleImageGen }
                                            disabled={ isGenerating || !apiKey }
                                            className="w-full bg-emerald-700 hover:bg-emerald-600 disabled:bg-slate-800 disabled:text-slate-600 text-white text-xs font-bold py-2 rounded transition-colors flex justify-center items-center gap-2"
                                        >
                                            <Sparkles className="w-3 h-3" /> Generate Image
                                        </button>
                                    </div>
                                </div>

                                {/* Right Panel: The Dossier (Reusing Logic) */ }
                                <div className="w-2/3 overflow-y-auto p-6 bg-slate-900">
                                    <h2 className="text-3xl font-bold text-white mb-1">{ currentEncounter.name }</h2>
                                    <div className="flex gap-2 text-sm mb-6">
                                        <span className={ `px-2 py-0.5 rounded border font-bold ${getCRColor(currentEncounter.cr)}` }>CR { currentEncounter.cr }</span>
                                        <span className="bg-slate-800 text-slate-400 px-2 py-0.5 rounded border border-slate-700">{ currentEncounter.type }</span>
                                    </div>
                                    <CreatureDetailContent creature={ currentEncounter } />
                                </div>
                            </div>
                        ) }
                    </div>
                );
            };



            const [library, setLibrary] = useState(savedData?.creatures || []);
            const [useVariants, setUseVariants] = useState(true);
            const [activeTab, setActiveTab] = useState("creatures");
            const [selectedCreature, setSelectedCreature] = useState(null);
            const [saveStatus, setSaveStatus] = useState(null);

            const bulkImportAll = () => {
                let allCreatures = [];
                Object.keys(REAL_WORLD_DATA).forEach(category => {
                    Object.keys(REAL_WORLD_DATA[category]).forEach(name => {
                        const tmpl = REAL_WORLD_DATA[category][name];
                        const baseSizeIdx = SIZE_INDICES[tmpl.size] || 4;

                        const variantsToGen = useVariants ? Object.entries(SIZE_AND_AGE_MODIFIERS) : [["Standard", SIZE_AND_AGE_MODIFIERS["Standard"]]];

                        variantsToGen.forEach(([variantName, mod]) => {
                            let newSizeIdx = Math.max(2, Math.min(16, baseSizeIdx + mod.sizeStep));
                            let finalName = variantName === "Standard" ? name : `${variantName} ${name}`;
                            let newHP = Math.floor(tmpl.hp * mod.hpMult);
                            let newCR = parseFloat((tmpl.cr * mod.crMult).toFixed(2));
                            let newAC = tmpl.ac + mod.acMod;
                            let newAttacks = [...tmpl.attacks];
                            if (mod.addedAttack && !newAttacks.includes(mod.addedAttack)) newAttacks.push(mod.addedAttack);

                            allCreatures.push({
                                id: crypto.randomUUID(),
                                name: finalName,
                                type: tmpl.type,
                                sizeIdx: newSizeIdx,
                                cr: newCR,
                                hp: newHP,
                                ac: newAC,
                                biomes: tmpl.biomes,
                                attacks: newAttacks,
                                base_template: name
                            });
                        });
                    });
                });
                setLibrary(allCreatures);
            };

            const generateRandom = () => {
                // Keep this for the "+" button in Registry tab
                const categories = Object.keys(REAL_WORLD_DATA);
                const randomCat = categories[Math.floor(Math.random() * categories.length)];
                const templates = Object.keys(REAL_WORLD_DATA[randomCat]);
                const randomName = templates[Math.floor(Math.random() * templates.length)];
                const tmpl = REAL_WORLD_DATA[randomCat][randomName];

                const variants = Object.entries(SIZE_AND_AGE_MODIFIERS);
                const [variantName, mod] = variants[Math.floor(Math.random() * variants.length)];

                const baseSizeIdx = SIZE_INDICES[tmpl.size] || 4;
                let newSizeIdx = Math.max(2, Math.min(16, baseSizeIdx + mod.sizeStep));
                let finalName = variantName === "Standard" ? randomName : `${variantName} ${randomName}`;

                let newAttacks = [...tmpl.attacks];
                if (mod.addedAttack && !newAttacks.includes(mod.addedAttack)) newAttacks.push(mod.addedAttack);

                setLibrary(prev => [...prev, {
                    id: crypto.randomUUID(),
                    name: finalName,
                    type: tmpl.type,
                    sizeIdx: newSizeIdx,
                    cr: parseFloat((tmpl.cr * mod.crMult).toFixed(2)),
                    hp: Math.floor(tmpl.hp * mod.hpMult),
                    ac: tmpl.ac + mod.acMod,
                    biomes: tmpl.biomes,
                    attacks: newAttacks,
                    base_template: randomName
                }]);
            };

            const generateSQL = () => {
                let sql = `-- Project Epoch Database Export\n`;
                sql += `-- Generated: ${new Date().toISOString()}\n`;
                sql += `-- Creatures: ${library.length} | Attacks: ${Object.keys(FULL_ATTACK_DATABASE).length}\n\n`;

                sql += `PRAGMA foreign_keys = ON;\n\n`;

                sql += `-- [1] HARVEST TYPES\n`;
                sql += `CREATE TABLE IF NOT EXISTS Harvest_Types (id TEXT PRIMARY KEY, tool TEXT, attribute TEXT, speed TEXT, time_sec INTEGER);\n`;
                Object.entries(HARVEST_TYPES).forEach(([k, v]) => {
                    sql += `INSERT OR IGNORE INTO Harvest_Types VALUES ('${k}', '${v.toolNeeded}', '${v.attribute}', '${v.speed}', ${v.baseTimeSeconds});\n`;
                });
                sql += `\n`;

                sql += `-- [2] ANATOMY PARTS\n`;
                sql += `CREATE TABLE IF NOT EXISTS Anatomy_Parts (id TEXT PRIMARY KEY, default_harvest TEXT, drops TEXT);\n`;
                Object.entries(ANATOMY_PARTS).forEach(([k, v]) => {
                    sql += `INSERT OR IGNORE INTO Anatomy_Parts VALUES ('${k}', '${v.defaultHarvest}', '${v.baseDrops.join(",")}');\n`;
                });
                sql += `\n`;

                sql += `-- [3] LOOT MODIFIERS\n`;
                sql += `CREATE TABLE IF NOT EXISTS Loot_Modifiers (id TEXT PRIMARY KEY, type TEXT, multiplier REAL, quality TEXT, weight INTEGER);\n`;
                Object.entries(HARD_LOOT_MODIFIERS).forEach(([k, v]) => {
                    sql += `INSERT OR IGNORE INTO Loot_Modifiers VALUES ('${k}', 'HARD', ${v.valueMult}, '${v.craftQuality}', ${v.dropWeight});\n`;
                });
                Object.entries(ORGANIC_LOOT_MODIFIERS).forEach(([k, v]) => {
                    sql += `INSERT OR IGNORE INTO Loot_Modifiers VALUES ('${k}', 'ORGANIC', ${v.valueMult}, '${v.craftQuality}', ${v.dropWeight});\n`;
                });
                sql += `\n`;

                sql += `-- [4] ATTACK DEFINITIONS\n`;
                sql += `CREATE TABLE IF NOT EXISTS Attack_Defs (\n`;
                sql += `  id INTEGER PRIMARY KEY AUTOINCREMENT,\n`;
                sql += `  name TEXT UNIQUE,\n`;
                sql += `  category TEXT,\n`;
                sql += `  effect TEXT,\n`;
                sql += `  base_damage TEXT,\n`;
                sql += `  anatomy_tag TEXT\n`;
                sql += `);\n\n`;

                sql += `BEGIN TRANSACTION;\n`;
                Object.entries(FULL_ATTACK_DATABASE).forEach(([name, data]) => {
                    sql += `INSERT OR IGNORE INTO Attack_Defs (name, category, effect, base_damage, anatomy_tag) VALUES ('${name}', '${data.type}', '${data.effect}', '${data.damage}', '${data.anatomyTag}');\n`;
                });
                sql += `COMMIT;\n\n`;

                sql += `-- [5] CREATURE GENETICS\n`;
                sql += `CREATE TABLE IF NOT EXISTS Creature_Defs (\n`;
                sql += `  id TEXT PRIMARY KEY,\n`;
                sql += `  name TEXT,\n`;
                sql += `  type TEXT,\n`;
                sql += `  size_index INTEGER,\n`;
                sql += `  cr REAL,\n`;
                sql += `  hp INTEGER,\n`;
                sql += `  ac INTEGER,\n`;
                sql += `  biomes_json TEXT\n`;
                sql += `);\n\n`;

                sql += `-- [6] CREATURE <-> ATTACK LINK\n`;
                sql += `CREATE TABLE IF NOT EXISTS Creature_Attacks (\n`;
                sql += `  creature_id TEXT,\n`;
                sql += `  attack_name TEXT,\n`;
                sql += `  FOREIGN KEY(creature_id) REFERENCES Creature_Defs(id),\n`;
                sql += `  FOREIGN KEY(attack_name) REFERENCES Attack_Defs(name)\n`;
                sql += `);\n\n`;

                sql += `BEGIN TRANSACTION;\n`;
                library.forEach(c => {
                    sql += `INSERT INTO Creature_Defs (id, name, type, size_index, cr, hp, ac, biomes_json) VALUES ('${c.id}', '${c.name.replace(/'/g, "''")}', '${c.type}', ${c.sizeIdx}, ${c.cr}, ${c.hp}, ${c.ac}, '${JSON.stringify(c.biomes)}');\n`;
                    c.attacks.forEach(atk => {
                        sql += `INSERT INTO Creature_Attacks (creature_id, attack_name) VALUES ('${c.id}', '${atk}');\n`;
                    });
                });
                sql += `COMMIT;\n`;

                return sql;
            };

            const saveToServer = async () => {
                setSaveStatus('saving');
                try {
                    const response = await fetch('/api/save/bestiary', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ creatures: library, version: 1 })
                    });
                    const result = await response.json();
                    if (result.success) {
                        setSaveStatus('saved');
                        setTimeout(() => setSaveStatus(null), 3000);
                        console.log('[SAVE] Exported:', result.exports);
                    } else {
                        setSaveStatus('error');
                        console.error('[SAVE] Failed:', result.error);
                    }
                } catch (err) {
                    setSaveStatus('error');
                    console.error('[SAVE] Error:', err);
                }
            };

            return (
                <div className="flex flex-col h-screen bg-slate-900 text-slate-100 font-sans">
                    <header className="bg-slate-950 p-4 border-b border-slate-700 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <Database className="w-6 h-6 text-emerald-400" />
                            <h1 className="text-xl font-bold tracking-wide">EPOCH <span className="text-slate-500 font-light">BESTIARY ARCHITECT V3</span></h1>
                        </div>
                        { activeTab !== 'experimental' && (
                            <div className="flex items-center gap-4">
                                <button
                                    onClick={ generateRandom }
                                    className="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-200 px-3 py-2 rounded text-sm font-medium transition-colors border border-slate-600"
                                >
                                    <Dna className="w-4 h-4 text-purple-400" /> Add Random
                                </button>
                                <div className="flex items-center gap-2 bg-slate-900 border border-slate-700 rounded px-3 py-1">
                                    <input
                                        type="checkbox"
                                        checked={ useVariants }
                                        onChange={ (e) => setUseVariants(e.target.checked) }
                                        className="accent-indigo-500"
                                    />
                                    <label className="text-xs text-slate-400">Gen Variants (x8)</label>
                                </div>
                                <button
                                    onClick={ bulkImportAll }
                                    className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded text-sm font-medium transition-colors"
                                >
                                    <Globe className="w-4 h-4" /> Generate All
                                </button>
                                <button
                                    onClick={ saveToServer }
                                    disabled={ saveStatus === 'saving' }
                                    className={ `flex items-center gap-2 px-4 py-2 rounded text-sm font-medium transition-colors ${saveStatus === 'saved' ? 'bg-green-700 text-green-100' :
                                        saveStatus === 'error' ? 'bg-red-700 text-red-100' :
                                            saveStatus === 'saving' ? 'bg-yellow-700 text-yellow-100 animate-pulse' :
                                                'bg-emerald-600 hover:bg-emerald-500 text-white'
                                        }` }
                                >
                                    <Save className="w-4 h-4" /> { saveStatus === 'saving' ? 'Saving...' : saveStatus === 'saved' ? '✓ Saved!' : saveStatus === 'error' ? '✗ Error' : 'Export DB' }
                                </button>
                            </div>
                        ) }
                    </header>

                    <div className="flex flex-1 overflow-hidden">
                        {/* SIDEBAR */ }
                        <div className="w-16 bg-slate-950 border-r border-slate-800 flex flex-col items-center py-4 gap-4">
                            <button onClick={ () => setActiveTab('creatures') } className={ `p-2 rounded group relative ${activeTab === 'creatures' ? 'bg-indigo-600 text-white' : 'text-slate-500 hover:text-slate-300'}` }>
                                <Activity className="w-6 h-6" />
                                <span className="absolute left-14 bg-slate-800 text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-50">Creatures</span>
                            </button>
                            <button onClick={ () => setActiveTab('attacks') } className={ `p-2 rounded group relative ${activeTab === 'attacks' ? 'bg-indigo-600 text-white' : 'text-slate-500 hover:text-slate-300'}` }>
                                <Swords className="w-6 h-6" />
                                <span className="absolute left-14 bg-slate-800 text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-50">Attacks</span>
                            </button>
                            <button onClick={ () => setActiveTab('loot') } className={ `p-2 rounded group relative ${activeTab === 'loot' ? 'bg-indigo-600 text-white' : 'text-slate-500 hover:text-slate-300'}` }>
                                <Gem className="w-6 h-6" />
                                <span className="absolute left-14 bg-slate-800 text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-50">Loot & Anatomy</span>
                            </button>
                            <button onClick={ () => setActiveTab('modifiers') } className={ `p-2 rounded group relative ${activeTab === 'modifiers' ? 'bg-indigo-600 text-white' : 'text-slate-500 hover:text-slate-300'}` }>
                                <Flask className="w-6 h-6" />
                                <span className="absolute left-14 bg-slate-800 text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-50">Modifiers</span>
                            </button>
                            <div className="flex-1"></div>
                            <button onClick={ () => setActiveTab('experimental') } className={ `p-2 rounded group relative ${activeTab === 'experimental' ? 'bg-indigo-600 text-white animate-pulse-slow' : 'text-slate-500 hover:text-slate-300'}` }>
                                <Sparkles className="w-6 h-6" />
                                <span className="absolute left-14 bg-slate-800 text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-50">Experimental</span>
                            </button>
                        </div>

                        {/* CONTENT */ }
                        <div className="flex-1 flex overflow-hidden relative">
                            { activeTab === 'creatures' && (
                                <div className="flex-1 p-6 overflow-y-auto">
                                    <div className="flex justify-between items-end mb-4 border-b border-slate-800 pb-2">
                                        <div>
                                            <h2 className="text-lg font-bold text-white">Creature Registry</h2>
                                            <p className="text-xs text-slate-500">
                                                { library.length > 0 ? `${library.length} entities generated ready for export.` : "Registry is empty. Click 'Generate All' to populate." }
                                            </p>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                                        { library.map((c, idx) => {
                                            const crStyle = getCRColor(c.cr);
                                            return (
                                                <div
                                                    key={ idx }
                                                    onClick={ () => setSelectedCreature(c) }
                                                    className="bg-slate-800 p-3 rounded border border-slate-700 text-sm hover:border-indigo-500 transition-colors cursor-pointer group"
                                                >
                                                    <div className="flex justify-between items-start mb-2">
                                                        <span className="font-bold text-white group-hover:text-indigo-300 transition-colors">{ c.name }</span>
                                                        <span className={ `text-[10px] px-1.5 py-0.5 rounded font-bold border ${crStyle}` }>CR { c.cr }</span>
                                                    </div>
                                                    <div className="flex gap-2 text-xs text-slate-500 mb-2">
                                                        <span>{ getSizeName(c.sizeIdx) }</span>
                                                        <span>•</span>
                                                        <span>HP { c.hp }</span>
                                                        <span>•</span>
                                                        <span>AC { c.ac }</span>
                                                    </div>
                                                    <div className="flex flex-wrap gap-1">
                                                        { c.attacks.slice(0, 3).map(atk => {
                                                            const details = FULL_ATTACK_DATABASE[atk];
                                                            const CatIcon = details ? ATTACK_CATEGORIES[details.type]?.icon || Swords : Swords;
                                                            return (
                                                                <span key={ atk } className="flex items-center gap-1 text-[10px] bg-slate-900 text-slate-300 px-1.5 py-0.5 rounded border border-slate-700">
                                                                    <CatIcon className="w-3 h-3 text-slate-500" /> { atk }
                                                                </span>
                                                            )
                                                        }) }
                                                        { c.attacks.length > 3 && <span className="text-[10px] text-slate-500 bg-slate-900 px-1.5 py-0.5 rounded">+{ c.attacks.length - 3 }</span> }
                                                    </div>
                                                </div>
                                            )
                                        }) }
                                        { library.length === 0 && (
                                            <div className="col-span-full h-64 flex items-center justify-center text-slate-600 border border-dashed border-slate-700 rounded-lg">
                                                No Creatures Generated
                                            </div>
                                        ) }
                                    </div>
                                </div>
                            ) }

                            { activeTab === 'attacks' && (
                                <div className="flex-1 p-6 overflow-y-auto bg-slate-900">
                                    <h2 className="text-lg font-bold text-white mb-6">Attack Definitions (Runtime Database)</h2>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div className="bg-slate-800 p-4 rounded border border-slate-700 h-fit sticky top-0">
                                            <h3 className="text-xs uppercase font-bold text-slate-500 mb-4">Damage Categories</h3>
                                            <div className="space-y-3">
                                                { Object.entries(ATTACK_CATEGORIES).map(([cat, info]) => {
                                                    const CatIcon = info.icon;
                                                    return (
                                                        <div key={ cat } className="flex items-center gap-3 bg-slate-900 p-2 rounded">
                                                            <CatIcon className={ `w-5 h-5 ${info.color}` } />
                                                            <span className={ `w-20 text-sm font-bold ${info.color}` }>{ cat }</span>
                                                            <span className="text-xs text-slate-400">{ info.desc }</span>
                                                        </div>
                                                    )
                                                }) }
                                            </div>
                                        </div>
                                        <div className="space-y-2">
                                            <h3 className="text-xs uppercase font-bold text-slate-500 mb-2">Registered Attacks ({ Object.keys(FULL_ATTACK_DATABASE).length })</h3>
                                            { Object.entries(FULL_ATTACK_DATABASE).map(([name, data]) => {
                                                const CatIcon = ATTACK_CATEGORIES[data.type]?.icon || Swords;
                                                return (
                                                    <div key={ name } className="flex items-center justify-between bg-slate-800 p-3 rounded border border-slate-700">
                                                        <div className="flex items-center gap-3">
                                                            <div className="bg-slate-900 p-2 rounded">
                                                                <CatIcon className={ `w-4 h-4 ${ATTACK_CATEGORIES[data.type]?.color || 'text-white'}` } />
                                                            </div>
                                                            <div>
                                                                <div className="font-bold text-sm text-slate-200">{ name }</div>
                                                                <div className="text-xs text-slate-500">{ data.type } { data.effect !== 'None' ? `• ${data.effect}` : '' }</div>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="font-mono text-sm text-slate-400 bg-slate-950 px-2 py-1 rounded mb-1 border border-slate-800">
                                                                { data.damage }
                                                            </div>
                                                            <div className="text-[10px] text-indigo-400">{ data.anatomyTag }</div>
                                                        </div>
                                                    </div>
                                                )
                                            }) }
                                        </div>
                                    </div>
                                </div>
                            ) }

                            { activeTab === 'loot' && <LootReferenceTab /> }
                            { activeTab === 'modifiers' && <ModifiersReferenceTab /> }
                            { activeTab === 'experimental' && <ExperimentalTab /> }

                            {/* DETAIL MODAL */ }
                            <CreatureDetailModal creature={ selectedCreature } onClose={ () => setSelectedCreature(null) } />
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BestiaryApp />);
    </script>
</body>

</html>