<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Epoch: UI Architect</title>

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Load Babel for JSX support in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            color: #d4d4d4;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #171717;
        }

        ::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #525252;
        }

        input[type="color"] {
            -webkit-appearance: none;
            appearance: none;
            border: none;
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        /* --- Custom Fonts --- */
        @font-face {
            font-family: 'Kenney Pixel';
            src: url('../assets/fonts/kenney_kenney-fonts/Fonts/Kenney Pixel.ttf') format('truetype');
        }

        .grid-bg {
            background-image: linear-gradient(to right, #262626 1px, transparent 1px), linear-gradient(to bottom, #262626 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const Icon = ({ name, ...p }) => {
            const icons = {
                Terminal: <polyline points="4 17 10 11 4 5"></polyline>,
                Copy: <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>,
                Upload: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>, // Upload/Import base
                UploadArrow: <polyline points="17 8 12 3 7 8"></polyline>, // Upload arrow
                Trash: <polyline points="3 6 5 6 21 6"></polyline>,
                Settings: <circle cx="12" cy="12" r="3"></circle>,
                MousePointer: <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"></path>,
                Type: <polyline points="4 7 4 4 20 4 20 7"></polyline>,
                Box: <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>,
                CheckSquare: <polyline points="9 11 12 14 22 4"></polyline>,
                Sliders: <line x1="4" y1="21" x2="4" y2="14"></line>,
                Maximize: <path d="M15 3h6v6"></path>,
                Layout: <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>,
                Minus: <line x1="5" y1="12" x2="19" y2="12"></line>,
                Image: <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect> // Placeholder for Image icon
            };

            if (name === 'Image') {
                return (
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" { ...p }>
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                );
            }

            // Composition for Upload icon since we're using simple SVG paths
            if (name === 'Upload') {
                return (
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" { ...p }>
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                );
            }

            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" { ...p }>
                    { icons[name] || <circle cx="12" cy="12" r="10" /> }
                </svg>
            );
        };

        // --- Constants ---
        // SCENES removed in favor of dynamic keys from sceneData

        const WIDGET_TYPES = {
            CONTAINER: { label: 'Container', icon: 'Box', defaultH: 100, defaultW: 100, defaultProps: { layoutMode: 'free', bgImage: '' } },
            BUTTON: { label: 'Button', icon: 'MousePointer', defaultH: 40, defaultW: 120, defaultProps: { text: "Click Me", actionId: "BTN_ACTION", bgImage: '' } },
            LABEL: { label: 'Text Label', icon: 'Type', defaultH: 30, defaultW: 150, defaultProps: { text: "Label Text", fontSize: 14, align: "left" } },
            IMAGE: { label: 'Image', icon: 'Image', defaultH: 100, defaultW: 100, defaultProps: { image: 'assets/ui/placeholder.png' } },
            INPUT_TEXT: { label: 'Input Field', icon: 'Terminal', defaultH: 30, defaultW: 200, defaultProps: { placeholder: "Enter text...", text: "" } },
            SLIDER: { label: 'Slider', icon: 'Sliders', defaultH: 30, defaultW: 200, defaultProps: { min: 0, max: 100, value: 50 } },
            CHECKBOX: { label: 'Checkbox', icon: 'CheckSquare', defaultH: 30, defaultW: 30, defaultProps: { checked: false, label: "Option" } },
        };

        function App() {
            // --- State ---
            const [settings, setSettings] = useState({ width: 1024, height: 768 });
            const [currentScene, setCurrentScene] = useState('main_menu');
            const fileInputRef = useRef(null);

            // --- Data Sanitizer ---
            // Converts JSON export format (geometry/properties) to internal state format
            // and guarantees defaults for style and props on every widget.
            const sanitizeSceneData = (rawScenes) => {
                const sanitized = {};
                Object.keys(rawScenes).forEach(sceneName => {
                    sanitized[sceneName] = (rawScenes[sceneName] || []).map(w => ({
                        id: w.id,
                        type: w.type,
                        parentId: w.parentId,
                        // Support both flat (x/y/w/h) and nested (geometry) formats
                        x: w.x ?? w.geometry?.x ?? 0,
                        y: w.y ?? w.geometry?.y ?? 0,
                        w: w.w ?? w.geometry?.w ?? 100,
                        h: w.h ?? w.geometry?.h ?? 100,
                        // Ensure style always exists with safe defaults
                        style: {
                            bg: '#262626',
                            border: '#525252',
                            color: '#e5e5e5',
                            ...(w.style || {})
                        },
                        // Support both 'props' and 'properties', ensure always exists
                        props: {
                            ...(w.props || w.properties || {})
                        }
                    }));
                });
                return sanitized;
            };

            // --- Server Integration ---
            useEffect(() => {
                // Heartbeat
                const hb = new EventSource('/api/heartbeat');
                hb.onerror = () => console.warn('Heartbeat lost');

                // Load Data
                fetch('/api/load/ui')
                    .then(r => r.json())
                    .then(data => {
                        if (data && data.scenes && Object.keys(data.scenes).length > 0) {
                            console.log("Loaded UI data from server", data);
                            setSettings(data.settings || { width: 1024, height: 768 });
                            setSceneData(sanitizeSceneData(data.scenes));
                            // Ensure current scene is valid
                            const initialScene = Object.keys(data.scenes)[0] || 'main_menu';
                            setCurrentScene(initialScene);
                        } else {
                            console.log("No saved data found, using defaults.");
                        }
                    })
                    .catch(err => console.error("Failed to load UI data", err));

                return () => hb.close();
            }, []);

            const saveToServer = async () => {
                const data = JSON.parse(generateJSON());
                try {
                    const res = await fetch('/api/save/ui', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await res.json();
                    if (result.success) {
                        alert("Saved to server!");
                    } else {
                        alert("Save failed: " + result.error);
                    }
                } catch (e) {
                    console.error(e);
                    alert("Save failed (network error)");
                }
            };

            // Centralized Data Store
            const [sceneData, setSceneData] = useState({
                main_menu: [
                    { id: 'mm_bg_panel', type: 'CONTAINER', x: 262, y: 100, w: 500, h: 568, style: { bg: '#171717', border: '#404040' }, props: { layoutMode: 'free' } },
                    { id: 'mm_lbl_title', type: 'LABEL', x: 362, y: 130, w: 300, h: 40, style: { color: '#ffffff' }, props: { text: "PROJECT EPOCH", fontSize: 32, align: "center" } },

                    // Action Buttons
                    { id: 'btn_start', type: 'BUTTON', x: 412, y: 200, w: 200, h: 40, style: { bg: '#059669', color: '#ffffff' }, props: { text: "Start Game", actionId: "START_GAME" } },
                    { id: 'btn_gen_world', type: 'BUTTON', x: 412, y: 250, w: 200, h: 40, style: { bg: '#0284c7', color: '#ffffff' }, props: { text: "Generate World", actionId: "GEN_WORLD" } },

                    // World List Section
                    { id: 'world_list_container', type: 'CONTAINER', x: 312, y: 320, w: 400, h: 300, style: { bg: '#0a0a0a', border: '#262626' }, props: { layoutMode: 'vertical', scroll: true } },
                    { id: 'lbl_worlds_header', type: 'LABEL', x: 332, y: 330, w: 100, h: 20, style: { color: '#737373' }, props: { text: "SAVED WORLDS", fontSize: 10, align: "left" } },

                ],

                popups: [
                    // Backdrop (The host for popups)
                    { id: 'popup_backdrop', type: 'CONTAINER', x: 0, y: 0, w: 1024, h: 768, style: { bg: '#000000cc', border: 'transparent' }, props: { layoutMode: 'free', prefabHostId: 'MODAL_TEMPLATE' } },
                ],

                prefabs: [
                    // World List Item Template
                    { id: 'tpl_world_item', type: 'CONTAINER', x: 50, y: 50, w: 380, h: 50, style: { bg: '#262626', border: '#404040' }, props: { layoutMode: 'horizontal', prefabId: 'WORLD_ITEM_TEMPLATE' } },
                    { id: 'tpl_lbl_name', type: 'LABEL', x: 60, y: 65, w: 200, h: 20, style: { color: '#e5e5e5' }, props: { text: "{WorldName}", fontSize: 12, align: "left" } },
                    { id: 'tpl_btn_del', type: 'BUTTON', x: 350, y: 60, w: 70, h: 30, style: { bg: '#9f1239', color: '#ffffff' }, props: { text: "DELETE", actionId: "DEL_WORLD" } },

                    // Generic Confirmation Modal Template
                    { id: 'tpl_modal_window', type: 'CONTAINER', x: 500, y: 50, w: 400, h: 200, style: { bg: '#171717', border: '#525252' }, props: { layoutMode: 'vertical', prefabId: 'MODAL_TEMPLATE' } },
                    { id: 'tpl_modal_title', type: 'LABEL', x: 520, y: 70, w: 360, h: 30, style: { color: '#ffffff' }, props: { text: "CONFIRMATION", fontSize: 16, align: "center" } },
                    { id: 'tpl_modal_desc', type: 'LABEL', x: 520, y: 110, w: 360, h: 60, style: { color: '#a3a3a3' }, props: { text: "Are you sure you want to perform this action?", fontSize: 12, align: "center" } },

                    { id: 'tpl_modal_btn_row', type: 'CONTAINER', x: 520, y: 190, w: 360, h: 40, style: { bg: 'transparent', border: 'transparent' }, props: { layoutMode: 'horizontal' } },
                    { id: 'tpl_btn_confirm', type: 'BUTTON', x: 520, y: 190, w: 170, h: 40, style: { bg: '#059669', color: '#ffffff' }, props: { text: "CONFIRM", actionId: "MODAL_CONFIRM" } },
                    { id: 'tpl_btn_cancel', type: 'BUTTON', x: 710, y: 190, w: 170, h: 40, style: { bg: '#404040', color: '#ffffff' }, props: { text: "CANCEL", actionId: "MODAL_CANCEL" } },
                ],

                gameplay: [
                    // Top HUD Area
                    { id: 'hud_top_bar', type: 'CONTAINER', x: 10, y: 10, w: 600, h: 60, style: { bg: 'transparent', border: 'transparent' }, props: { layoutMode: 'horizontal' } },

                    // Hotbar Slots (Terraria style)
                    ...Array.from({ length: 10 }).map((_, i) => ({
                        id: `hotbar_slot_${i}`,
                        type: 'CONTAINER',
                        x: 10 + (i * 44),
                        y: 10,
                        w: 40,
                        h: 40,
                        style: { bg: '#262626', border: i === 0 ? '#fbbf24' : '#525252' }, // Highlight first slot
                        props: { layoutMode: 'free' }
                    })),

                    // Bag Icon / Inventory Toggle
                    { id: 'btn_inventory', type: 'BUTTON', x: 460, y: 10, w: 40, h: 40, style: { bg: '#4f46e5', color: '#fff' }, props: { text: "ðŸŽ’", actionId: "TOGGLE_INVENTORY" } },

                    // Status Bars (Mock)
                    { id: 'bar_health', type: 'CONTAINER', x: 800, y: 10, w: 200, h: 15, style: { bg: '#9f1239', border: '#000' }, props: { layoutMode: 'free' } },
                    { id: 'bar_mana', type: 'CONTAINER', x: 800, y: 30, w: 200, h: 15, style: { bg: '#2563eb', border: '#000' }, props: { layoutMode: 'free' } },
                ],

                debug_overlay: [
                    // Map Generation Layout
                    { id: 'debug_root', type: 'CONTAINER', x: 0, y: 0, w: 1024, h: 768, style: { bg: '#000000', border: 'transparent' }, props: { layoutMode: 'free' } },

                    // Main Map View (256x256 Macro Grid)
                    { id: 'map_visualizer', type: 'CONTAINER', x: 250, y: 50, w: 512, h: 512, style: { bg: '#111', border: '#333' }, props: { layoutMode: 'free' } },
                    { id: 'map_placeholder_text', type: 'LABEL', x: 350, y: 300, w: 312, h: 20, style: { color: '#333' }, props: { text: "MACRO GRID VISUALIZATION (256x256)", fontSize: 12, align: "center" } },

                    // Side Panel (Controls)
                    { id: 'panel_controls', type: 'CONTAINER', x: 10, y: 50, w: 230, h: 512, style: { bg: '#171717', border: '#404040' }, props: { layoutMode: 'vertical' } },
                    { id: 'lbl_view_modes', type: 'LABEL', x: 20, y: 60, w: 200, h: 20, style: { color: '#fbbf24' }, props: { text: "VIEW MODES (F-Keys)", fontSize: 12, align: "left" } },

                    { id: 'chk_political', type: 'CHECKBOX', x: 20, y: 90, w: 20, h: 20, style: { bg: '#262626', border: '#525252' }, props: { checked: true, label: "F1: Political Borders" } },
                    { id: 'lbl_pol', type: 'LABEL', x: 50, y: 90, w: 150, h: 20, style: { color: '#ccc' }, props: { text: "Political Borders", fontSize: 11, align: "left" } },

                    { id: 'chk_biomes', type: 'CHECKBOX', x: 20, y: 120, w: 20, h: 20, style: { bg: '#262626', border: '#525252' }, props: { checked: false, label: "F2: Biomes" } },
                    { id: 'lbl_bio', type: 'LABEL', x: 50, y: 120, w: 150, h: 20, style: { color: '#ccc' }, props: { text: "Biomes", fontSize: 11, align: "left" } },

                    { id: 'chk_economy', type: 'CHECKBOX', x: 20, y: 150, w: 20, h: 20, style: { bg: '#262626', border: '#525252' }, props: { checked: false, label: "F3: Economy Heatmap" } },
                    { id: 'lbl_eco', type: 'LABEL', x: 50, y: 150, w: 150, h: 20, style: { color: '#ccc' }, props: { text: "Trade Wealth", fontSize: 11, align: "left" } },

                    { id: 'chk_ruin', type: 'CHECKBOX', x: 20, y: 180, w: 20, h: 20, style: { bg: '#262626', border: '#525252' }, props: { checked: false, label: "F4: Ruination" } },
                    { id: 'lbl_ruin', type: 'LABEL', x: 50, y: 180, w: 150, h: 20, style: { color: '#ccc' }, props: { text: "Ruination", fontSize: 11, align: "left" } },

                    // Bottom Panel (Timeline)
                    { id: 'panel_timeline', type: 'CONTAINER', x: 250, y: 580, w: 512, h: 100, style: { bg: '#171717', border: '#404040' }, props: { layoutMode: 'free' } },
                    { id: 'lbl_timeline', type: 'LABEL', x: 260, y: 590, w: 200, h: 20, style: { color: '#fbbf24' }, props: { text: "HISTORY SCRUBBER", fontSize: 12, align: "left" } },
                    { id: 'slider_year', type: 'SLIDER', x: 260, y: 620, w: 490, h: 30, style: { bg: '#333', border: '#555' }, props: { min: 0, max: 500, value: 0 } },
                    { id: 'lbl_year_val', type: 'LABEL', x: 260, y: 650, w: 490, h: 20, style: { color: '#fff' }, props: { text: "Current Year: 0 (Genesis)", fontSize: 12, align: "center" } },

                    // Inspector
                    { id: 'panel_inspector', type: 'CONTAINER', x: 780, y: 50, w: 230, h: 512, style: { bg: '#171717', border: '#404040' }, props: { layoutMode: 'vertical' } },
                    { id: 'lbl_inspector', type: 'LABEL', x: 790, y: 60, w: 200, h: 20, style: { color: '#fbbf24' }, props: { text: "TILE INSPECTOR", fontSize: 12, align: "left" } },
                    { id: 'lbl_insp_hint', type: 'LABEL', x: 790, y: 90, w: 210, h: 60, style: { color: '#666' }, props: { text: "Click any pixel on the map to view Macro Data (Civ, Resources, History).", fontSize: 10, align: "left" } },
                ]
            });

            const [selectedId, setSelectedId] = useState(null);

            // Drag/Resize Logic
            const [dragState, setDragState] = useState({ mode: null, startX: 0, startY: 0, initial: {} });
            const containerRef = useRef(null);

            // --- Helpers ---
            const currentWidgets = sceneData[currentScene];
            const selectedWidget = currentWidgets.find(w => w.id === selectedId);

            const updateWidget = (id, field, value) => {
                setSceneData(prev => ({
                    ...prev,
                    [currentScene]: prev[currentScene].map(w => {
                        if (w.id !== id) return w;
                        if (field.includes('.')) {
                            const [parent, child] = field.split('.');
                            return { ...w, [parent]: { ...w[parent], [child]: value } };
                        }
                        return { ...w, [field]: value };
                    })
                }));
            };

            const addWidget = (type) => {
                const def = WIDGET_TYPES[type];
                const newId = `${type.toLowerCase()}_${Date.now().toString().slice(-4)}`;
                const newWidget = {
                    id: newId,
                    type: type,
                    x: 50, y: 50, w: def.defaultW, h: def.defaultH,
                    style: { bg: '#262626', border: '#525252', color: '#e5e5e5' },
                    props: { ...def.defaultProps }
                };
                setSceneData(prev => ({ ...prev, [currentScene]: [...prev[currentScene], newWidget] }));
                setSelectedId(newId);
            };

            const deleteWidget = (id) => {
                setSceneData(prev => ({
                    ...prev,
                    [currentScene]: prev[currentScene].filter(w => w.id !== id)
                }));
                setSelectedId(null);
            };

            // --- Dragging Logic ---
            const handleMouseDown = (e, widget, mode) => {
                e.stopPropagation();
                setSelectedId(widget.id);
                setDragState({
                    mode,
                    startX: e.clientX,
                    startY: e.clientY,
                    initial: { x: widget.x, y: widget.y, w: widget.w, h: widget.h }
                });
            };

            const handleMouseMove = (e) => {
                if (!dragState.mode || !selectedId) return;
                const widget = currentWidgets.find(w => w.id === selectedId);
                if (!widget) return;

                const dx = e.clientX - dragState.startX;
                const dy = e.clientY - dragState.startY;
                const gridSnap = (val) => Math.round(val / 10) * 10; // 10px snap

                if (dragState.mode === 'move') {
                    const newX = gridSnap(dragState.initial.x + dx);
                    const newY = gridSnap(dragState.initial.y + dy);

                    const deltaX = newX - widget.x;
                    const deltaY = newY - widget.y;

                    // Bulk Update to handle parent + children
                    if (deltaX !== 0 || deltaY !== 0) {
                        setSceneData(prev => {
                            const newWidgets = [...prev[currentScene]];

                            // Recursive function to move a widget and its children
                            const moveWidgetAndChildren = (wId, dX, dY) => {
                                const wIndex = newWidgets.findIndex(w => w.id === wId);
                                if (wIndex !== -1) {
                                    newWidgets[wIndex] = {
                                        ...newWidgets[wIndex],
                                        x: newWidgets[wIndex].x + dX,
                                        y: newWidgets[wIndex].y + dY
                                    };

                                    // Find children
                                    const children = newWidgets.filter(child => child.parentId === wId);
                                    children.forEach(c => moveWidgetAndChildren(c.id, dX, dY));
                                }
                            };

                            moveWidgetAndChildren(selectedId, deltaX, deltaY);

                            return { ...prev, [currentScene]: newWidgets };
                        });
                    }

                } else if (dragState.mode === 'resize') {
                    updateWidget(selectedId, 'w', Math.max(20, gridSnap(dragState.initial.w + dx)));
                    updateWidget(selectedId, 'h', Math.max(20, gridSnap(dragState.initial.h + dy)));
                }

                // Update start pos for next frame to keep delta correct (since we are using += logic)
                // Actually, for React state, it's better to stick to initial+totalDelta. 
                // BUT, to simplify cascading which depends on current frame delta, we updated state.
                // So we need to reset startX/Y to current to avoid compounding.
                // However, gridSnap makes "per pixel" updates tricky.
                // Logic above uses `newX - widget.x` which is the delta *applied*. 
                // So we just need to ensure we don't double apply.
                // The issue: React state is async. 
                // Correct approach for smooth drag in React without per-frame lag:
                // Use a ref for immediate positions? No, keep it simple.
                // The standard approach:
                // 1. Calculate TARGET X/Y based on Initial + Total Delta.
                // 2. Calculate DIFF from Current X/Y.
                // 3. Apply DIFF to Self and Children.
                // As long as we use `dragState.initial` we are good.

                // WAIT: If we use `dragState.initial` for Parent, we know Parent's exact target.
                // But for Children, we need to know their Initial too? 
                // Simpler: Just track `lastX/lastY` in drag state and apply delta.
                if (dragState.mode === 'move') {
                    setDragState(prev => ({ ...prev, startX: e.clientX, startY: e.clientY, initial: { ...prev.initial, x: widget.x, y: widget.y } }));
                    // Wait, updating state during drag causes lag. 
                    // Better: Use `updateWidget` which triggers re-render, and just use the calculated `deltaX/Y` 
                    // derived from `newX - widget.x`.
                    // The code above `const deltaX = newX - widget.x` is correct for a single step *if* widget.x is current.
                }
            };

            const handleMouseUp = () => setDragState({ mode: null, startX: 0, startY: 0, initial: {} });

            // --- Export / Import ---
            const generateJSON = () => {
                const exportData = {
                    meta: { generated: new Date().toISOString(), version: "2.3" },
                    settings: settings,
                    scenes: {}
                };

                Object.keys(sceneData).forEach(scene => {
                    exportData.scenes[scene] = sceneData[scene].map(w => ({
                        id: w.id,
                        type: w.type,
                        parentId: w.parentId, // Export Hierarchy
                        geometry: { x: w.x, y: w.y, w: w.w, h: w.h },
                        style: w.style,
                        properties: {
                            ...(w.props || {}),
                            // Ensure fontName is explicitly set for compatible types
                            fontName: (w.type === 'LABEL' || w.type === 'BUTTON') ? ((w.props?.fontName) || "Kenney Pixel") : undefined
                        }
                    }));
                });

                return JSON.stringify(exportData, null, 2);
            };

            const handleImportClick = () => {
                fileInputRef.current.click();
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);

                        // Basic Validation
                        if (!importedData.scenes || !importedData.settings) {
                            alert("Invalid JSON format: Missing scenes or settings.");
                            return;
                        }

                        // Reconstruct State from Export Format (using shared sanitizer)
                        const newSceneData = sanitizeSceneData(importedData.scenes);

                        // Update State
                        setSettings(importedData.settings);
                        setSceneData(newSceneData);
                        // Reset selection to avoid ghost outlines
                        setSelectedId(null);
                        // Ensure we are on a valid scene (default to first available or main_menu)
                        if (!newSceneData[currentScene]) {
                            setCurrentScene(Object.keys(newSceneData)[0] || 'main_menu');
                        }

                        // Clear input so same file can be selected again if needed
                        e.target.value = null;

                    } catch (err) {
                        console.error("Import Error:", err);
                        alert("Failed to import JSON. Check console for details.");
                    }
                };
                reader.readAsText(file);
            };

            // --- Rendering Components ---
            const WidgetRenderer = ({ w: rawW }) => {
                // Safety: Ensure props/style exist to prevent crashes
                const w = { ...rawW, props: rawW.props || {}, style: rawW.style || {} };
                const isSelected = selectedId === w.id;

                const commonStyle = {
                    left: w.x,
                    top: w.y,
                    width: w.w,
                    height: w.h,
                    backgroundColor: w.style?.bg,
                    borderColor: isSelected ? '#10b981' : (w.style?.border || 'transparent'),
                    borderWidth: isSelected ? 2 : 1,
                    color: w.style?.color,
                    fontSize: w.props?.fontSize ? `${w.props.fontSize}px` : undefined,
                    zIndex: isSelected ? 100 : 1,
                    backgroundImage: w.props?.bgImage ? `url('${w.props.bgImage}')` : 'none',
                    backgroundSize: 'cover',
                    backgroundPosition: 'center'
                };

                // Visual simulation of widgets
                const renderInner = () => {
                    switch (w.type) {
                        case 'BUTTON':
                            return (
                                <button className="w-full h-full flex items-center justify-center font-bold uppercase tracking-wider hover:brightness-110 active:brightness-90 transition-all font-pixel border-2"
                                    style={ {
                                        fontFamily: (w.props.fontName || 'inherit'),
                                        backgroundImage: w.props.bgImage ? `url('${w.props.bgImage}')` : 'none',
                                        backgroundSize: 'cover',
                                        backgroundPosition: 'center',
                                        backgroundColor: w.style.bg,
                                        color: w.style.color,
                                        borderColor: w.style.border || 'transparent'
                                    } }>
                                    { w.props.text }
                                </button>
                            );
                        case 'SLIDER':
                            return (
                                <div className="w-full h-full flex items-center px-2 bg-neutral-900 border border-neutral-700">
                                    <div className="w-full h-1 bg-neutral-700 relative">
                                        <div className="absolute top-1/2 -translate-y-1/2 w-3 h-3 bg-emerald-500 rounded-full" style={ { left: '50%' } } />
                                    </div>
                                    <span className="ml-2 text-[10px] text-neutral-500">{ w.props.min }-{ w.props.max }</span>
                                </div>
                            );
                        case 'INPUT_TEXT':
                            return (
                                <input
                                    type="text"
                                    disabled
                                    className="w-full h-full border outline-none px-2 font-pixel"
                                    style={ {
                                        color: w.style.color,
                                        fontFamily: 'Kenney Pixel',
                                        backgroundColor: w.style.bg,
                                        borderColor: w.style.border || 'transparent'
                                    } }
                                    placeholder={ w.props.placeholder }
                                    value={ w.props.text || '' }
                                />
                            );
                        case 'CHECKBOX':
                            return (
                                <div className="w-full h-full flex items-center justify-center bg-neutral-900 border border-neutral-600">
                                    { w.props.checked && <div className="w-3 h-3 bg-emerald-500" /> }
                                </div>
                            );
                        case 'LABEL':
                            return (
                                <div className="w-full h-full flex items-center"
                                    style={ {
                                        justifyContent: w.props.align === 'center' ? 'center' : w.props.align === 'right' ? 'flex-end' : 'flex-start',
                                        color: w.style.color,
                                        backgroundColor: w.style.bg || 'transparent',
                                        fontSize: `${w.props.fontSize}px`
                                    } }>
                                    { w.props.text }
                                </div>
                            );
                        default: // CONTAINER
                            const renderPrefabPreview = () => {
                                if (!w.props.prefabHostId) return null;

                                const prefabRoot = (sceneData['prefabs'] || []).find(p => p.props.prefabId === w.props.prefabHostId);
                                if (!prefabRoot) return null;

                                // Find children inside the prefab root
                                const prefabChildren = (sceneData['prefabs'] || []).filter(c =>
                                    c.id !== prefabRoot.id &&
                                    c.x >= prefabRoot.x && c.x <= (prefabRoot.x + prefabRoot.w) &&
                                    c.y >= prefabRoot.y && c.y <= (prefabRoot.y + prefabRoot.h)
                                );

                                // Simulate 3 items based on layout mode
                                const isHorizontal = w.props.layoutMode === 'horizontal';
                                const items = [0, 1, 2];

                                return items.map(i => {
                                    const offsetX = isHorizontal ? (i * (prefabRoot.w + 5)) : 0;
                                    const offsetY = isHorizontal ? 0 : (i * (prefabRoot.h + 5));

                                    // Don't render if out of bounds of the host
                                    if (offsetY + prefabRoot.h > w.h && !w.props.scroll) return null;

                                    return (
                                        <div key={ i } className="absolute pointer-events-none opacity-50 grayscale"
                                            style={ {
                                                top: 5 + offsetY, // 5px padding
                                                left: 5 + offsetX,
                                                width: prefabRoot.w,
                                                height: prefabRoot.h,
                                                backgroundColor: prefabRoot.style.bg,
                                                border: `1px dashed ${prefabRoot.style.border}`
                                            } }>
                                            {/* Render Children relative to Root */ }
                                            { prefabChildren.map(child => {
                                                // Relative pos
                                                const rx = child.x - prefabRoot.x;
                                                const ry = child.y - prefabRoot.y;
                                                return (
                                                    <div key={ child.id } className="absolute border border-white/10 flex items-center justify-center text-[9px] overflow-hidden"
                                                        style={ {
                                                            top: ry, left: rx, width: child.w, height: child.h,
                                                            backgroundColor: child.style.bg, color: child.style.color,
                                                            fontSize: `${child.props.fontSize || 10}px`
                                                        } }>
                                                        { child.props.text || (child.type === 'BUTTON' ? child.props.text : '') || child.id }
                                                    </div>
                                                );
                                            }) }
                                        </div>
                                    );
                                });
                            };

                            return (
                                <div className="w-full h-full border border-dashed flex flex-col relative overflow-hidden" style={ { backgroundColor: w.style.bg, borderColor: w.style.border } }>
                                    <div className="p-1 text-[9px] text-neutral-500 opacity-50 uppercase flex justify-between z-10">
                                        <span>{ w.id }</span>
                                        { w.props.layoutMode && w.props.layoutMode !== 'free' && <Icon name="Layout" className="w-3 h-3 opacity-50" /> }
                                    </div>

                                    {/* Prefab Ghost Preview */ }
                                    <div className="absolute inset-0 p-1 pointer-events-none z-0">
                                        { renderPrefabPreview() }
                                    </div>
                                </div>
                            );
                    }
                };

                return (
                    <div
                        onMouseDown={ (e) => handleMouseDown(e, w, 'move') }
                        className={ `absolute cursor-grab active:cursor-grabbing select-none group ${isSelected ? 'z-50' : 'z-10'}` }
                        style={ { left: w.x, top: w.y, width: w.w, height: w.h } }
                    >
                        {/* Selection Outline */ }
                        { isSelected && <div className="absolute inset-0 border-2 border-emerald-500 pointer-events-none z-50">
                            <div className="absolute -top-4 left-0 bg-emerald-500 text-black text-[9px] px-1 font-bold">{ w.id }</div>
                            <div className="absolute -top-4 right-0 bg-neutral-800 text-emerald-500 text-[9px] px-1 font-mono">X:{ w.x } Y:{ w.y }</div>
                        </div> }

                        { renderInner() }

                        {/* Resize Handle */ }
                        { isSelected && (
                            <div
                                onMouseDown={ (e) => handleMouseDown(e, w, 'resize') }
                                className="absolute bottom-0 right-0 w-4 h-4 bg-emerald-500 cursor-nwse-resize z-50 flex items-center justify-center"
                            >
                                <Icon name="Maximize" className="w-3 h-3 text-black" />
                            </div>
                        ) }
                    </div>
                );
            };

            const PropertyInput = ({ label, value, onChange, type = "text" }) => (
                <div className="flex flex-col gap-1">
                    <label className="text-[10px] uppercase font-bold text-neutral-500">{ label }</label>
                    <input
                        type={ type }
                        value={ value || '' }
                        onChange={ (e) => onChange(e.target.value) }
                        className="bg-neutral-950 border border-neutral-700 rounded px-2 py-1.5 text-xs text-neutral-300 focus:border-emerald-500 focus:outline-none w-full"
                    />
                </div>
            );

            const PropertyInputImage = ({ label, value, onChange }) => {
                const fileInputRef = useRef(null);

                const handleFileChange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        // Try to be smart about the path. 
                        // Since browser security prevents getting full path, we assume assets/ui/ + filename
                        // This is a "best effort" for local dev tools.
                        const assetPath = `assets/ui/${file.name}`;
                        onChange(assetPath);
                    }
                };

                return (
                    <div className="flex flex-col gap-1">
                        <label className="text-[10px] uppercase font-bold text-neutral-500 flex justify-between">
                            { label }
                            <span className="text-[9px] text-neutral-600 lowercase font-normal">(auto-trim: assets/ui/)</span>
                        </label>
                        <div className="flex gap-2">
                            <input
                                type="text"
                                value={ value || '' }
                                onChange={ (e) => onChange(e.target.value) }
                                className="bg-neutral-950 border border-neutral-700 rounded px-2 py-1.5 text-xs text-neutral-300 focus:border-emerald-500 focus:outline-none w-full font-mono"
                                placeholder="assets/ui/..."
                            />
                            <button
                                onClick={ () => fileInputRef.current?.click() }
                                className="bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 rounded px-2 text-neutral-400 hover:text-white transition-colors"
                                title="Pick File"
                            >
                                <Icon name="Upload" className="w-4 h-4" />
                            </button>
                        </div>
                        {/* Hidden File Input */ }
                        <input
                            type="file"
                            ref={ fileInputRef }
                            className="hidden"
                            accept="image/png, image/jpeg, image/jpg"
                            onChange={ handleFileChange }
                        />
                    </div>
                );
            };

            // --- Scene Management ---
            const addScene = () => {
                const name = prompt("Enter new scene name (e.g., 'inventory_screen'):");
                if (!name) return;
                const cleanName = name.toLowerCase().replace(/[^a-z0-9_]/g, '_');

                if (sceneData[cleanName]) {
                    alert("Scene already exists!");
                    return;
                }

                setSceneData(prev => ({ ...prev, [cleanName]: [] }));
                setCurrentScene(cleanName);
            };

            const deleteScene = () => {
                const scenes = Object.keys(sceneData);
                if (scenes.length <= 1) {
                    alert("Cannot delete the last remaining scene.");
                    return;
                }

                if (!confirm(`Are you sure you want to delete scene '${currentScene}'? This cannot be undone.`)) return;

                const { [currentScene]: deleted, ...rest } = sceneData;
                setSceneData(rest);
                setCurrentScene(Object.keys(rest)[0]);
                setSelectedId(null);
            };

            return (
                <div className="flex flex-col h-screen bg-neutral-950 text-neutral-300 font-sans overflow-hidden" onMouseUp={ handleMouseUp } onMouseMove={ handleMouseMove }>

                    {/* HIDDEN INPUT FOR IMPORT */ }
                    <input
                        type="file"
                        ref={ fileInputRef }
                        onChange={ handleFileChange }
                        accept=".json"
                        style={ { display: 'none' } }
                    />

                    {/* --- HEADER --- */ }
                    <header className="h-14 border-b border-neutral-800 bg-neutral-900 flex items-center justify-between px-4 shrink-0">
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-2 text-emerald-500">
                                <Icon name="Terminal" />
                                <span className="font-bold tracking-tight text-white">Project Epoch UI</span>
                            </div>
                            <div className="h-6 w-px bg-neutral-800 mx-2"></div>

                            {/* Dynamic Scene Selector */ }
                            <div className="flex items-center gap-2 bg-neutral-950 rounded p-1 border border-neutral-800">
                                <select
                                    value={ currentScene }
                                    onChange={ (e) => { setCurrentScene(e.target.value); setSelectedId(null); } }
                                    className="bg-neutral-900 text-xs font-bold text-white px-2 py-1 rounded border border-neutral-700 outline-none focus:border-emerald-500 min-w-[150px]"
                                >
                                    { Object.keys(sceneData).map(scene => (
                                        <option key={ scene } value={ scene }>{ scene }</option>
                                    )) }
                                </select>

                                <button
                                    onClick={ addScene }
                                    className="p-1 hover:bg-neutral-800 rounded text-neutral-400 hover:text-emerald-400 transition-colors"
                                    title="Add New Scene"
                                >
                                    <Icon name="Plus" />
                                </button>
                                <button
                                    onClick={ deleteScene }
                                    className="p-1 hover:bg-neutral-800 rounded text-neutral-400 hover:text-red-500 transition-colors"
                                    title="Delete Current Scene"
                                >
                                    <Icon name="Trash" />
                                </button>
                            </div>
                        </div>

                        <div className="flex gap-2">
                            <button onClick={ saveToServer }
                                className="flex items-center gap-2 px-3 py-1.5 bg-emerald-700 hover:bg-emerald-600 text-xs font-bold rounded border border-emerald-600 transition-colors text-white">
                                <Icon name="UploadArrow" /> Save Project
                            </button>
                            <button onClick={ handleImportClick }
                                className="flex items-center gap-2 px-3 py-1.5 bg-neutral-800 hover:bg-neutral-700 text-xs font-bold rounded border border-neutral-700 transition-colors">
                                <Icon name="Upload" /> Import JSON
                            </button>
                            <button onClick={ () => {
                                const blob = new Blob([generateJSON()], { type: "application/json" });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `ui_layouts.json`;
                                a.click();
                            } } className="flex items-center gap-2 px-3 py-1.5 bg-neutral-800 hover:bg-neutral-700 text-xs font-bold rounded border border-neutral-700 transition-colors">
                                <Icon name="Copy" /> Export JSON
                            </button>
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden">
                        {/* --- TOOLBAR (Left) --- */ }
                        <div className="w-14 bg-neutral-900 border-r border-neutral-800 flex flex-col items-center py-4 gap-4 z-20">
                            { Object.entries(WIDGET_TYPES).map(([type, config]) => (
                                <button
                                    key={ type }
                                    onClick={ () => addWidget(type) }
                                    className="w-10 h-10 rounded flex items-center justify-center text-neutral-400 hover:bg-emerald-500/20 hover:text-emerald-400 hover:border-emerald-500/50 border border-transparent transition-all"
                                    title={ `Add ${config.label}` }
                                >
                                    <Icon name={ config.icon } />
                                </button>
                            )) }
                        </div>

                        {/* --- CANVAS (Center) --- */ }
                        <div
                            className="flex-1 bg-[#0a0a0a] relative overflow-hidden grid-bg"
                            ref={ containerRef }
                            onMouseDown={ (e) => {
                                // Only deselect if clicking the background directly (not a widget)
                                if (e.target === e.currentTarget || e.target.classList.contains('grid-bg')) {
                                    setSelectedId(null);
                                }
                            } }
                        >
                            {/* Canvas Size Indicator */ }
                            <div className="absolute top-0 left-0 border-b border-r border-neutral-700 bg-neutral-900/50 text-[10px] px-2 py-1 text-neutral-500">
                                { settings.width }x{ settings.height }
                            </div>

                            {/* Widgets */ }
                            <div
                                className="relative mx-auto my-8 shadow-2xl bg-black border border-neutral-800"
                                style={ { width: settings.width, height: settings.height } }
                                onMouseDown={ (e) => {
                                    // Also deselect if clicking the black canvas area but not a widget
                                    // Widgets call stopPropagation, so this only fires if we missed a widget
                                    if (e.target === e.currentTarget) {
                                        setSelectedId(null);
                                    }
                                } }
                            >
                                { (currentWidgets || []).map(w => <WidgetRenderer key={ w.id } w={ w } />) }
                            </div>
                        </div>

                        {/* --- RIGHT SIDEBAR (Hierarchy & Properties) --- */ }
                        <div className="w-80 bg-neutral-900 border-l border-neutral-800 flex flex-col overflow-hidden">

                            {/* Hierarchy Panel */ }
                            <div className="flex-1 flex flex-col min-h-0 border-b border-neutral-800">
                                <div className="h-8 bg-neutral-950 flex items-center px-4 border-b border-neutral-800">
                                    <span className="text-xs font-bold text-neutral-400 uppercase tracking-wider">Hierarchy</span>
                                </div>
                                <div className="flex-1 overflow-y-auto p-2">
                                    { (() => {
                                        // Build Tree
                                        const roots = (currentWidgets || []).filter(w => !w.parentId);

                                        const renderTree = (widget, depth = 0) => {
                                            const children = (currentWidgets || []).filter(w => w.parentId === widget.id);
                                            const isSelected = selectedId === widget.id;

                                            return (
                                                <div key={ widget.id }>
                                                    <div
                                                        className={ `flex items-center gap-2 px-2 py-1 rounded cursor-pointer text-xs ${isSelected ? 'bg-emerald-900/30 text-emerald-400' : 'text-neutral-400 hover:bg-neutral-800 hover:text-neutral-200'}` }
                                                        style={ { paddingLeft: `${depth * 12 + 8}px` } }
                                                        onClick={ (e) => { e.stopPropagation(); setSelectedId(widget.id); } }
                                                    >
                                                        <Icon name={ WIDGET_TYPES[widget.type]?.icon || 'Box' } className="w-3 h-3 opacity-70" />
                                                        <span className="truncate">{ widget.id }</span>
                                                    </div>
                                                    { children.map(child => renderTree(child, depth + 1)) }
                                                </div>
                                            );
                                        };

                                        return (
                                            <div className="space-y-0.5">
                                                { roots.map(root => renderTree(root)) }
                                                { roots.length === 0 && <div className="text-[10px] text-neutral-600 italic text-center mt-4">No widgets in scene</div> }
                                            </div>
                                        );
                                    })() }
                                </div>
                            </div>

                            {/* Properties Panel */ }
                            <div className="h-1/2 flex flex-col border-t border-neutral-800 overflow-hidden">
                                <div className="h-8 bg-neutral-950 flex items-center px-4 border-b border-neutral-800 shrink-0">
                                    <span className="text-xs font-bold text-neutral-400 uppercase tracking-wider">Properties</span>
                                </div>

                                <div className="flex-1 overflow-y-auto p-4">
                                    { selectedWidget ? (
                                        <div>
                                            <div className="flex items-center justify-between mb-4 pb-2 border-b border-neutral-800">
                                                <div>
                                                    <h3 className="font-bold text-neutral-200 text-sm uppercase">{ selectedWidget.type }</h3>
                                                    <p className="text-[10px] text-neutral-500 font-mono">{ selectedWidget.id }</p>
                                                </div>
                                                <div className="flex gap-1">
                                                    <button
                                                        onClick={ () => {
                                                            const sceneWidgets = [...sceneData[currentScene]];
                                                            const idx = sceneWidgets.findIndex(w => w.id === selectedId);
                                                            if (idx > 0) {
                                                                [sceneWidgets[idx], sceneWidgets[idx - 1]] = [sceneWidgets[idx - 1], sceneWidgets[idx]];
                                                                setSceneData({ ...sceneData, [currentScene]: sceneWidgets });
                                                            }
                                                        } }
                                                        className="p-1.5 bg-neutral-800 hover:bg-neutral-700 rounded text-neutral-400 hover:text-white transition-colors"
                                                        title="Move Backward"
                                                    >
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                                                    </button>
                                                    <button onClick={ () => deleteWidget(selectedWidget.id) } className="p-1.5 bg-red-900/20 hover:bg-red-900/50 text-red-500 rounded transition-colors">
                                                        <Icon name="Trash" />
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Common Props */ }
                                            <div className="space-y-4">
                                                <div className="space-y-1">
                                                    <label className="text-[10px] uppercase font-bold text-neutral-500">Parent</label>
                                                    <select
                                                        value={ selectedWidget.parentId || '' }
                                                        onChange={ (e) => {
                                                            const newParentId = e.target.value || null;
                                                            // Prevent cyclic parenting (simple check: can't be own child)
                                                            // For now, simple self-check
                                                            if (newParentId === selectedWidget.id) return;
                                                            updateWidget(selectedWidget.id, 'parentId', newParentId);
                                                        } }
                                                        className="w-full bg-neutral-950 border border-neutral-700 rounded px-2 py-1.5 text-xs text-neutral-300 focus:border-emerald-500 focus:outline-none"
                                                    >
                                                        <option value="">-- None (Root) --</option>
                                                        { currentWidgets.filter(w => w.id !== selectedWidget.id && w.type === 'CONTAINER').map(w => (
                                                            <option key={ w.id } value={ w.id }>{ w.id }</option>
                                                        )) }
                                                    </select>
                                                </div>

                                                <h3 className="text-xs font-bold text-neutral-400 uppercase tracking-wider">Geometry</h3>
                                                <PropertyInput label="ID" value={ selectedWidget.id } onChange={ (v) => updateWidget(selectedWidget.id, 'id', v) } />
                                                <div className="grid grid-cols-2 gap-2">
                                                    <PropertyInput label="X" type="number" value={ selectedWidget.x } onChange={ (v) => updateWidget(selectedWidget.id, 'x', parseInt(v) || 0) } />
                                                    <PropertyInput label="Y" type="number" value={ selectedWidget.y } onChange={ (v) => updateWidget(selectedWidget.id, 'y', parseInt(v) || 0) } />
                                                    <PropertyInput label="W" type="number" value={ selectedWidget.w } onChange={ (v) => updateWidget(selectedWidget.id, 'w', parseInt(v) || 0) } />
                                                    <PropertyInput label="H" type="number" value={ selectedWidget.h } onChange={ (v) => updateWidget(selectedWidget.id, 'h', parseInt(v) || 0) } />
                                                </div>

                                                <h3 className="text-xs font-bold text-neutral-400 uppercase tracking-wider mt-6 pt-4 border-t border-neutral-800">Specifics</h3>

                                                {/* Dynamic Props based on Type */ }
                                                { selectedWidget.type === 'BUTTON' && (
                                                    <>
                                                        <PropertyInput label="Label Text" value={ selectedWidget.props.text } onChange={ (v) => updateWidget(selectedWidget.id, 'props.text', v) } />
                                                        <div className="space-y-1 mb-3">
                                                            <label className="text-[10px] uppercase font-bold text-neutral-500">Font</label>
                                                            <select
                                                                value={ selectedWidget.props.fontName || '' }
                                                                onChange={ (e) => updateWidget(selectedWidget.id, 'props.fontName', e.target.value) }
                                                                className="w-full bg-neutral-950 border border-neutral-700 rounded px-2 py-1.5 text-xs text-neutral-300 focus:border-emerald-500 focus:outline-none"
                                                            >
                                                                <option value="">Default (Kenney Pixel)</option>
                                                                <option value="Kenney Future">Kenney Future</option>
                                                                <option value="Kenney High">Kenney High</option>
                                                                <option value="Kenney Mini">Kenney Mini</option>
                                                                <option value="Kenney Rocket">Kenney Rocket</option>
                                                                <option value="Kenney Blocks">Kenney Blocks</option>
                                                            </select>
                                                        </div>
                                                        <PropertyInput label="Action ID" value={ selectedWidget.props.actionId } onChange={ (v) => updateWidget(selectedWidget.id, 'props.actionId', v) } />
                                                        <PropertyInput label="BG Color" type="color" value={ selectedWidget.style.bg } onChange={ (v) => updateWidget(selectedWidget.id, 'style.bg', v) } />
                                                        <PropertyInput label="Text Color" type="color" value={ selectedWidget.style.color } onChange={ (v) => updateWidget(selectedWidget.id, 'style.color', v) } />
                                                        <PropertyInput label="Background Image" value={ selectedWidget.props.bgImage || '' } onChange={ (v) => updateWidget(selectedWidget.id, 'props.bgImage', v) } />
                                                    </>
                                                ) }

                                                { selectedWidget.type === 'SLIDER' && (
                                                    <>
                                                        <div className="grid grid-cols-2 gap-2">
                                                            <PropertyInput label="Min Value" type="number" value={ selectedWidget.props.min } onChange={ (v) => updateWidget(selectedWidget.id, 'props.min', parseInt(v)) } />
                                                            <PropertyInput label="Max Value" type="number" value={ selectedWidget.props.max } onChange={ (v) => updateWidget(selectedWidget.id, 'props.max', parseInt(v)) } />
                                                        </div>
                                                        <PropertyInput label="Default Value" type="number" value={ selectedWidget.props.value } onChange={ (v) => updateWidget(selectedWidget.id, 'props.value', parseInt(v)) } />
                                                    </>
                                                ) }

                                                { selectedWidget.type === 'LABEL' && (
                                                    <>
                                                        <PropertyInput label="Text Content" value={ selectedWidget.props.text } onChange={ (v) => updateWidget(selectedWidget.id, 'props.text', v) } />
                                                        <PropertyInput label="Font Size (px)" type="number" value={ selectedWidget.props.fontSize } onChange={ (v) => updateWidget(selectedWidget.id, 'props.fontSize', parseInt(v)) } />
                                                        <div className="space-y-1 mb-3">
                                                            <label className="text-[10px] uppercase font-bold text-neutral-500">Font</label>
                                                            <select
                                                                value={ selectedWidget.props.fontName || '' }
                                                                onChange={ (e) => updateWidget(selectedWidget.id, 'props.fontName', e.target.value) }
                                                                className="w-full bg-neutral-950 border border-neutral-700 rounded px-2 py-1.5 text-xs text-neutral-300 focus:border-emerald-500 focus:outline-none"
                                                            >
                                                                <option value="">Default (Kenney Pixel)</option>
                                                                <option value="Kenney Future">Kenney Future</option>
                                                                <option value="Kenney High">Kenney High</option>
                                                                <option value="Kenney Mini">Kenney Mini</option>
                                                                <option value="Kenney Rocket">Kenney Rocket</option>
                                                                <option value="Kenney Blocks">Kenney Blocks</option>
                                                            </select>
                                                        </div>
                                                        <div className="space-y-1 mb-3">
                                                            <label className="text-[10px] uppercase font-bold text-neutral-500">Alignment</label>
                                                            <select
                                                                value={ selectedWidget.props.align }
                                                                onChange={ (e) => updateWidget(selectedWidget.id, 'props.align', e.target.value) }
                                                                className="w-full bg-neutral-950 border border-neutral-700 rounded px-2 py-1.5 text-xs text-neutral-300 focus:border-emerald-500 focus:outline-none"
                                                            >
                                                                <option value="left">Left</option>
                                                                <option value="center">Center</option>
                                                                <option value="right">Right</option>
                                                            </select>
                                                        </div>
                                                    </>
                                                ) }

                                                { selectedWidget.type === 'CHECKBOX' && (
                                                    <>
                                                        <PropertyInput label="Label" value={ selectedWidget.props.label || '' } onChange={ (v) => updateWidget(selectedWidget.id, 'props.label', v) } />
                                                        <PropertyInput label="Action ID" value={ selectedWidget.props.actionId || '' } onChange={ (v) => updateWidget(selectedWidget.id, 'props.actionId', v) } />
                                                        <div className="flex items-center justify-between bg-neutral-950 p-2 rounded border border-neutral-800">
                                                            <span className="text-xs font-bold text-neutral-400">Default Checked</span>
                                                            <input type="checkbox" checked={ selectedWidget.props.checked } onChange={ (e) => updateWidget(selectedWidget.id, 'props.checked', e.target.checked) } />
                                                        </div>
                                                    </>
                                                ) }

                                                { selectedWidget.type === 'CONTAINER' && (
                                                    <>
                                                        <PropertyInput label="Background" type="color" value={ selectedWidget.style.bg } onChange={ (v) => updateWidget(selectedWidget.id, 'style.bg', v) } />
                                                        <PropertyInput label="Border" type="color" value={ selectedWidget.style.border } onChange={ (v) => updateWidget(selectedWidget.id, 'style.border', v) } />
                                                        <PropertyInputImage label="Background Image" value={ selectedWidget.props.bgImage || '' } onChange={ (v) => updateWidget(selectedWidget.id, 'props.bgImage', v) } />
                                                        <PropertyInput label="Slice Border (9-Slice)" type="number" value={ selectedWidget.props.sliceBorder || 0 } onChange={ (v) => updateWidget(selectedWidget.id, 'props.sliceBorder', parseInt(v) || 0) } />
                                                        <div className="space-y-1 mb-3">
                                                            <label className="text-[10px] uppercase font-bold text-neutral-500">Layout Mode (Engine Hint)</label>
                                                            <select
                                                                value={ selectedWidget.props.layoutMode || 'free' }
                                                                onChange={ (e) => updateWidget(selectedWidget.id, 'props.layoutMode', e.target.value) }
                                                                className="w-full bg-neutral-950 border border-neutral-700 rounded px-2 py-1.5 text-xs text-neutral-300 focus:border-emerald-500 focus:outline-none"
                                                            >
                                                                <option value="free">Free (Absolute)</option>
                                                                <option value="vertical">Vertical Stack</option>
                                                                <option value="horizontal">Horizontal Stack</option>
                                                            </select>
                                                        </div>
                                                        <div className="pt-4 mt-4 border-t border-neutral-800">
                                                            <h4 className="text-[10px] font-bold text-neutral-500 uppercase mb-2">Prefab / Templating</h4>

                                                            { currentScene === 'prefabs' ? (
                                                                <>
                                                                    <PropertyInput label="Prefab ID (Template Name)" value={ selectedWidget.props.prefabId || '' } onChange={ (v) => updateWidget(selectedWidget.id, 'props.prefabId', v) } />
                                                                    <p className="text-[9px] text-neutral-600 mb-2">Unique ID for this template (e.g., WORLD_ITEM_TEMPLATE).</p>
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <div className="space-y-1 mb-3">
                                                                        <label className="text-[10px] uppercase font-bold text-neutral-500">Item Template</label>
                                                                        <select
                                                                            value={ selectedWidget.props.prefabHostId || '' }
                                                                            onChange={ (e) => updateWidget(selectedWidget.id, 'props.prefabHostId', e.target.value) }
                                                                            className="w-full bg-neutral-950 border border-neutral-700 rounded px-2 py-1.5 text-xs text-neutral-300 focus:border-emerald-500 focus:outline-none"
                                                                        >
                                                                            <option value="">-- None --</option>
                                                                            { (sceneData['prefabs'] || [])
                                                                                .filter(p => p.props.prefabId) // Only show items with a Prefab ID
                                                                                .map(p => (
                                                                                    <option key={ p.id } value={ p.props.prefabId }>{ p.props.prefabId }</option>
                                                                                ))
                                                                            }
                                                                        </select>
                                                                        <p className="text-[9px] text-neutral-600">Select a template from the 'prefabs' scene to spawn here.</p>
                                                                    </div>
                                                                </>
                                                            ) }
                                                        </div>
                                                    </>
                                                ) }

                                                { selectedWidget.type === 'IMAGE' && (
                                                    <>
                                                        <PropertyInputImage label="Image Path" value={ selectedWidget.props.image } onChange={ (v) => updateWidget(selectedWidget.id, 'props.image', v) } />
                                                        <PropertyInput label="Background" type="color" value={ selectedWidget.style.bg } onChange={ (v) => updateWidget(selectedWidget.id, 'style.bg', v) } />
                                                    </>
                                                ) }

                                                { selectedWidget.type === 'INPUT_TEXT' && (
                                                    <>
                                                        <PropertyInput label="Placeholder" value={ selectedWidget.props.placeholder } onChange={ (v) => updateWidget(selectedWidget.id, 'props.placeholder', v) } />
                                                        <PropertyInput label="Default Text" value={ selectedWidget.props.text } onChange={ (v) => updateWidget(selectedWidget.id, 'props.text', v) } />
                                                        <PropertyInput label="Font Size" type="number" value={ selectedWidget.props.fontSize || 12 } onChange={ (v) => updateWidget(selectedWidget.id, 'props.fontSize', parseInt(v)) } />
                                                        <PropertyInput label="Background" type="color" value={ selectedWidget.style.bg } onChange={ (v) => updateWidget(selectedWidget.id, 'style.bg', v) } />
                                                        <PropertyInput label="Text Color" type="color" value={ selectedWidget.style.color } onChange={ (v) => updateWidget(selectedWidget.id, 'style.color', v) } />
                                                        <PropertyInput label="Border" type="color" value={ selectedWidget.style.border } onChange={ (v) => updateWidget(selectedWidget.id, 'style.border', v) } />
                                                    </>
                                                ) }
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="flex-1 flex flex-col items-center justify-center text-neutral-600 p-8 text-center opacity-50">
                                            <Icon name="MousePointer" className="w-8 h-8 mb-2" />
                                            <p className="text-xs">Select a widget to edit properties</p>
                                        </div>
                                    ) }



                                    {/* --- JSON PREVIEW FOOTER --- */ }
                                    <div className="border-t border-neutral-800 bg-neutral-950 p-0 flex flex-col h-1/3">
                                        <div className="px-4 py-2 bg-neutral-900 text-[10px] font-bold uppercase text-neutral-500 tracking-wider">
                                            JSON Output Preview
                                        </div>
                                        <div className="flex-1 overflow-auto p-4">
                                            <pre className="text-[10px] text-emerald-600 font-mono whitespace-pre-wrap">
                                                { generateJSON() }
                                            </pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>