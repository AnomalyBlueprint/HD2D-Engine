<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epoch Bestiary Architect</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            background-color: #0f172a;
            color: #f1f5f9;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ICONS ---
        const IconBase = ({ d, className, color }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={ className } style={ { color: color } }>
                { d }
            </svg>
        );

        const Database = (props) => <IconBase { ...props } d={ <><ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" /><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" /></> } />;
        const Save = (props) => <IconBase { ...props } d={ <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></> } />;
        const Trash2 = (props) => <IconBase { ...props } d={ <><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></> } />;
        const Plus = (props) => <IconBase { ...props } d={ <><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></> } />;
        const Shield = (props) => <IconBase { ...props } d={ <><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></> } />;
        const Heart = (props) => <IconBase { ...props } d={ <><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" /></> } />;
        const Globe = (props) => <IconBase { ...props } d={ <><circle cx="12" cy="12" r="10" /><line x1="2" y1="12" x2="22" y2="12" /><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" /></> } />;
        const Swords = (props) => <IconBase { ...props } d={ <><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5" /><line x1="13" y1="19" x2="19" y2="13" /><line x1="16" y1="16" x2="20" y2="20" /><line x1="19" y1="21" x2="21" y2="19" /><polyline points="14.5 6.5 18 3 21 3 21 6 17.5 9.5" /><line x1="5" y1="14" x2="9" y2="18" /><line x1="7" y1="17" x2="4" y2="20" /><line x1="2" y1="19" x2="4" y2="21" /></> } />;
        const Activity = (props) => <IconBase { ...props } d={ <><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></> } />;
        const Dna = (props) => <IconBase { ...props } d={ <><path d="M2 15c6.667-6 13.333 0 20-6" /><path d="M9 22c1.798-1.998 2.518-3.995 2.807-5.993" /><path d="M15 2c-1.798 1.998-2.518 3.995-2.807 5.993" /><path d="M17 12c-5.667 4-11.333-2-17 2" /></> } />;
        const Gem = (props) => <IconBase { ...props } d={ <><path d="M6 3h12l4 6-10 13L2 9z" /><path d="M11 3 8 9l4 13 4-13-3-6" /><path d="M2 9h20" /></> } />;
        const Flask = (props) => <IconBase { ...props } d={ <><path d="M10 2v7.31" /><path d="M14 2v7.31" /><path d="M8.5 2h7" /><path d="M14 9.3a6.5 6.5 0 1 1-4 0" /><path d="M5.52 16h12.96" /></> } />;
        const X = (props) => <IconBase { ...props } d={ <><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></> } />;
        const Droplet = (props) => <IconBase { ...props } d={ <><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z" /></> } />;
        const Zap = (props) => <IconBase { ...props } d={ <><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></> } />;
        const Wind = (props) => <IconBase { ...props } d={ <><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2" /></> } />;
        const Hammer = (props) => <IconBase { ...props } d={ <><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9" /><path d="M17.64 15 22 10.64" /><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25v-.86L16.01 4.6a5.56 5.56 0 0 0-3.94-1.64H11.2C10.43 2.96 9.25 3.32 8.7 4.1 8.21 4.8 8.44 5.8 9 6.45l2.42 2.42c.48.48.75 1.13.75 1.8v1.17c0 .85-.33 1.66-.93 2.26L10 15.34" /></> } />;

        // --- CONSTANTS & HELPERS ---

        const BIOMES = [
            { id: 0, name: "Ocean" }, { id: 1, name: "Ice Cap" }, { id: 2, name: "Tundra" },
            { id: 3, name: "Taiga" }, { id: 4, name: "Grassland" }, { id: 5, name: "Forest" },
            { id: 6, name: "Swamp" }, { id: 7, name: "Desert" }, { id: 8, name: "Savannah" },
            { id: 9, name: "Jungle" }, { id: 10, name: "Volcanic" }, { id: 11, name: "Deadlands" },
            { id: 12, name: "Crystal Wastes" }
        ];

        const SIZE_INDICES = {
            "Tiny": 2, "Small": 3, "Medium": 4, "Large": 6, "Huge": 8, "Colossal": 16
        };
        const getSizeName = (idx) => Object.keys(SIZE_INDICES).find(key => SIZE_INDICES[key] === idx) || "Medium";

        const getCRColor = (cr) => {
            if (cr < 1) return "text-emerald-400 border-emerald-900/50 bg-emerald-900/20";
            if (cr <= 3) return "text-yellow-400 border-yellow-900/50 bg-yellow-900/20";
            if (cr <= 5) return "text-red-400 border-red-900/50 bg-red-900/20";
            return "text-purple-400 border-purple-900/50 bg-purple-900/20";
        };

        const ATTACK_CATEGORIES = {
            "Piercing": { desc: "Deep penetration, puncture", color: "text-blue-400", icon: Swords },
            "Slashing": { desc: "Surface slicing, severing", color: "text-red-400", icon: Wind },
            "Blunt": { desc: "Breaking bones, trauma", color: "text-orange-400", icon: Hammer },
            "Shredding": { desc: "Ripping flesh, multiple wounds", color: "text-red-600", icon: Activity },
            "Chemical": { desc: "Necrosis, paralysis, burns", color: "text-green-400", icon: Droplet },
            "Energy": { desc: "Shock, sonic, thermal", color: "text-yellow-400", icon: Zap }
        };

        // --- HARVEST & LOOT SYSTEM ---
        const HARVEST_TYPES = {
            "Skinning": { toolNeeded: "Knife", attribute: "Dexterity", speed: "Fast", baseTimeSeconds: 3 },
            "Butchering": { toolNeeded: "Cleaver", attribute: "Strength", speed: "Medium", baseTimeSeconds: 5 },
            "Extraction": { toolNeeded: "Tweezers", attribute: "Precision", speed: "Slow", baseTimeSeconds: 8 },
            "Sawing": { toolNeeded: "Bone Saw", attribute: "Strength", speed: "Slow", baseTimeSeconds: 10 },
            "Draining": { toolNeeded: "Vial", attribute: "Care", speed: "Medium", baseTimeSeconds: 4 },
            "Plucking": { toolNeeded: "Hands", attribute: "Speed", speed: "Fast", baseTimeSeconds: 2 },
            "Scraping": { toolNeeded: "Scraper", attribute: "Patience", speed: "Slow", baseTimeSeconds: 6 },
            "Milking": { toolNeeded: "Flask", attribute: "Handling", speed: "Slow", baseTimeSeconds: 7 },
            "Scavenging": { toolNeeded: "Hands", attribute: "Perception", speed: "Fast", baseTimeSeconds: 2 }
        };

        const ANATOMY_PARTS = {
            "Jaw_Teeth": { defaultHarvest: "Extraction", baseDrops: ["Tooth", "Jawbone", "Enamel Shard"] },
            "Fangs": { defaultHarvest: "Extraction", baseDrops: ["Fang", "Venom Droplet"] },
            "Beak": { defaultHarvest: "Sawing", baseDrops: ["Beak", "Keratin Scrap"] },
            "Horns": { defaultHarvest: "Sawing", baseDrops: ["Horn", "Bone Dust"] },
            "Antlers": { defaultHarvest: "Sawing", baseDrops: ["Antler", "Bone Dust"] },
            "Tusks": { defaultHarvest: "Sawing", baseDrops: ["Ivory", "Bone Dust"] },
            "Spines_Quills": { defaultHarvest: "Plucking", baseDrops: ["Quill", "Spine"] },
            "Claws_Talons": { defaultHarvest: "Extraction", baseDrops: ["Claw", "Keratin Scrap"] },
            "Pincers_Mandibles": { defaultHarvest: "Sawing", baseDrops: ["Pincer", "Chitin Plate"] },
            "Paws_Pads": { defaultHarvest: "Skinning", baseDrops: ["Paw", "Sinew"] },
            "Legs_Bones": { defaultHarvest: "Butchering", baseDrops: ["Femur", "Marrow"] },
            "Hooves": { defaultHarvest: "Sawing", baseDrops: ["Hoof", "Keratin Scrap"] },
            "Skull_Head": { defaultHarvest: "Butchering", baseDrops: ["Skull", "Brain Matter"] },
            "Meat_Muscle": { defaultHarvest: "Butchering", baseDrops: ["Raw Meat", "Animal Fat"] },
            "Scales_Carapace": { defaultHarvest: "Scraping", baseDrops: ["Scale", "Chitin Plate", "Scute"] },
            "Tail": { defaultHarvest: "Butchering", baseDrops: ["Tail", "Vertebrae"] },
            "Fins_Flukes": { defaultHarvest: "Butchering", baseDrops: ["Fin", "Cartilage"] },
            "Tentacles": { defaultHarvest: "Butchering", baseDrops: ["Tentacle", "Suction Cup"] },
            "Wings_Feathered": { defaultHarvest: "Plucking", baseDrops: ["Feather", "Hollow Bone"] },
            "Wings_Membranous": { defaultHarvest: "Skinning", baseDrops: ["Wing Membrane", "Leathery Scrap"] },
            "Stinger_Spur": { defaultHarvest: "Extraction", baseDrops: ["Stinger", "Barb"] },
            "Internal_Gland": { defaultHarvest: "Extraction", baseDrops: ["Gland", "Noxious Fluid", "Acid Sac"] },
            "Blood": { defaultHarvest: "Draining", baseDrops: ["Blood", "Plasma"] },
            "Special_Organ": { defaultHarvest: "Extraction", baseDrops: ["Electrocyte", "Sonic Chamber", "Luminous Node"] }
        };

        const HARD_LOOT_MODIFIERS = {
            "Shattered": { valueMult: 0.1, craftQuality: "Trash", dropWeight: 30 },
            "Cracked": { valueMult: 0.25, craftQuality: "Poor", dropWeight: 25 },
            "Chipped": { valueMult: 0.5, craftQuality: "Common", dropWeight: 20 },
            "Standard": { valueMult: 1.0, craftQuality: "Uncommon", dropWeight: 15 },
            "Intact": { valueMult: 2.0, craftQuality: "Rare", dropWeight: 7 },
            "Pristine": { valueMult: 5.0, craftQuality: "Epic", dropWeight: 2 },
            "Flawless": { valueMult: 10.0, craftQuality: "Legendary", dropWeight: 1 }
        };

        const ORGANIC_LOOT_MODIFIERS = {
            "Rotting": { valueMult: 0.1, craftQuality: "Trash", dropWeight: 30 },
            "Tainted": { valueMult: 0.25, craftQuality: "Poor", dropWeight: 25 },
            "Mangled": { valueMult: 0.5, craftQuality: "Common", dropWeight: 20 },
            "Standard": { valueMult: 1.0, craftQuality: "Uncommon", dropWeight: 15 },
            "Prime": { valueMult: 2.0, craftQuality: "Rare", dropWeight: 7 },
            "Exquisite": { valueMult: 5.0, craftQuality: "Epic", dropWeight: 2 },
            "Perfect": { valueMult: 10.0, craftQuality: "Legendary", dropWeight: 1 }
        };

        // --- BASE ATTACK DICTIONARY ---
        const BASE_ATTACKS = {
            "Nibble": { type: "Piercing", effect: "None", baseDamage: "1d2", anatomyTag: "Jaw_Teeth" },
            "Bite": { type: "Piercing", effect: "None", baseDamage: "1d6", anatomyTag: "Jaw_Teeth" },
            "Gnaw": { type: "Shredding", effect: "Bleed", baseDamage: "1d4", anatomyTag: "Jaw_Teeth" },
            "Crunch": { type: "Blunt", effect: "None", baseDamage: "1d8", anatomyTag: "Jaw_Teeth" },
            "Jaw Snap": { type: "Slashing", effect: "None", baseDamage: "1d6", anatomyTag: "Jaw_Teeth" },
            "Serrated Bite": { type: "Shredding", effect: "Bleed", baseDamage: "2d4", anatomyTag: "Jaw_Teeth" },
            "Crushing Jaw": { type: "Blunt", effect: "Stun", baseDamage: "2d6", anatomyTag: "Jaw_Teeth" },
            "Throat Crush": { type: "Blunt", effect: "Silence", baseDamage: "2d6", anatomyTag: "Jaw_Teeth" },
            "Trap-Jaw Strike": { type: "Blunt", effect: "Stun", baseDamage: "1d8", anatomyTag: "Jaw_Teeth" },
            "Venomous Bite": { type: "Piercing", effect: "Poison", baseDamage: "1d4", anatomyTag: "Fangs" },
            "Toxic Chomp": { type: "Chemical", effect: "Poison", baseDamage: "1d6", anatomyTag: "Fangs" },
            "Vampiric Drain": { type: "Piercing", effect: "Drain", baseDamage: "1d4", anatomyTag: "Fangs" },
            "Leech Latch": { type: "Slashing", effect: "Drain", baseDamage: "1d2", anatomyTag: "Fangs" },
            "Peck": { type: "Piercing", effect: "None", baseDamage: "1d4", anatomyTag: "Beak" },
            "Beak Tear": { type: "Shredding", effect: "Bleed", baseDamage: "1d6", anatomyTag: "Beak" },
            "Hooked Beak": { type: "Shredding", effect: "Bleed", baseDamage: "1d8", anatomyTag: "Beak" },
            "Bill Thrust": { type: "Piercing", effect: "None", baseDamage: "1d6", anatomyTag: "Beak" },
            "Sword-Bill Slash": { type: "Slashing", effect: "Bleed", baseDamage: "2d4", anatomyTag: "Beak" },
            "Macaw Crush": { type: "Blunt", effect: "None", baseDamage: "1d8", anatomyTag: "Beak" },
            "Gore": { type: "Piercing", effect: "Knockback", baseDamage: "1d8", anatomyTag: "Horns" },
            "Horn Ram": { type: "Blunt", effect: "Stun", baseDamage: "2d4", anatomyTag: "Horns" },
            "Rhino Charge": { type: "Blunt", effect: "Knockback", baseDamage: "2d8", anatomyTag: "Horns" },
            "Antler Toss": { type: "Piercing", effect: "Knockback", baseDamage: "1d6", anatomyTag: "Antlers" },
            "Tusk Slash": { type: "Slashing", effect: "Bleed", baseDamage: "1d8", anatomyTag: "Tusks" },
            "Spine Charge": { type: "Piercing", effect: "Bleed", baseDamage: "1d6", anatomyTag: "Spines_Quills" },
            "Quill Shoot": { type: "Piercing", effect: "None", baseDamage: "1d4", anatomyTag: "Spines_Quills" },
            "Barbed Harpoon": { type: "Piercing", effect: "Grapple", baseDamage: "1d8", anatomyTag: "Spines_Quills" },
            "Scratch": { type: "Slashing", effect: "None", baseDamage: "1d4", anatomyTag: "Claws_Talons" },
            "Claw": { type: "Slashing", effect: "Bleed", baseDamage: "1d6", anatomyTag: "Claws_Talons" },
            "Talon": { type: "Slashing", effect: "Bleed", baseDamage: "1d6", anatomyTag: "Claws_Talons" },
            "Rake": { type: "Shredding", effect: "Bleed", baseDamage: "2d4", anatomyTag: "Claws_Talons" },
            "Swipe": { type: "Slashing", effect: "None", baseDamage: "1d6", anatomyTag: "Claws_Talons" },
            "Eviscerate": { type: "Shredding", effect: "Bleed", baseDamage: "3d4", anatomyTag: "Claws_Talons" },
            "Mantis Scythe": { type: "Slashing", effect: "Bleed", baseDamage: "2d4", anatomyTag: "Pincers_Mandibles" },
            "Pincer Snipe": { type: "Slashing", effect: "None", baseDamage: "1d6", anatomyTag: "Pincers_Mandibles" },
            "Crab Pinch": { type: "Blunt", effect: "Grapple", baseDamage: "1d4", anatomyTag: "Pincers_Mandibles" },
            "Raptorial Grasp": { type: "Piercing", effect: "Grapple", baseDamage: "1d6", anatomyTag: "Pincers_Mandibles" },
            "Mandible Pinch": { type: "Shredding", effect: "Bleed", baseDamage: "1d4", anatomyTag: "Pincers_Mandibles" },
            "Pounce": { type: "Blunt", effect: "Knockback", baseDamage: "1d6", anatomyTag: "Paws_Pads" },
            "Paw Strike": { type: "Blunt", effect: "None", baseDamage: "1d4", anatomyTag: "Paws_Pads" },
            "Slam": { type: "Blunt", effect: "Stun", baseDamage: "1d6", anatomyTag: "Legs_Bones" },
            "Kick": { type: "Blunt", effect: "Knockback", baseDamage: "1d6", anatomyTag: "Legs_Bones" },
            "Hind Kick": { type: "Blunt", effect: "Knockback", baseDamage: "2d6", anatomyTag: "Legs_Bones" },
            "Kangaroo Box": { type: "Blunt", effect: "Stun", baseDamage: "1d6", anatomyTag: "Legs_Bones" },
            "Hoof Stomp": { type: "Blunt", effect: "None", baseDamage: "1d8", anatomyTag: "Hooves" },
            "Trample": { type: "Blunt", effect: "Knockback", baseDamage: "2d6", anatomyTag: "Hooves" },
            "Headbutt": { type: "Blunt", effect: "Stun", baseDamage: "1d8", anatomyTag: "Skull_Head" },
            "Body Slam": { type: "Blunt", effect: "Knockback", baseDamage: "2d4", anatomyTag: "Meat_Muscle" },
            "Roll Attack": { type: "Blunt", effect: "Knockback", baseDamage: "1d6", anatomyTag: "Scales_Carapace" },
            "Death Roll": { type: "Shredding", effect: "Grapple", baseDamage: "2d8", anatomyTag: "Meat_Muscle" },
            "Tail Whip": { type: "Blunt", effect: "Knockback", baseDamage: "1d8", anatomyTag: "Tail" },
            "Tail Club": { type: "Blunt", effect: "Stun", baseDamage: "2d6", anatomyTag: "Tail" },
            "Thresher Slap": { type: "Slashing", effect: "Stun", baseDamage: "1d8", anatomyTag: "Tail" },
            "Fluke Smash": { type: "Blunt", effect: "Knockback", baseDamage: "3d6", anatomyTag: "Fins_Flukes" },
            "Spiked Tail": { type: "Piercing", effect: "Bleed", baseDamage: "1d8", anatomyTag: "Tail" },
            "Tentacle Lash": { type: "Blunt", effect: "None", baseDamage: "1d6", anatomyTag: "Tentacles" },
            "Suction Grip": { type: "Blunt", effect: "Grapple", baseDamage: "1d4", anatomyTag: "Tentacles" },
            "Nematocyst Lash": { type: "Chemical", effect: "Burn", baseDamage: "1d4", anatomyTag: "Tentacles" },
            "Constrict": { type: "Blunt", effect: "Slow", baseDamage: "1d8", anatomyTag: "Meat_Muscle" },
            "Python Squeeze": { type: "Blunt", effect: "Grapple", baseDamage: "2d6", anatomyTag: "Meat_Muscle" },
            "Wing Buffet": { type: "Blunt", effect: "Knockback", baseDamage: "1d4", anatomyTag: "Wings_Feathered" },
            "Dive Bomb": { type: "Blunt", effect: "Stun", baseDamage: "2d6", anatomyTag: "Wings_Feathered" },
            "Swan Strike": { type: "Blunt", effect: "None", baseDamage: "1d6", anatomyTag: "Wings_Feathered" },
            "Leathery Wing Buffet": { type: "Blunt", effect: "Knockback", baseDamage: "1d6", anatomyTag: "Wings_Membranous" },
            "Fin Slash": { type: "Slashing", effect: "None", baseDamage: "1d6", anatomyTag: "Fins_Flukes" },
            "Sting": { type: "Piercing", effect: "Poison", baseDamage: "1d4", anatomyTag: "Stinger_Spur" },
            "Barbed Sting": { type: "Piercing", effect: "Bleed", baseDamage: "1d6", anatomyTag: "Stinger_Spur" },
            "Neurotoxic Sting": { type: "Chemical", effect: "Paralysis", baseDamage: "1d8", anatomyTag: "Stinger_Spur" },
            "Venom Spur": { type: "Piercing", effect: "Poison", baseDamage: "1d6", anatomyTag: "Stinger_Spur" },
            "Acid Spray": { type: "Chemical", effect: "Burn", baseDamage: "2d4", anatomyTag: "Internal_Gland" },
            "Venom Spit": { type: "Chemical", effect: "Blind", baseDamage: "1d6", anatomyTag: "Internal_Gland" },
            "Ink Cloud": { type: "Chemical", effect: "Blind", baseDamage: "0", anatomyTag: "Internal_Gland" },
            "Skunk Musk": { type: "Chemical", effect: "Nausea", baseDamage: "1d2", anatomyTag: "Internal_Gland" },
            "Blood Squirt": { type: "Chemical", effect: "Blind", baseDamage: "0", anatomyTag: "Blood" },
            "Boiling Fluid": { type: "Chemical", effect: "Burn", baseDamage: "2d6", anatomyTag: "Internal_Gland" },
            "Toxic Spores": { type: "Chemical", effect: "Poison", baseDamage: "1d4", anatomyTag: "Internal_Gland" },
            "Web Shoot": { type: "Chemical", effect: "Slow", baseDamage: "0", anatomyTag: "Internal_Gland" },
            "Slime Secretion": { type: "Chemical", effect: "Grapple", baseDamage: "0", anatomyTag: "Internal_Gland" },
            "Shock Touch": { type: "Energy", effect: "Stun", baseDamage: "1d8", anatomyTag: "Special_Organ" },
            "Eel Discharge": { type: "Energy", effect: "Paralysis", baseDamage: "2d6", anatomyTag: "Special_Organ" },
            "Sonic Snap": { type: "Energy", effect: "Stun", baseDamage: "1d10", anatomyTag: "Pincers_Mandibles" },
            "Thermal Flash": { type: "Energy", effect: "Burn", baseDamage: "1d8", anatomyTag: "Special_Organ" },
            "Echolocation Blast": { type: "Energy", effect: "Blind", baseDamage: "1d4", anatomyTag: "Skull_Head" }
        };

        // --- PROCEDURAL GENERATION ---
        const PREFIXES = {
            "Minor ": { diceMod: -1, effectChance: 0.5 },    // Weak creatures
            "Savage ": { diceMod: 1, effectChance: 1.0 },    // Aggressive creatures
            "Dire ": { diceMod: 2, effectChance: 1.0 },      // Boss creatures
            "Feral ": { diceMod: 0, effectChance: 1.5 }      // Status-heavy creatures
        };

        function generateExpandedAttacks(baseAttacks, prefixes) {
            let expandedAttacks = { ...baseAttacks };

            for (const [attackName, stats] of Object.entries(baseAttacks)) {
                for (const [prefix, mods] of Object.entries(prefixes)) {

                    let [count, sides] = stats.baseDamage.split('d');
                    let newDamage = "0";
                    if (sides) {
                        let newCount = Math.max(1, parseInt(count) + mods.diceMod);
                        newDamage = `${newCount}d${sides}`;
                    }

                    expandedAttacks[`${prefix}${attackName}`] = {
                        type: stats.type,
                        effect: stats.effect,
                        damage: newDamage,
                        anatomyTag: stats.anatomyTag // Strictly inherited from BASE
                    };
                }
            }
            return expandedAttacks;
        }

        const FULL_ATTACK_DATABASE = generateExpandedAttacks(BASE_ATTACKS, PREFIXES);

        // --- UPDATED REAL WORLD DATASET ---
        const REAL_WORLD_DATA = {
            "Canines": {
                "Wolf": { type: "Beast", size: "Medium", cr: 1, hp: 13, ac: 13, attacks: ["Bite", "Pounce"], biomes: [3, 5] },
                "Coyote": { type: "Beast", size: "Medium", cr: 0.5, hp: 10, ac: 12, attacks: ["Bite"], biomes: [4, 7] },
                "Fox": { type: "Beast", size: "Small", cr: 0.25, hp: 5, ac: 13, attacks: ["Nibble"], biomes: [3, 5, 4] },
                "Hyena": { type: "Beast", size: "Medium", cr: 1, hp: 15, ac: 12, attacks: ["Crushing Jaw"], biomes: [8] },
                "Jackal": { type: "Beast", size: "Small", cr: 0.25, hp: 8, ac: 12, attacks: ["Bite"], biomes: [7, 8] },
                "Dingo": { type: "Beast", size: "Medium", cr: 0.5, hp: 12, ac: 12, attacks: ["Bite"], biomes: [9, 7] },
                "Dhole": { type: "Beast", size: "Medium", cr: 0.5, hp: 11, ac: 13, attacks: ["Bite", "Pounce"], biomes: [5, 9] },
                "Mastiff": { type: "Beast", size: "Medium", cr: 0.5, hp: 14, ac: 11, attacks: ["Crushing Jaw"], biomes: [1] },
                "Greyhound": { type: "Beast", size: "Medium", cr: 0.25, hp: 8, ac: 14, attacks: ["Bite"], biomes: [1] },
                "Bulldog": { type: "Beast", size: "Small", cr: 0.25, hp: 10, ac: 11, attacks: ["Bite"], biomes: [1] },
                "Terrier": { type: "Beast", size: "Small", cr: 0.125, hp: 5, ac: 12, attacks: ["Nibble", "Gnaw"], biomes: [1] },
                "Hound": { type: "Beast", size: "Medium", cr: 0.25, hp: 10, ac: 12, attacks: ["Bite"], biomes: [1] },
                "Pug": { type: "Beast", size: "Tiny", cr: 0.125, hp: 4, ac: 10, attacks: ["Nibble"], biomes: [1] },
                "Husky": { type: "Beast", size: "Medium", cr: 0.5, hp: 12, ac: 12, attacks: ["Bite"], biomes: [2, 1] },
                "Dalmatian": { type: "Beast", size: "Medium", cr: 0.25, hp: 10, ac: 12, attacks: ["Bite"], biomes: [1] },
                "Corgi": { type: "Beast", size: "Small", cr: 0.125, hp: 6, ac: 11, attacks: ["Nibble"], biomes: [1] },
                "Akita": { type: "Beast", size: "Medium", cr: 0.5, hp: 13, ac: 13, attacks: ["Bite"], biomes: [1, 3] },
                "Shiba": { type: "Beast", size: "Small", cr: 0.25, hp: 7, ac: 13, attacks: ["Bite"], biomes: [1] },
                "Lycaon": { type: "Beast", size: "Medium", cr: 1, hp: 14, ac: 13, attacks: ["Bite"], biomes: [8] }
            },
            "Felines": {
                "Lion": { type: "Beast", size: "Large", cr: 3, hp: 32, ac: 13, attacks: ["Claw", "Bite"], biomes: [8] },
                "Tiger": { type: "Beast", size: "Large", cr: 4, hp: 45, ac: 12, attacks: ["Claw", "Bite", "Pounce"], biomes: [9, 5] },
                "Panther": { type: "Beast", size: "Medium", cr: 2, hp: 25, ac: 14, attacks: ["Claw", "Bite"], biomes: [9, 5] },
                "Cheetah": { type: "Beast", size: "Medium", cr: 2, hp: 20, ac: 15, attacks: ["Bite", "Claw"], biomes: [8] },
                "Bobcat": { type: "Beast", size: "Small", cr: 0.5, hp: 10, ac: 13, attacks: ["Claw"], biomes: [5, 2] },
                "Lynx": { type: "Beast", size: "Medium", cr: 1, hp: 15, ac: 13, attacks: ["Claw"], biomes: [2, 3] },
                "Jaguar": { type: "Beast", size: "Large", cr: 3, hp: 40, ac: 14, attacks: ["Crushing Jaw", "Claw"], biomes: [9] },
                "Leopard": { type: "Beast", size: "Medium", cr: 2, hp: 28, ac: 14, attacks: ["Claw", "Pounce"], biomes: [8, 9] },
                "Ocelot": { type: "Beast", size: "Small", cr: 0.5, hp: 12, ac: 14, attacks: ["Claw", "Bite"], biomes: [9] },
                "Puma": { type: "Beast", size: "Medium", cr: 1, hp: 22, ac: 13, attacks: ["Pounce", "Claw"], biomes: [3, 5] },
                "Cougar": { type: "Beast", size: "Medium", cr: 1, hp: 22, ac: 13, attacks: ["Pounce", "Claw"], biomes: [4, 3] },
                "Caracal": { type: "Beast", size: "Small", cr: 0.5, hp: 10, ac: 15, attacks: ["Claw", "Pounce"], biomes: [7, 8] },
                "Serval": { type: "Beast", size: "Small", cr: 0.5, hp: 9, ac: 14, attacks: ["Claw"], biomes: [8] },
                "Margay": { type: "Beast", size: "Small", cr: 0.25, hp: 7, ac: 14, attacks: ["Claw"], biomes: [9] },
                "Sphinx": { type: "Beast", size: "Tiny", cr: 0.125, hp: 3, ac: 11, attacks: ["Scratch"], biomes: [1] },
                "Siamese": { type: "Beast", size: "Tiny", cr: 0.125, hp: 3, ac: 12, attacks: ["Scratch"], biomes: [1] },
                "Persian": { type: "Beast", size: "Tiny", cr: 0.125, hp: 4, ac: 10, attacks: ["Scratch"], biomes: [1] },
                "Bengal": { type: "Beast", size: "Tiny", cr: 0.25, hp: 5, ac: 13, attacks: ["Claw", "Bite"], biomes: [1] },
                "Savannah": { type: "Beast", size: "Small", cr: 0.25, hp: 6, ac: 13, attacks: ["Claw", "Pounce"], biomes: [1] },
                "Liger": { type: "Beast", size: "Large", cr: 4, hp: 50, ac: 12, attacks: ["Claw", "Slam"], biomes: [1] },
                "Smilodon": { type: "Beast", size: "Large", cr: 5, hp: 55, ac: 13, attacks: ["Serrated Bite", "Pounce"], biomes: [2, 3] }
            },
            "Ursines": {
                "Bear": { type: "Beast", size: "Large", cr: 2, hp: 30, ac: 12, attacks: ["Claw", "Bite"], biomes: [5, 3] },
                "Panda": { type: "Beast", size: "Medium", cr: 1, hp: 35, ac: 11, attacks: ["Bite", "Slam"], biomes: [5] },
                "Grizzly": { type: "Beast", size: "Large", cr: 4, hp: 50, ac: 13, attacks: ["Claw", "Bite", "Body Slam"], biomes: [3, 2] },
                "Kodiak": { type: "Beast", size: "Large", cr: 5, hp: 60, ac: 13, attacks: ["Claw", "Crushing Jaw"], biomes: [2, 3] },
                "Sunbear": { type: "Beast", size: "Medium", cr: 1, hp: 25, ac: 12, attacks: ["Claw", "Bite"], biomes: [9] },
                "Slothbear": { type: "Beast", size: "Medium", cr: 2, hp: 30, ac: 13, attacks: ["Claw", "Slam"], biomes: [9, 5] },
                "Tremarctos": { type: "Beast", size: "Medium", cr: 2, hp: 28, ac: 12, attacks: ["Claw", "Bite"], biomes: [3, 9] },
                "Cavebear": { type: "Beast", size: "Large", cr: 5, hp: 65, ac: 14, attacks: ["Claw", "Body Slam"], biomes: [2, 11] },
                "Baribal": { type: "Beast", size: "Medium", cr: 2, hp: 30, ac: 12, attacks: ["Claw", "Bite"], biomes: [5] },
                "Kermode": { type: "Beast", size: "Medium", cr: 2, hp: 30, ac: 12, attacks: ["Claw", "Bite"], biomes: [5] },
                "Ussuri": { type: "Beast", size: "Large", cr: 3, hp: 45, ac: 13, attacks: ["Claw", "Bite"], biomes: [3, 5] },
                "Arctodus": { type: "Beast", size: "Huge", cr: 6, hp: 80, ac: 14, attacks: ["Claw", "Crushing Jaw", "Body Slam"], biomes: [4, 2] }
            },
            "Ungulates": {
                "Deer": { type: "Beast", size: "Medium", cr: 0.25, hp: 12, ac: 13, attacks: ["Kick"], biomes: [5, 4] },
                "Elk": { type: "Beast", size: "Large", cr: 2, hp: 30, ac: 12, attacks: ["Antler Toss", "Kick"], biomes: [5, 2] },
                "Moose": { type: "Beast", size: "Large", cr: 3, hp: 45, ac: 11, attacks: ["Gore", "Trample"], biomes: [3, 2] },
                "Boar": { type: "Beast", size: "Medium", cr: 2, hp: 20, ac: 13, attacks: ["Tusk Slash", "Gore"], biomes: [5, 6] },
                "Bison": { type: "Beast", size: "Large", cr: 3, hp: 40, ac: 13, attacks: ["Gore", "Trample"], biomes: [4] },
                "Rhino": { type: "Beast", size: "Large", cr: 5, hp: 50, ac: 16, attacks: ["Rhino Charge", "Horn Ram"], biomes: [8] },
                "Hippo": { type: "Beast", size: "Large", cr: 5, hp: 55, ac: 14, attacks: ["Crushing Jaw", "Trample"], biomes: [8, 6] },
                "Camel": { type: "Beast", size: "Large", cr: 1, hp: 25, ac: 11, attacks: ["Bite", "Venom Spit"], biomes: [7] },
                "Giraffe": { type: "Beast", size: "Huge", cr: 2, hp: 40, ac: 12, attacks: ["Hind Kick", "Slam"], biomes: [8] },
                "Elephant": { type: "Beast", size: "Huge", cr: 6, hp: 70, ac: 15, attacks: ["Trample", "Tusk Slash", "Slam"], biomes: [8, 9] },
                "Sheep": { type: "Beast", size: "Small", cr: 0.125, hp: 6, ac: 10, attacks: ["Headbutt"], biomes: [4, 1] },
                "Goat": { type: "Beast", size: "Small", cr: 0.125, hp: 7, ac: 11, attacks: ["Horn Ram"], biomes: [3, 1] },
                "Cow": { type: "Beast", size: "Large", cr: 0.25, hp: 15, ac: 10, attacks: ["Kick"], biomes: [4, 1] },
                "Bull": { type: "Beast", size: "Large", cr: 1, hp: 25, ac: 12, attacks: ["Gore", "Trample"], biomes: [4, 1] },
                "Horse": { type: "Beast", size: "Large", cr: 0.5, hp: 19, ac: 11, attacks: ["Hoof Stomp", "Hind Kick"], biomes: [4, 1] },
                "Zebra": { type: "Beast", size: "Large", cr: 0.5, hp: 19, ac: 12, attacks: ["Hind Kick", "Bite"], biomes: [8] },
                "Donkey": { type: "Beast", size: "Medium", cr: 0.25, hp: 13, ac: 11, attacks: ["Hind Kick"], biomes: [4, 7] },
                "Antelope": { type: "Beast", size: "Medium", cr: 0.25, hp: 10, ac: 14, attacks: ["Kick"], biomes: [8] },
                "Gazelle": { type: "Beast", size: "Small", cr: 0.125, hp: 8, ac: 15, attacks: ["Kick"], biomes: [8, 7] },
                "Wildebeest": { type: "Beast", size: "Large", cr: 1, hp: 25, ac: 12, attacks: ["Gore", "Trample"], biomes: [8] },
                "Caribou": { type: "Beast", size: "Large", cr: 1, hp: 22, ac: 12, attacks: ["Antler Toss", "Kick"], biomes: [2] },
                "Llama": { type: "Beast", size: "Medium", cr: 0.25, hp: 12, ac: 11, attacks: ["Venom Spit", "Kick"], biomes: [3] },
                "Alpaca": { type: "Beast", size: "Medium", cr: 0.125, hp: 10, ac: 11, attacks: ["Venom Spit"], biomes: [3] },
                "Warthog": { type: "Beast", size: "Medium", cr: 1, hp: 18, ac: 13, attacks: ["Tusk Slash"], biomes: [8] },
                "Ibex": { type: "Beast", size: "Medium", cr: 0.5, hp: 15, ac: 13, attacks: ["Horn Ram"], biomes: [3] }
            },
            "Reptiles": {
                "Crocodile": { type: "Beast", size: "Large", cr: 3, hp: 35, ac: 14, attacks: ["Death Roll", "Tail Whip"], biomes: [6, 8] },
                "Alligator": { type: "Beast", size: "Large", cr: 2, hp: 30, ac: 14, attacks: ["Bite", "Tail Whip"], biomes: [6] },
                "Caiman": { type: "Beast", size: "Medium", cr: 1, hp: 18, ac: 13, attacks: ["Bite"], biomes: [9, 6] },
                "Gharial": { type: "Beast", size: "Large", cr: 1, hp: 25, ac: 12, attacks: ["Bite", "Tail Whip"], biomes: [6] },
                "Komodo": { type: "Beast", size: "Medium", cr: 2, hp: 25, ac: 13, attacks: ["Toxic Chomp", "Claw"], biomes: [9] },
                "Cobra": { type: "Beast", size: "Small", cr: 1, hp: 10, ac: 14, attacks: ["Venomous Bite", "Venom Spit"], biomes: [9, 8] },
                "Python": { type: "Beast", size: "Large", cr: 2, hp: 20, ac: 12, attacks: ["Python Squeeze", "Bite"], biomes: [9, 6] },
                "Turtle": { type: "Beast", size: "Small", cr: 0, hp: 10, ac: 16, attacks: ["Bite"], biomes: [6, 0] },
                "Tortoise": { type: "Beast", size: "Medium", cr: 0.125, hp: 15, ac: 17, attacks: ["Bite"], biomes: [7, 8] },
                "Iguana": { type: "Beast", size: "Small", cr: 0.25, hp: 8, ac: 13, attacks: ["Bite", "Tail Whip"], biomes: [9, 5] },
                "Gecko": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 12, attacks: ["Nibble"], biomes: [9, 7] },
                "Chameleon": { type: "Beast", size: "Tiny", cr: 0, hp: 3, ac: 11, attacks: ["Bite"], biomes: [9, 5] },
                "Skink": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 12, attacks: ["Nibble"], biomes: [5, 7] },
                "Monitor": { type: "Beast", size: "Medium", cr: 1, hp: 18, ac: 13, attacks: ["Bite", "Claw"], biomes: [7, 8, 9] },
                "Viper": { type: "Beast", size: "Tiny", cr: 0.5, hp: 5, ac: 13, attacks: ["Venomous Bite"], biomes: [4, 5, 7] },
                "Boa": { type: "Beast", size: "Medium", cr: 1, hp: 16, ac: 12, attacks: ["Python Squeeze"], biomes: [9] },
                "Anaconda": { type: "Beast", size: "Large", cr: 3, hp: 40, ac: 13, attacks: ["Python Squeeze", "Bite"], biomes: [9, 6] },
                "Mamba": { type: "Beast", size: "Small", cr: 2, hp: 12, ac: 16, attacks: ["Neurotoxic Sting"], biomes: [8] },
                "Adder": { type: "Beast", size: "Tiny", cr: 0.25, hp: 4, ac: 12, attacks: ["Venomous Bite"], biomes: [3, 4] },
                "Rattlesnake": { type: "Beast", size: "Small", cr: 0.5, hp: 8, ac: 13, attacks: ["Venomous Bite"], biomes: [7, 4] },
                "Taipan": { type: "Beast", size: "Medium", cr: 3, hp: 15, ac: 15, attacks: ["Neurotoxic Sting"], biomes: [7, 9] },
                "Krait": { type: "Beast", size: "Tiny", cr: 1, hp: 5, ac: 14, attacks: ["Neurotoxic Sting"], biomes: [9] },
                "Copperhead": { type: "Beast", size: "Small", cr: 0.5, hp: 9, ac: 12, attacks: ["Venomous Bite"], biomes: [5] },
                "Cottonmouth": { type: "Beast", size: "Small", cr: 0.5, hp: 10, ac: 12, attacks: ["Venomous Bite"], biomes: [6] },
                "Basilisk": { type: "Beast", size: "Small", cr: 0.125, hp: 5, ac: 13, attacks: ["Bite"], biomes: [9, 6] }
            },
            "Birds": {
                "Eagle": { type: "Beast", size: "Small", cr: 1, hp: 10, ac: 13, attacks: ["Talon", "Peck"], biomes: [2, 3, 4] },
                "Hawk": { type: "Beast", size: "Tiny", cr: 0.5, hp: 5, ac: 13, attacks: ["Talon", "Dive Bomb"], biomes: [4, 5] },
                "Vulture": { type: "Beast", size: "Medium", cr: 1, hp: 12, ac: 11, attacks: ["Hooked Beak"], biomes: [7, 8] },
                "Ostrich": { type: "Beast", size: "Large", cr: 1, hp: 20, ac: 11, attacks: ["Kick"], biomes: [8] },
                "Cassowary": { type: "Beast", size: "Medium", cr: 2, hp: 18, ac: 12, attacks: ["Eviscerate", "Kick"], biomes: [9] },
                "Owl": { type: "Beast", size: "Tiny", cr: 0.5, hp: 6, ac: 13, attacks: ["Talon", "Dive Bomb"], biomes: [5, 3] },
                "Swan": { type: "Beast", size: "Small", cr: 0.25, hp: 8, ac: 11, attacks: ["Swan Strike", "Wing Buffet"], biomes: [6, 4] },
                "Falcon": { type: "Beast", size: "Tiny", cr: 0.5, hp: 4, ac: 15, attacks: ["Dive Bomb", "Talon"], biomes: [4, 3] },
                "Buzzard": { type: "Beast", size: "Small", cr: 0.25, hp: 7, ac: 12, attacks: ["Talon"], biomes: [4, 5] },
                "Kite": { type: "Beast", size: "Tiny", cr: 0.125, hp: 3, ac: 13, attacks: ["Talon"], biomes: [4, 5] },
                "Osprey": { type: "Beast", size: "Small", cr: 0.5, hp: 8, ac: 13, attacks: ["Talon", "Dive Bomb"], biomes: [6, 10] },
                "Condor": { type: "Beast", size: "Medium", cr: 1, hp: 15, ac: 12, attacks: ["Hooked Beak", "Talon"], biomes: [3] },
                "Pelican": { type: "Beast", size: "Small", cr: 0.25, hp: 9, ac: 11, attacks: ["Bill Thrust", "Peck"], biomes: [10, 6] },
                "Albatross": { type: "Beast", size: "Medium", cr: 0.5, hp: 12, ac: 12, attacks: ["Wing Buffet", "Peck"], biomes: [10] },
                "Gull": { type: "Beast", size: "Tiny", cr: 0.125, hp: 3, ac: 12, attacks: ["Peck"], biomes: [10, 1] },
                "Penguin": { type: "Beast", size: "Small", cr: 0.125, hp: 7, ac: 12, attacks: ["Peck", "Fin Slash"], biomes: [2] },
                "Heron": { type: "Beast", size: "Small", cr: 0.25, hp: 6, ac: 12, attacks: ["Bill Thrust"], biomes: [6] },
                "Stork": { type: "Beast", size: "Small", cr: 0.25, hp: 7, ac: 12, attacks: ["Bill Thrust"], biomes: [6] },
                "Crane": { type: "Beast", size: "Medium", cr: 0.25, hp: 9, ac: 12, attacks: ["Bill Thrust", "Wing Buffet"], biomes: [6, 4] },
                "Flamingo": { type: "Beast", size: "Small", cr: 0.125, hp: 6, ac: 11, attacks: ["Peck"], biomes: [6] },
                "Parrot": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 12, attacks: ["Peck"], biomes: [9] },
                "Macaw": { type: "Beast", size: "Tiny", cr: 0.125, hp: 4, ac: 12, attacks: ["Macaw Crush"], biomes: [9] },
                "Toucan": { type: "Beast", size: "Tiny", cr: 0.125, hp: 3, ac: 11, attacks: ["Bill Thrust"], biomes: [9] },
                "Woodpecker": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 13, attacks: ["Peck"], biomes: [5] },
                "Crow": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 12, attacks: ["Peck"], biomes: [4, 1] },
                "Raven": { type: "Beast", size: "Tiny", cr: 0.125, hp: 3, ac: 12, attacks: ["Peck", "Talon"], biomes: [3, 5] },
                "Pigeon": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 11, attacks: ["Peck"], biomes: [1] }
            },
            "Insects": {
                "Scorpion": { type: "Beast", size: "Tiny", cr: 0.125, hp: 2, ac: 12, attacks: ["Sting"], biomes: [7, 9] },
                "Spider": { type: "Beast", size: "Tiny", cr: 0.125, hp: 1, ac: 12, attacks: ["Venomous Bite"], biomes: [5, 11] },
                "Ant": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 10, attacks: ["Nibble"], biomes: [4, 7] },
                "Wasp": { type: "Beast", size: "Tiny", cr: 0.125, hp: 2, ac: 13, attacks: ["Sting"], biomes: [5, 9] },
                "Centipede": { type: "Beast", size: "Tiny", cr: 0.125, hp: 2, ac: 11, attacks: ["Venomous Bite"], biomes: [11, 9] },
                "Beetle": { type: "Beast", size: "Tiny", cr: 0, hp: 3, ac: 14, attacks: ["Mandible Pinch"], biomes: [5, 9] },
                "Mantis": { type: "Beast", size: "Tiny", cr: 0.125, hp: 2, ac: 12, attacks: ["Mantis Scythe"], biomes: [9, 5] },
                "Bee": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 11, attacks: ["Sting"], biomes: [4, 5] },
                "Hornet": { type: "Beast", size: "Tiny", cr: 0.25, hp: 3, ac: 13, attacks: ["Sting"], biomes: [5] },
                "Locust": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 11, attacks: ["Nibble"], biomes: [7, 4] },
                "Grasshopper": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 12, attacks: ["Kick"], biomes: [4] },
                "Moth": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 10, attacks: ["Toxic Spores"], biomes: [5, 9] },
                "Butterfly": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 11, attacks: ["None"], biomes: [5, 9] },
                "Dragonfly": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 14, attacks: ["Bite"], biomes: [6] },
                "Mosquito": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 12, attacks: ["Vampiric Drain"], biomes: [6, 9] },
                "Tick": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 10, attacks: ["Leech Latch"], biomes: [5, 4] },
                "Termite": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 10, attacks: ["Mandible Pinch"], biomes: [9, 8] },
                "Cockroach": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 13, attacks: ["Nibble"], biomes: [1, 11] },
                "Silverfish": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 11, attacks: ["Nibble"], biomes: [11] },
                "Firefly": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 11, attacks: ["Thermal Flash"], biomes: [5] },
                "Millipede": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 12, attacks: ["Venom Spit"], biomes: [5, 9] },
                "Tarantula": { type: "Beast", size: "Tiny", cr: 0.25, hp: 4, ac: 11, attacks: ["Venomous Bite", "Quill Shoot"], biomes: [7, 9] }
            },
            "Primates": {
                "Gorilla": { type: "Beast", size: "Large", cr: 3, hp: 45, ac: 13, attacks: ["Slam", "Crushing Jaw"], biomes: [9] },
                "Chimpanzee": { type: "Beast", size: "Medium", cr: 1, hp: 20, ac: 12, attacks: ["Bite", "Scratch"], biomes: [9] },
                "Baboon": { type: "Beast", size: "Medium", cr: 1, hp: 18, ac: 12, attacks: ["Bite", "Claw"], biomes: [8, 9] },
                "Orangutan": { type: "Beast", size: "Medium", cr: 2, hp: 30, ac: 11, attacks: ["Slam", "Bite"], biomes: [9] },
                "Bonobo": { type: "Beast", size: "Medium", cr: 0.5, hp: 15, ac: 12, attacks: ["Bite", "Scratch"], biomes: [9] },
                "Gibbon": { type: "Beast", size: "Small", cr: 0.5, hp: 12, ac: 14, attacks: ["Scratch"], biomes: [9] },
                "Macaque": { type: "Beast", size: "Small", cr: 0.5, hp: 10, ac: 13, attacks: ["Bite", "Scratch"], biomes: [9, 5] },
                "Mandrill": { type: "Beast", size: "Medium", cr: 1, hp: 18, ac: 13, attacks: ["Bite", "Claw"], biomes: [9] },
                "Lemur": { type: "Beast", size: "Small", cr: 0.125, hp: 6, ac: 12, attacks: ["Bite"], biomes: [9] },
                "Tarsier": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 13, attacks: ["Bite"], biomes: [9] },
                "Loris": { type: "Beast", size: "Tiny", cr: 0.125, hp: 4, ac: 11, attacks: ["Toxic Chomp"], biomes: [9] },
                "Marmoset": { type: "Beast", size: "Tiny", cr: 0, hp: 3, ac: 12, attacks: ["Scratch"], biomes: [9] },
                "Tamarin": { type: "Beast", size: "Tiny", cr: 0, hp: 3, ac: 12, attacks: ["Scratch"], biomes: [9] },
                "Capuchin": { type: "Beast", size: "Small", cr: 0.125, hp: 5, ac: 13, attacks: ["Scratch"], biomes: [9] },
                "Howler": { type: "Beast", size: "Small", cr: 0.25, hp: 8, ac: 11, attacks: ["Sonic Snap", "Bite"], biomes: [9] },
                "Colobus": { type: "Beast", size: "Small", cr: 0.125, hp: 6, ac: 12, attacks: ["Bite"], biomes: [9] },
                "Langur": { type: "Beast", size: "Small", cr: 0.25, hp: 7, ac: 12, attacks: ["Bite"], biomes: [9, 5] },
                "Proboscis": { type: "Beast", size: "Medium", cr: 0.25, hp: 12, ac: 11, attacks: ["Bite"], biomes: [9, 6] },
                "Aye-Aye": { type: "Beast", size: "Tiny", cr: 0.125, hp: 4, ac: 12, attacks: ["Scratch"], biomes: [9] },
                "Indri": { type: "Beast", size: "Small", cr: 0.25, hp: 8, ac: 12, attacks: ["Bite"], biomes: [9] }
            },
            "Marine Life": {
                "Shark": { type: "Beast", size: "Large", cr: 2, hp: 30, ac: 13, attacks: ["Serrated Bite", "Fin Slash"], biomes: [10] },
                "Mako": { type: "Beast", size: "Large", cr: 3, hp: 35, ac: 14, attacks: ["Serrated Bite"], biomes: [10] },
                "Hammerhead": { type: "Beast", size: "Large", cr: 3, hp: 40, ac: 13, attacks: ["Slam", "Serrated Bite"], biomes: [10] },
                "Orca": { type: "Beast", size: "Huge", cr: 5, hp: 70, ac: 15, attacks: ["Crushing Jaw", "Fluke Smash"], biomes: [10, 1] },
                "Squid": { type: "Beast", size: "Small", cr: 0.25, hp: 8, ac: 11, attacks: ["Tentacle Lash", "Ink Cloud"], biomes: [10] },
                "Eel": { type: "Beast", size: "Small", cr: 0.25, hp: 6, ac: 12, attacks: ["Bite"], biomes: [10, 6] },
                "Moray": { type: "Beast", size: "Medium", cr: 1, hp: 18, ac: 13, attacks: ["Trap-Jaw Strike"], biomes: [10] },
                "Crab": { type: "Beast", size: "Tiny", cr: 0.125, hp: 4, ac: 14, attacks: ["Crab Pinch"], biomes: [10, 6] },
                "Ray": { type: "Beast", size: "Medium", cr: 0.5, hp: 15, ac: 12, attacks: ["Barbed Sting"], biomes: [10] },
                "Dolphin": { type: "Beast", size: "Medium", cr: 1, hp: 20, ac: 13, attacks: ["Slam", "Bite"], biomes: [10] },
                "Whale": { type: "Beast", size: "Huge", cr: 4, hp: 80, ac: 13, attacks: ["Fluke Smash", "Slam"], biomes: [10] },
                "Seal": { type: "Beast", size: "Medium", cr: 0.5, hp: 16, ac: 11, attacks: ["Bite", "Slam"], biomes: [10, 2] },
                "Walrus": { type: "Beast", size: "Large", cr: 2, hp: 40, ac: 12, attacks: ["Tusk Slash", "Slam"], biomes: [10, 2] },
                "Manatee": { type: "Beast", size: "Large", cr: 0.5, hp: 35, ac: 10, attacks: ["Fluke Smash"], biomes: [10, 6] },
                "Octopus": { type: "Beast", size: "Small", cr: 0.5, hp: 12, ac: 12, attacks: ["Tentacle Lash", "Ink Cloud"], biomes: [10] },
                "Cuttlefish": { type: "Beast", size: "Tiny", cr: 0.125, hp: 5, ac: 11, attacks: ["Ink Cloud"], biomes: [10] },
                "Lobster": { type: "Beast", size: "Tiny", cr: 0.125, hp: 6, ac: 15, attacks: ["Pincer Snipe"], biomes: [10] },
                "Shrimp": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 10, attacks: ["Sonic Snap"], biomes: [10] },
                "Jellyfish": { type: "Beast", size: "Tiny", cr: 0.25, hp: 2, ac: 10, attacks: ["Nematocyst Lash"], biomes: [10] },
                "Seahorse": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 11, attacks: ["Suction Grip"], biomes: [10] },
                "Swordfish": { type: "Beast", size: "Large", cr: 2, hp: 25, ac: 14, attacks: ["Sword-Bill Slash", "Piercing"], biomes: [10] }
            },
            "Rodents & Mustelids": {
                "Wolverine": { type: "Beast", size: "Medium", cr: 2, hp: 28, ac: 14, attacks: ["Eviscerate", "Bite"], biomes: [2, 3] },
                "Badger": { type: "Beast", size: "Small", cr: 1, hp: 18, ac: 13, attacks: ["Claw", "Bite"], biomes: [4, 5] },
                "Rat": { type: "Beast", size: "Tiny", cr: 0.125, hp: 2, ac: 10, attacks: ["Bite"], biomes: [11, 4] },
                "Porcupine": { type: "Beast", size: "Small", cr: 0.5, hp: 12, ac: 12, attacks: ["Quill Shoot", "Bite"], biomes: [5, 4] },
                "Mouse": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 10, attacks: ["Nibble"], biomes: [1, 4] },
                "Vole": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 10, attacks: ["Nibble"], biomes: [4, 5] },
                "Lemming": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 10, attacks: ["Nibble"], biomes: [2] },
                "Hamster": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 10, attacks: ["Nibble"], biomes: [7] },
                "Gerbil": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 11, attacks: ["Nibble"], biomes: [7] },
                "Guinea Pig": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 10, attacks: ["Nibble"], biomes: [3] },
                "Chinchilla": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 12, attacks: ["Nibble"], biomes: [3] },
                "Capybara": { type: "Beast", size: "Medium", cr: 0.125, hp: 10, ac: 10, attacks: ["Bite"], biomes: [9, 6] },
                "Beaver": { type: "Beast", size: "Small", cr: 0.25, hp: 8, ac: 11, attacks: ["Bite", "Tail Whip"], biomes: [5, 6] },
                "Squirrel": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 13, attacks: ["Bite"], biomes: [5, 1] },
                "Chipmunk": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 13, attacks: ["Nibble"], biomes: [5] },
                "Marmot": { type: "Beast", size: "Small", cr: 0.125, hp: 5, ac: 11, attacks: ["Bite"], biomes: [3] },
                "Ferret": { type: "Beast", size: "Tiny", cr: 0.125, hp: 3, ac: 12, attacks: ["Bite"], biomes: [4] },
                "Weasel": { type: "Beast", size: "Tiny", cr: 0.125, hp: 3, ac: 13, attacks: ["Bite"], biomes: [5, 4] },
                "Otter": { type: "Beast", size: "Small", cr: 0.25, hp: 7, ac: 13, attacks: ["Bite", "Claw"], biomes: [6, 10] },
                "Skunk": { type: "Beast", size: "Small", cr: 0.25, hp: 6, ac: 11, attacks: ["Skunk Musk", "Bite"], biomes: [5, 4] },
                "Raccoon": { type: "Beast", size: "Small", cr: 0.25, hp: 8, ac: 12, attacks: ["Claw", "Bite"], biomes: [5, 1] },
                "Mongoose": { type: "Beast", size: "Small", cr: 0.5, hp: 9, ac: 14, attacks: ["Bite", "Pounce"], biomes: [8, 9] },
                "Meerkat": { type: "Beast", size: "Tiny", cr: 0.125, hp: 4, ac: 12, attacks: ["Bite"], biomes: [8, 7] }
            },
            "Marsupials": {
                "Kangaroo": { type: "Beast", size: "Medium", cr: 1, hp: 22, ac: 12, attacks: ["Kangaroo Box", "Hind Kick"], biomes: [7, 8] },
                "Devil": { type: "Beast", size: "Small", cr: 1, hp: 16, ac: 12, attacks: ["Crushing Jaw", "Claw"], biomes: [5, 9] },
                "Wallaby": { type: "Beast", size: "Small", cr: 0.25, hp: 10, ac: 12, attacks: ["Hind Kick"], biomes: [7, 5] },
                "Quokka": { type: "Beast", size: "Tiny", cr: 0, hp: 3, ac: 10, attacks: ["Nibble"], biomes: [5] },
                "Bettong": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 11, attacks: ["Nibble"], biomes: [5] },
                "Possum": { type: "Beast", size: "Tiny", cr: 0.125, hp: 4, ac: 11, attacks: ["Bite", "Claw"], biomes: [5, 1] },
                "Glider": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 12, attacks: ["Scratch"], biomes: [9] },
                "Wombat": { type: "Beast", size: "Medium", cr: 0.5, hp: 18, ac: 13, attacks: ["Slam", "Bite"], biomes: [5, 3] },
                "Koala": { type: "Beast", size: "Small", cr: 0.125, hp: 8, ac: 10, attacks: ["Scratch"], biomes: [5] },
                "Bandicoot": { type: "Beast", size: "Tiny", cr: 0, hp: 3, ac: 11, attacks: ["Bite"], biomes: [5] },
                "Bilby": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 11, attacks: ["Nibble"], biomes: [7] },
                "Dunnart": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 12, attacks: ["Bite"], biomes: [7] },
                "Quoll": { type: "Beast", size: "Tiny", cr: 0.25, hp: 5, ac: 13, attacks: ["Bite", "Claw"], biomes: [5, 9] },
                "Numbat": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 12, attacks: ["Claw"], biomes: [5] },
                "Thylacine": { type: "Beast", size: "Medium", cr: 1, hp: 16, ac: 13, attacks: ["Bite", "Crushing Jaw"], biomes: [5] },
                "Opossum": { type: "Beast", size: "Small", cr: 0.125, hp: 6, ac: 10, attacks: ["Bite"], biomes: [5, 1] }
            },
            "Amphibians": {
                "Toad": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 10, attacks: ["Bite"], biomes: [6, 9] },
                "Frog": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 11, attacks: ["Suction Grip"], biomes: [6, 9] },
                "Dartfrog": { type: "Beast", size: "Tiny", cr: 0.25, hp: 1, ac: 14, attacks: ["Toxic Spores"], biomes: [9] },
                "Salamander": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 11, attacks: ["Bite"], biomes: [6, 5] },
                "Newt": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 11, attacks: ["Bite", "Toxic Spores"], biomes: [6, 5] },
                "Caecilian": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 10, attacks: ["Bite"], biomes: [11, 9] },
                "Axolotl": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 10, attacks: ["Bite"], biomes: [6] },
                "Mudpuppy": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 10, attacks: ["Bite"], biomes: [6] },
                "Hellbender": { type: "Beast", size: "Small", cr: 0.125, hp: 5, ac: 10, attacks: ["Bite", "Slam"], biomes: [6] },
                "Siren": { type: "Beast", size: "Small", cr: 0.125, hp: 4, ac: 11, attacks: ["Bite"], biomes: [6, 9] },
                "Bullfrog": { type: "Beast", size: "Tiny", cr: 0.125, hp: 3, ac: 10, attacks: ["Bite", "Suction Grip"], biomes: [6] },
                "Treefrog": { type: "Beast", size: "Tiny", cr: 0, hp: 1, ac: 13, attacks: ["None"], biomes: [9] },
                "Spadefoot": { type: "Beast", size: "Tiny", cr: 0, hp: 2, ac: 10, attacks: ["Bite"], biomes: [4, 7] },
                "Bombina": { type: "Beast", size: "Tiny", cr: 0.125, hp: 1, ac: 11, attacks: ["Toxic Spores"], biomes: [6, 5] },
                "Mantella": { type: "Beast", size: "Tiny", cr: 0.125, hp: 1, ac: 13, attacks: ["Toxic Spores"], biomes: [9] }
            }
        };

        const SIZE_AND_AGE_MODIFIERS = {
            "Infant": { crMult: 0.1, hpMult: 0.2, acMod: -3, sizeStep: -2, addedAttack: null },
            "Puny": { crMult: 0.5, hpMult: 0.5, acMod: -2, sizeStep: -1, addedAttack: null },
            "Young": { crMult: 0.75, hpMult: 0.7, acMod: -1, sizeStep: -1, addedAttack: null },
            "Standard": { crMult: 1.0, hpMult: 1.0, acMod: 0, sizeStep: 0, addedAttack: null },
            "Overgrown": { crMult: 1.5, hpMult: 1.5, acMod: 0, sizeStep: +1, addedAttack: null },
            "Giant": { crMult: 2.0, hpMult: 2.5, acMod: +1, sizeStep: +1, addedAttack: "Slam" },
            "Colossal": { crMult: 4.0, hpMult: 4.0, acMod: +2, sizeStep: +2, addedAttack: "Body Slam" },
            "Titanic": { crMult: 8.0, hpMult: 8.0, acMod: +4, sizeStep: +3, addedAttack: "Trample" }
        };

        const CONDITION_MODIFIERS = {
            "Healthy": { crMult: 1.0, hpMult: 1.0, acMod: 0, addedAttack: null, behavior: "Normal" },
            "Starving": { crMult: 0.7, hpMult: 0.6, acMod: -1, addedAttack: "Bite", behavior: "Aggressive" },
            "Rabid": { crMult: 1.2, hpMult: 0.8, acMod: -2, addedAttack: "Toxic Chomp", behavior: "Reckless" },
            "Putrid": { crMult: 1.3, hpMult: 1.2, acMod: -1, addedAttack: "Toxic Spores", behavior: "Sluggish" },
            "Enraged": { crMult: 1.5, hpMult: 1.0, acMod: -2, addedAttack: "Slam", behavior: "Reckless" },
            "Exhausted": { crMult: 0.5, hpMult: 0.8, acMod: -2, addedAttack: null, behavior: "Defensive" },
            "Feral": { crMult: 1.2, hpMult: 1.2, acMod: +1, addedAttack: null, behavior: "Aggressive" }
        };

        const BIOLOGICAL_UPGRADES = {
            "None": { crMult: 1.0, hpMult: 1.0, acMod: 0, addedAttack: null },
            "Armored": { crMult: 1.5, hpMult: 1.3, acMod: +4, addedAttack: null },
            "Venomous": { crMult: 1.5, hpMult: 1.0, acMod: 0, addedAttack: "Venomous Bite" },
            "Savage": { crMult: 1.4, hpMult: 1.2, acMod: 0, addedAttack: "Eviscerate" },
            "Dire": { crMult: 2.0, hpMult: 2.0, acMod: +2, addedAttack: "Crushing Jaw" },
            "Alpha": { crMult: 2.5, hpMult: 2.0, acMod: +1, addedAttack: "Throat Crush" },
            "Apex": { crMult: 4.0, hpMult: 3.5, acMod: +3, addedAttack: "Death Roll" },
            "Mutated": { crMult: 2.0, hpMult: 1.5, acMod: +1, addedAttack: "Acid Spray" }
        };

        const PIGMENTATION = {
            "Standard": { stealthMod: 0, flavor: "Typical coloration for its biome." },
            "Melanistic": { stealthMod: +2, flavor: "Pitch black, blending perfectly into the shadows." },
            "Albino": { stealthMod: -2, flavor: "Stark white with red eyes, highly visible but imposing." },
            "Leucistic": { stealthMod: -1, flavor: "Pale and ghostly white, but with normal pigment in the eyes." },
            "Erythristic": { stealthMod: 0, flavor: "Possessing an unusual, vibrant reddish-copper hue." },
            "Xanthic": { stealthMod: -1, flavor: "A striking, unnatural golden-yellow mutation." },
            "Piebald": { stealthMod: 0, flavor: "Large, unpigmented white patches breaking up its base color." }
        };

        const PATTERNS = {
            "None": { stealthMod: 0, flavor: "A solid, unbroken coat or scale pattern." },
            "Mottled": { stealthMod: +1, flavor: "Covered in irregular splotches that break up its outline." },
            "Striped": { stealthMod: +1, flavor: "Bold vertical stripes, ideal for hiding in tall grass." },
            "Spotted": { stealthMod: +1, flavor: "Covered in rosette spots to blend with canopy shadows." },
            "Brindled": { stealthMod: +1, flavor: "Subtle, tiger-like streaks woven through its base color." },
            "Scarred": { stealthMod: 0, flavor: "Criss-crossed with deep, old battle wounds." },
            "Banded": { stealthMod: 0, flavor: "Thick, horizontal rings wrapping around its body or limbs." }
        };

        const PACK_MULTIPLIERS = {
            bounds: [
                { maxCount: 1, multiplier: 1.0 },   // Solo
                { maxCount: 2, multiplier: 1.5 },   // Pair
                { maxCount: 6, multiplier: 2.0 },   // Pack
                { maxCount: 10, multiplier: 2.5 },  // Swarm
                { maxCount: 14, multiplier: 3.0 },  // Horde
                { maxCount: 999, multiplier: 4.0 }  // Plague (Catch-all for 15+)
            ]
        };

        const MAX_PACK_LIMITS = {
            "Tiny": { maxSpawn: 50, clusterType: "Swarm" },
            "Small": { maxSpawn: 20, clusterType: "Pack" },
            "Medium": { maxSpawn: 12, clusterType: "Pack" },
            "Large": { maxSpawn: 6, clusterType: "Pod" },
            "Huge": { maxSpawn: 3, clusterType: "Pair/Trio" },
            "Gargantuan": { maxSpawn: 1, clusterType: "Solo" }
        };

        // --- SUB-COMPONENTS ---

        const CreatureDetailModal = ({ creature, onClose }) => {
            if (!creature) return null;

            // --- CALCULATIONS ---
            const breedingRate = (1.5 / (creature.cr + (creature.sizeIdx * 0.5))).toFixed(3);
            const metabolism = (creature.type === "Undead" || creature.type === "Construct") ? 0 : Math.pow(2, creature.sizeIdx - 4).toFixed(2);
            const meatYield = creature.sizeIdx * 5;
            const boneYield = creature.sizeIdx * 2;
            const hideType = creature.type === "Beast" ? (creature.sizeIdx > 4 ? "Thick Leather" : "Fur/Pelt") : "None";
            const crStyle = getCRColor(creature.cr);

            // Grouped Loot Table
            const groupedLoot = useMemo(() => {
                const groups = {
                    "Skinning": [], "Butchering": [], "Extraction": [], "Sawing": [],
                    "Draining": [], "Plucking": [], "Scraping": [], "General": []
                };

                // 1. Inferred from Attacks (Direct Dictionary Lookup)
                creature.attacks.forEach(atkName => {
                    const atkData = FULL_ATTACK_DATABASE[atkName];
                    if (atkData && atkData.anatomyTag) {
                        const anatomyInfo = ANATOMY_PARTS[atkData.anatomyTag];
                        if (anatomyInfo) {
                            const harvestMethod = anatomyInfo.defaultHarvest;
                            groups[harvestMethod].push({ source: atkData.anatomyTag, drops: anatomyInfo.baseDrops });
                        }
                    }
                });

                // 2. Base Carcass
                groups["Butchering"].push({ source: "Carcass", drops: ["Raw Meat", "Animal Fat", "Bones"] });
                if (hideType !== "None") groups["Skinning"].push({ source: "Carcass", drops: [hideType] });

                // Clean empty groups
                return Object.entries(groups).filter(([_, items]) => items.length > 0);
            }, [creature]);

            const packScenarios = [1, 2, 6, 10, 20].map(count => {
                const mult = PACK_MULTIPLIERS.bounds.find(b => count <= b.maxCount)?.multiplier || 4.0;
                const eCR = (creature.cr * count * mult).toFixed(1);
                return { count, mult, eCR };
            });

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={ onClose }>
                    <div className="bg-slate-900 border border-slate-700 w-full max-w-5xl h-[90vh] overflow-y-auto rounded-lg shadow-2xl flex flex-col" onClick={ e => e.stopPropagation() }>
                        {/* Header */ }
                        <div className="bg-slate-950 p-6 border-b border-slate-800 flex justify-between items-start sticky top-0 z-10">
                            <div>
                                <h2 className="text-3xl font-bold text-white mb-1">{ creature.name }</h2>
                                <div className="flex gap-2 text-sm">
                                    <span className={ `px-2 py-0.5 rounded border font-bold ${crStyle}` }>CR { creature.cr }</span>
                                    <span className="bg-slate-800 text-slate-400 px-2 py-0.5 rounded border border-slate-700">{ creature.type }</span>
                                    <span className="bg-emerald-900/50 text-emerald-300 px-2 py-0.5 rounded border border-emerald-800">Analog: { creature.base_template }</span>
                                </div>
                            </div>
                            <button onClick={ onClose } className="p-2 bg-slate-800 hover:bg-slate-700 rounded text-slate-400 hover:text-white transition-colors">
                                <X className="w-6 h-6" />
                            </button>
                        </div>

                        <div className="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* COL 1: COMBAT & STATS */ }
                            <div className="space-y-6">
                                <div className="bg-slate-800/50 p-4 rounded border border-slate-700">
                                    <h3 className="text-xs uppercase font-bold text-slate-500 mb-4 flex items-center gap-2">
                                        <Shield className="w-4 h-4" /> Combat Stats
                                    </h3>
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <div className="bg-slate-900 p-3 rounded text-center border border-slate-800">
                                            <div className="text-2xl font-bold text-red-400">{ creature.hp }</div>
                                            <div className="text-[10px] text-slate-500 uppercase">Hit Points</div>
                                        </div>
                                        <div className="bg-slate-900 p-3 rounded text-center border border-slate-800">
                                            <div className="text-2xl font-bold text-blue-400">{ creature.ac }</div>
                                            <div className="text-[10px] text-slate-500 uppercase">Armor Class</div>
                                        </div>
                                    </div>
                                    <h4 className="text-xs font-bold text-slate-400 mb-2 mt-6">Attack Registry</h4>
                                    <div className="space-y-2">
                                        { creature.attacks.map(atk => {
                                            const details = FULL_ATTACK_DATABASE[atk];
                                            if (!details) return null;
                                            const CatIcon = ATTACK_CATEGORIES[details.type]?.icon || Swords;
                                            const catColor = ATTACK_CATEGORIES[details.type]?.color || 'text-white';
                                            return (
                                                <div key={ atk } className="flex justify-between items-center text-sm bg-slate-900 p-2 rounded border border-slate-800">
                                                    <div className="flex items-center gap-2">
                                                        <CatIcon className={ `w-4 h-4 ${catColor}` } />
                                                        <span className="font-medium text-white">{ atk }</span>
                                                    </div>
                                                    <span className="text-xs text-slate-500 font-mono">{ details.damage }</span>
                                                </div>
                                            )
                                        }) }
                                    </div>
                                </div>

                                <div className="bg-slate-800/50 p-4 rounded border border-slate-700">
                                    <h3 className="text-xs uppercase font-bold text-slate-500 mb-4 flex items-center gap-2">
                                        <Activity className="w-4 h-4" /> Pack Threat Simulation
                                    </h3>
                                    <table className="w-full text-xs text-left">
                                        <thead className="text-slate-500 bg-slate-900/50">
                                            <tr>
                                                <th className="p-2">Count</th>
                                                <th className="p-2">Pack Mult</th>
                                                <th className="p-2 text-right">Effective CR</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-800">
                                            { packScenarios.map((s, i) => (
                                                <tr key={ i }>
                                                    <td className="p-2 text-white">{ s.count } { s.count > 10 ? "(Horde)" : "" }</td>
                                                    <td className="p-2 text-slate-400">x{ s.mult }</td>
                                                    <td className="p-2 text-right font-mono font-bold text-orange-400">{ s.eCR }</td>
                                                </tr>
                                            )) }
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* COL 2: MACRO & HARVEST */ }
                            <div className="space-y-6">
                                <div className="bg-slate-800/50 p-4 rounded border border-slate-700">
                                    <h3 className="text-xs uppercase font-bold text-slate-500 mb-4 flex items-center gap-2">
                                        <Dna className="w-4 h-4" /> Biological Profile
                                    </h3>
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-center bg-slate-900 p-3 rounded border border-slate-800">
                                            <span className="text-xs text-slate-400">Size Class</span>
                                            <span className="text-sm font-bold text-emerald-400">{ getSizeName(creature.sizeIdx) } ({ creature.sizeIdx })</span>
                                        </div>
                                        <div>
                                            <div className="flex justify-between text-sm mb-1">
                                                <span className="text-slate-400">Breeding Rate</span>
                                                <span className="text-white font-mono">{ breedingRate } / yr</span>
                                            </div>
                                            <div className="w-full bg-slate-900 h-1.5 rounded-full overflow-hidden">
                                                <div className="bg-green-500 h-full" style={ { width: `${Math.min(100, breedingRate * 50)}%` } }></div>
                                            </div>
                                        </div>
                                        <div>
                                            <div className="flex justify-between text-sm mb-1">
                                                <span className="text-slate-400">Metabolism Cost</span>
                                                <span className="text-white font-mono">{ metabolism } kcal/t</span>
                                            </div>
                                            <div className="w-full bg-slate-900 h-1.5 rounded-full overflow-hidden">
                                                <div className="bg-orange-500 h-full" style={ { width: `${Math.min(100, metabolism * 5)}%` } }></div>
                                            </div>
                                        </div>
                                        <div className="mt-4 bg-slate-900 p-2 rounded border border-slate-800">
                                            <div className="text-[10px] text-slate-500 mb-1">Biome Affinity</div>
                                            <div className="flex flex-wrap gap-1">
                                                { creature.biomes.map(b => (
                                                    <span key={ b } className="text-[10px] bg-slate-800 text-slate-300 px-1.5 py-0.5 rounded">{ BIOMES[b]?.name }</span>
                                                )) }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-slate-800/50 p-4 rounded border border-slate-700">
                                    <h3 className="text-xs uppercase font-bold text-slate-500 mb-4 flex items-center gap-2">
                                        <Gem className="w-4 h-4" /> Resource Yields
                                    </h3>
                                    <div className="grid grid-cols-2 gap-3 text-center">
                                        <div className="bg-slate-900 p-3 rounded border border-slate-800">
                                            <div className="text-xl font-bold text-pink-400">{ meatYield } <span className="text-xs font-normal">lbs</span></div>
                                            <div className="text-[10px] text-slate-500 uppercase mt-1">Raw Meat</div>
                                        </div>
                                        <div className="bg-slate-900 p-3 rounded border border-slate-800">
                                            <div className="text-xl font-bold text-slate-200">{ boneYield } <span className="text-xs font-normal">lbs</span></div>
                                            <div className="text-[10px] text-slate-500 uppercase mt-1">Skeletal Mass</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* COL 3: LOOT TABLES */ }
                            <div className="bg-slate-800/50 p-4 rounded border border-slate-700 h-full flex flex-col">
                                <h3 className="text-xs uppercase font-bold text-slate-500 mb-4 flex items-center gap-2">
                                    <Flask className="w-4 h-4" /> Inferred Loot Table
                                </h3>
                                <div className="space-y-4 overflow-y-auto flex-1 pr-2">
                                    { groupedLoot.map(([method, items], i) => (
                                        <div key={ i } className="border border-slate-700 rounded overflow-hidden">
                                            <div className="bg-slate-900 px-3 py-2 border-b border-slate-700 flex justify-between items-center">
                                                <span className="text-xs font-bold text-emerald-400">Requires { method }</span>
                                                <span className="text-[10px] text-slate-500 flex items-center gap-1">
                                                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></svg>
                                                    { HARVEST_TYPES[method].baseTimeSeconds }s
                                                </span>
                                            </div>
                                            <div className="bg-slate-800/30 p-2 space-y-2">
                                                { items.map((item, j) => (
                                                    <div key={ j } className="flex flex-col gap-1">
                                                        <span className="text-[10px] text-slate-500 ml-1">From: { item.source }</span>
                                                        <div className="flex flex-wrap gap-1">
                                                            { item.drops.map((drop, k) => (
                                                                <span key={ k } className="text-xs bg-slate-800 text-slate-300 px-2 py-1 rounded border border-slate-700 shadow-sm">
                                                                    { drop }
                                                                </span>
                                                            )) }
                                                        </div>
                                                    </div>
                                                )) }
                                            </div>
                                        </div>
                                    )) }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const LootReferenceTab = () => (
            <div className="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-y-auto h-full bg-slate-900">
                {/* COL 1: HARVESTING */ }
                <div>
                    <h3 className="text-sm font-bold text-white mb-4 bg-slate-800 p-2 rounded flex items-center gap-2">
                        <svg className="w-4 h-4 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={ 2 } d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z" /></svg>
                        Harvest Methods
                    </h3>
                    <div className="space-y-2">
                        { Object.entries(HARVEST_TYPES).map(([key, val]) => (
                            <div key={ key } className="bg-slate-800/50 p-3 rounded border border-slate-700">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-sm font-bold text-emerald-400">{ key }</span>
                                    <span className="text-xs font-mono bg-slate-900 px-2 py-0.5 rounded border border-slate-700">{ val.baseTimeSeconds }s</span>
                                </div>
                                <div className="flex justify-between text-xs text-slate-400">
                                    <span>Requires: <span className="text-slate-200">{ val.toolNeeded }</span></span>
                                    <span>Check: <span className="text-slate-200">{ val.attribute }</span></span>
                                </div>
                            </div>
                        )) }
                    </div>
                </div>

                {/* COL 2: MODIFIERS */ }
                <div className="space-y-6">
                    <div>
                        <h3 className="text-sm font-bold text-white mb-4 bg-slate-800 p-2 rounded">Hard Loot Modifiers (Bone/Carapace)</h3>
                        <div className="space-y-1">
                            { Object.entries(HARD_LOOT_MODIFIERS).map(([key, val]) => (
                                <div key={ key } className="flex justify-between items-center bg-slate-800/30 p-2 rounded border border-slate-700/50">
                                    <span className={ `text-sm font-medium ${val.valueMult < 1 ? 'text-red-400' : (val.valueMult > 2 ? 'text-purple-400' : 'text-blue-400')}` }>{ key }</span>
                                    <div className="text-xs text-slate-400 font-mono">
                                        x{ val.valueMult } Val
                                    </div>
                                </div>
                            )) }
                        </div>
                    </div>
                    <div>
                        <h3 className="text-sm font-bold text-white mb-4 bg-slate-800 p-2 rounded">Organic Loot Modifiers (Meat/Glands)</h3>
                        <div className="space-y-1">
                            { Object.entries(ORGANIC_LOOT_MODIFIERS).map(([key, val]) => (
                                <div key={ key } className="flex justify-between items-center bg-slate-800/30 p-2 rounded border border-slate-700/50">
                                    <span className={ `text-sm font-medium ${val.valueMult < 1 ? 'text-orange-400' : (val.valueMult > 2 ? 'text-pink-400' : 'text-emerald-400')}` }>{ key }</span>
                                    <div className="text-xs text-slate-400 font-mono">
                                        x{ val.valueMult } Val
                                    </div>
                                </div>
                            )) }
                        </div>
                    </div>
                </div>

                {/* COL 3: ANATOMY */ }
                <div>
                    <h3 className="text-sm font-bold text-white mb-4 bg-slate-800 p-2 rounded">Anatomy Parts Registry</h3>
                    <div className="space-y-2 overflow-y-auto max-h-[75vh] pr-2">
                        { Object.entries(ANATOMY_PARTS).map(([key, val]) => (
                            <div key={ key } className="bg-slate-800/50 p-3 rounded border border-slate-700">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-sm font-bold text-indigo-300">{ key }</span>
                                    <span className="text-[10px] uppercase bg-slate-900 px-1.5 py-0.5 rounded text-slate-400">{ val.defaultHarvest }</span>
                                </div>
                                <div className="flex flex-wrap gap-1">
                                    { val.baseDrops.map(drop => (
                                        <span key={ drop } className="text-xs bg-black/40 px-2 py-1 rounded text-slate-300 border border-slate-700">{ drop }</span>
                                    )) }
                                </div>
                            </div>
                        )) }
                    </div>
                </div>
            </div>
        );

        const ModifiersReferenceTab = () => (
            <div className="p-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 overflow-y-auto h-full bg-slate-900">
                <div>
                    <h3 className="text-sm font-bold text-white mb-4 bg-slate-800 p-2 rounded">Age & Size Multipliers</h3>
                    { Object.entries(SIZE_AND_AGE_MODIFIERS).map(([key, val]) => (
                        <div key={ key } className="mb-2 bg-slate-800/50 p-2 rounded border border-slate-700 text-xs">
                            <div className="font-bold text-blue-300 flex justify-between">
                                { key } <span className="text-slate-500">x{ val.crMult } CR</span>
                            </div>
                            <div className="grid grid-cols-2 gap-1 mt-1 text-slate-400">
                                <span>HP: x{ val.hpMult }</span>
                                <span>AC: { val.acMod > 0 ? '+' : '' }{ val.acMod }</span>
                            </div>
                        </div>
                    )) }
                </div>
                <div>
                    <h3 className="text-sm font-bold text-white mb-4 bg-slate-800 p-2 rounded">Conditions (State)</h3>
                    { Object.entries(CONDITION_MODIFIERS).map(([key, val]) => (
                        <div key={ key } className="mb-2 bg-slate-800/50 p-2 rounded border border-slate-700 text-xs">
                            <div className="font-bold text-orange-300 flex justify-between mb-1">
                                { key } <span className="text-slate-500 font-mono">x{ val.crMult } CR</span>
                            </div>
                            <div className="text-slate-400 mb-1">AI: { val.behavior }</div>
                            { val.addedAttack && <div className="text-red-400">+ Atk: { val.addedAttack }</div> }
                        </div>
                    )) }
                </div>
                <div>
                    <h3 className="text-sm font-bold text-white mb-4 bg-slate-800 p-2 rounded">Biological Upgrades (Elite)</h3>
                    { Object.entries(BIOLOGICAL_UPGRADES).map(([key, val]) => (
                        <div key={ key } className="mb-2 bg-slate-800/50 p-2 rounded border border-slate-700 text-xs">
                            <div className="font-bold text-purple-300 flex justify-between mb-1">
                                { key } <span className="text-slate-500 font-mono">x{ val.crMult } CR</span>
                            </div>
                            <div className="grid grid-cols-2 gap-1 mt-1 text-slate-400">
                                <span>HP: x{ val.hpMult }</span>
                                <span>AC: { val.acMod > 0 ? '+' : '' }{ val.acMod }</span>
                            </div>
                            { val.addedAttack && <div className="mt-1 text-red-400">+ Atk: { val.addedAttack }</div> }
                        </div>
                    )) }
                </div>
                <div>
                    <h3 className="text-sm font-bold text-white mb-4 bg-slate-800 p-2 rounded">Pigmentation (Stealth Mods)</h3>
                    { Object.entries(PIGMENTATION).map(([key, val]) => (
                        <div key={ key } className="mb-2 bg-slate-800/50 p-2 rounded border border-slate-700 text-xs">
                            <div className="font-bold text-emerald-300 flex justify-between mb-1">
                                { key } <span className="text-slate-500">Stealth { val.stealthMod > 0 ? '+' : '' }{ val.stealthMod }</span>
                            </div>
                            <div className="text-slate-500 italic leading-tight">{ val.flavor }</div>
                        </div>
                    )) }
                    <h3 className="text-sm font-bold text-white mb-4 mt-6 bg-slate-800 p-2 rounded">Patterns</h3>
                    { Object.entries(PATTERNS).map(([key, val]) => (
                        <div key={ key } className="mb-2 bg-slate-800/50 p-2 rounded border border-slate-700 text-xs">
                            <div className="font-bold text-indigo-300 flex justify-between mb-1">
                                { key } <span className="text-slate-500">Stealth { val.stealthMod > 0 ? '+' : '' }{ val.stealthMod }</span>
                            </div>
                            <div className="text-slate-500 italic leading-tight">{ val.flavor }</div>
                        </div>
                    )) }
                </div>
            </div>
        );

        // --- MAIN COMPONENT ---

        function BestiaryArchitect() {
            const [library, setLibrary] = useState([]);
            const [useVariants, setUseVariants] = useState(true);
            const [activeTab, setActiveTab] = useState("creatures");
            const [selectedCreature, setSelectedCreature] = useState(null);

            const bulkImportAll = () => {
                let allCreatures = [];
                Object.keys(REAL_WORLD_DATA).forEach(category => {
                    Object.keys(REAL_WORLD_DATA[category]).forEach(name => {
                        const tmpl = REAL_WORLD_DATA[category][name];
                        const baseSizeIdx = SIZE_INDICES[tmpl.size] || 4;

                        const variantsToGen = useVariants ? Object.entries(SIZE_AND_AGE_MODIFIERS) : [["Standard", SIZE_AND_AGE_MODIFIERS["Standard"]]];

                        variantsToGen.forEach(([variantName, mod]) => {
                            let newSizeIdx = Math.max(2, Math.min(16, baseSizeIdx + mod.sizeStep));
                            let finalName = variantName === "Standard" ? name : `${variantName} ${name}`;
                            let newHP = Math.floor(tmpl.hp * mod.hpMult);
                            let newCR = parseFloat((tmpl.cr * mod.crMult).toFixed(2));
                            let newAC = tmpl.ac + mod.acMod;
                            let newAttacks = [...tmpl.attacks];
                            if (mod.addedAttack && !newAttacks.includes(mod.addedAttack)) newAttacks.push(mod.addedAttack);

                            allCreatures.push({
                                id: crypto.randomUUID(),
                                name: finalName,
                                type: tmpl.type,
                                sizeIdx: newSizeIdx,
                                cr: newCR,
                                hp: newHP,
                                ac: newAC,
                                biomes: tmpl.biomes,
                                attacks: newAttacks,
                                base_template: name
                            });
                        });
                    });
                });
                setLibrary(allCreatures);
            };

            const generateRandom = () => {
                const categories = Object.keys(REAL_WORLD_DATA);
                const randomCat = categories[Math.floor(Math.random() * categories.length)];
                const templates = Object.keys(REAL_WORLD_DATA[randomCat]);
                const randomName = templates[Math.floor(Math.random() * templates.length)];
                const tmpl = REAL_WORLD_DATA[randomCat][randomName];

                const variants = Object.entries(SIZE_AND_AGE_MODIFIERS);
                const [variantName, mod] = variants[Math.floor(Math.random() * variants.length)];

                const baseSizeIdx = SIZE_INDICES[tmpl.size] || 4;
                let newSizeIdx = Math.max(2, Math.min(16, baseSizeIdx + mod.sizeStep));
                let finalName = variantName === "Standard" ? randomName : `${variantName} ${randomName}`;

                let newAttacks = [...tmpl.attacks];
                if (mod.addedAttack && !newAttacks.includes(mod.addedAttack)) newAttacks.push(mod.addedAttack);

                setLibrary(prev => [...prev, {
                    id: crypto.randomUUID(),
                    name: finalName,
                    type: tmpl.type,
                    sizeIdx: newSizeIdx,
                    cr: parseFloat((tmpl.cr * mod.crMult).toFixed(2)),
                    hp: Math.floor(tmpl.hp * mod.hpMult),
                    ac: tmpl.ac + mod.acMod,
                    biomes: tmpl.biomes,
                    attacks: newAttacks,
                    base_template: randomName
                }]);
            };

            const generateSQL = () => {
                let sql = `-- Project Epoch Database Export\n`;
                sql += `-- Generated: ${new Date().toISOString()}\n`;
                sql += `-- Creatures: ${library.length} | Attacks: ${Object.keys(FULL_ATTACK_DATABASE).length}\n\n`;

                sql += `PRAGMA foreign_keys = ON;\n\n`;

                sql += `-- [1] HARVEST TYPES\n`;
                sql += `CREATE TABLE IF NOT EXISTS Harvest_Types (id TEXT PRIMARY KEY, tool TEXT, attribute TEXT, speed TEXT, time_sec INTEGER);\n`;
                Object.entries(HARVEST_TYPES).forEach(([k, v]) => {
                    sql += `INSERT OR IGNORE INTO Harvest_Types VALUES ('${k}', '${v.toolNeeded}', '${v.attribute}', '${v.speed}', ${v.baseTimeSeconds});\n`;
                });
                sql += `\n`;

                sql += `-- [2] ANATOMY PARTS\n`;
                sql += `CREATE TABLE IF NOT EXISTS Anatomy_Parts (id TEXT PRIMARY KEY, default_harvest TEXT, drops TEXT);\n`;
                Object.entries(ANATOMY_PARTS).forEach(([k, v]) => {
                    sql += `INSERT OR IGNORE INTO Anatomy_Parts VALUES ('${k}', '${v.defaultHarvest}', '${v.baseDrops.join(",")}');\n`;
                });
                sql += `\n`;

                sql += `-- [3] LOOT MODIFIERS\n`;
                sql += `CREATE TABLE IF NOT EXISTS Loot_Modifiers (id TEXT PRIMARY KEY, type TEXT, multiplier REAL, quality TEXT, weight INTEGER);\n`;
                Object.entries(HARD_LOOT_MODIFIERS).forEach(([k, v]) => {
                    sql += `INSERT OR IGNORE INTO Loot_Modifiers VALUES ('${k}', 'HARD', ${v.valueMult}, '${v.craftQuality}', ${v.dropWeight});\n`;
                });
                Object.entries(ORGANIC_LOOT_MODIFIERS).forEach(([k, v]) => {
                    sql += `INSERT OR IGNORE INTO Loot_Modifiers VALUES ('${k}', 'ORGANIC', ${v.valueMult}, '${v.craftQuality}', ${v.dropWeight});\n`;
                });
                sql += `\n`;

                sql += `-- [4] ATTACK DEFINITIONS\n`;
                sql += `CREATE TABLE IF NOT EXISTS Attack_Defs (\n`;
                sql += `  id INTEGER PRIMARY KEY AUTOINCREMENT,\n`;
                sql += `  name TEXT UNIQUE,\n`;
                sql += `  category TEXT,\n`;
                sql += `  effect TEXT,\n`;
                sql += `  base_damage TEXT,\n`;
                sql += `  anatomy_tag TEXT\n`;
                sql += `);\n\n`;

                sql += `BEGIN TRANSACTION;\n`;
                Object.entries(FULL_ATTACK_DATABASE).forEach(([name, data]) => {
                    sql += `INSERT OR IGNORE INTO Attack_Defs (name, category, effect, base_damage, anatomy_tag) VALUES ('${name}', '${data.type}', '${data.effect}', '${data.damage}', '${data.anatomyTag}');\n`;
                });
                sql += `COMMIT;\n\n`;

                sql += `-- [5] CREATURE GENETICS\n`;
                sql += `CREATE TABLE IF NOT EXISTS Creature_Defs (\n`;
                sql += `  id TEXT PRIMARY KEY,\n`;
                sql += `  name TEXT,\n`;
                sql += `  type TEXT,\n`;
                sql += `  size_index INTEGER,\n`;
                sql += `  cr REAL,\n`;
                sql += `  hp INTEGER,\n`;
                sql += `  ac INTEGER,\n`;
                sql += `  biomes_json TEXT\n`;
                sql += `);\n\n`;

                sql += `-- [6] CREATURE <-> ATTACK LINK\n`;
                sql += `CREATE TABLE IF NOT EXISTS Creature_Attacks (\n`;
                sql += `  creature_id TEXT,\n`;
                sql += `  attack_name TEXT,\n`;
                sql += `  FOREIGN KEY(creature_id) REFERENCES Creature_Defs(id),\n`;
                sql += `  FOREIGN KEY(attack_name) REFERENCES Attack_Defs(name)\n`;
                sql += `);\n\n`;

                sql += `BEGIN TRANSACTION;\n`;
                library.forEach(c => {
                    sql += `INSERT INTO Creature_Defs (id, name, type, size_index, cr, hp, ac, biomes_json) VALUES ('${c.id}', '${c.name.replace(/'/g, "''")}', '${c.type}', ${c.sizeIdx}, ${c.cr}, ${c.hp}, ${c.ac}, '${JSON.stringify(c.biomes)}');\n`;
                    c.attacks.forEach(atk => {
                        sql += `INSERT INTO Creature_Attacks (creature_id, attack_name) VALUES ('${c.id}', '${atk}');\n`;
                    });
                });
                sql += `COMMIT;\n`;

                return sql;
            };

            const downloadSQL = () => {
                const element = document.createElement("a");
                const file = new Blob([generateSQL()], { type: 'text/plain' });
                element.href = URL.createObjectURL(file);
                element.download = "epoch_database.sql";
                document.body.appendChild(element);
                element.click();
            };

            return (
                <div className="flex flex-col h-screen bg-slate-900 text-slate-100 font-sans">
                    <header className="bg-slate-950 p-4 border-b border-slate-700 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <Database className="w-6 h-6 text-emerald-400" />
                            <h1 className="text-xl font-bold tracking-wide">EPOCH <span className="text-slate-500 font-light">BESTIARY ARCHITECT V3</span></h1>
                        </div>
                        <div className="flex items-center gap-4">
                            <button
                                onClick={ generateRandom }
                                className="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-200 px-3 py-2 rounded text-sm font-medium transition-colors border border-slate-600"
                            >
                                <Dna className="w-4 h-4 text-purple-400" /> Add Random
                            </button>
                            <div className="flex items-center gap-2 bg-slate-900 border border-slate-700 rounded px-3 py-1">
                                <input
                                    type="checkbox"
                                    checked={ useVariants }
                                    onChange={ (e) => setUseVariants(e.target.checked) }
                                    className="accent-indigo-500"
                                />
                                <label className="text-xs text-slate-400">Gen Variants (x8)</label>
                            </div>
                            <button
                                onClick={ bulkImportAll }
                                className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded text-sm font-medium transition-colors"
                            >
                                <Globe className="w-4 h-4" /> Generate All
                            </button>
                            <button
                                onClick={ downloadSQL }
                                className="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded text-sm font-medium transition-colors"
                            >
                                <Save className="w-4 h-4" /> Export DB
                            </button>
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden">
                        {/* SIDEBAR */ }
                        <div className="w-16 bg-slate-950 border-r border-slate-800 flex flex-col items-center py-4 gap-4">
                            <button onClick={ () => setActiveTab('creatures') } className={ `p-2 rounded group relative ${activeTab === 'creatures' ? 'bg-indigo-600 text-white' : 'text-slate-500 hover:text-slate-300'}` }>
                                <Activity className="w-6 h-6" />
                                <span className="absolute left-14 bg-slate-800 text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-50">Creatures</span>
                            </button>
                            <button onClick={ () => setActiveTab('attacks') } className={ `p-2 rounded group relative ${activeTab === 'attacks' ? 'bg-indigo-600 text-white' : 'text-slate-500 hover:text-slate-300'}` }>
                                <Swords className="w-6 h-6" />
                                <span className="absolute left-14 bg-slate-800 text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-50">Attacks</span>
                            </button>
                            <button onClick={ () => setActiveTab('loot') } className={ `p-2 rounded group relative ${activeTab === 'loot' ? 'bg-indigo-600 text-white' : 'text-slate-500 hover:text-slate-300'}` }>
                                <Gem className="w-6 h-6" />
                                <span className="absolute left-14 bg-slate-800 text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-50">Loot & Anatomy</span>
                            </button>
                            <button onClick={ () => setActiveTab('modifiers') } className={ `p-2 rounded group relative ${activeTab === 'modifiers' ? 'bg-indigo-600 text-white' : 'text-slate-500 hover:text-slate-300'}` }>
                                <Flask className="w-6 h-6" />
                                <span className="absolute left-14 bg-slate-800 text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-50">Modifiers</span>
                            </button>
                        </div>

                        {/* CONTENT */ }
                        <div className="flex-1 flex overflow-hidden relative">
                            { activeTab === 'creatures' && (
                                <div className="flex-1 p-6 overflow-y-auto">
                                    <div className="flex justify-between items-end mb-4 border-b border-slate-800 pb-2">
                                        <div>
                                            <h2 className="text-lg font-bold text-white">Creature Registry</h2>
                                            <p className="text-xs text-slate-500">
                                                { library.length > 0 ? `${library.length} entities generated ready for export.` : "Registry is empty. Click 'Generate All' to populate." }
                                            </p>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                                        { library.map((c, idx) => {
                                            const crStyle = getCRColor(c.cr);
                                            return (
                                                <div
                                                    key={ idx }
                                                    onClick={ () => setSelectedCreature(c) }
                                                    className="bg-slate-800 p-3 rounded border border-slate-700 text-sm hover:border-indigo-500 transition-colors cursor-pointer group"
                                                >
                                                    <div className="flex justify-between items-start mb-2">
                                                        <span className="font-bold text-white group-hover:text-indigo-300 transition-colors">{ c.name }</span>
                                                        <span className={ `text-[10px] px-1.5 py-0.5 rounded font-bold border ${crStyle}` }>CR { c.cr }</span>
                                                    </div>
                                                    <div className="flex gap-2 text-xs text-slate-500 mb-2">
                                                        <span>{ getSizeName(c.sizeIdx) }</span>
                                                        <span></span>
                                                        <span>HP { c.hp }</span>
                                                        <span></span>
                                                        <span>AC { c.ac }</span>
                                                    </div>
                                                    <div className="flex flex-wrap gap-1">
                                                        { c.attacks.slice(0, 3).map(atk => {
                                                            const details = FULL_ATTACK_DATABASE[atk];
                                                            const CatIcon = details ? ATTACK_CATEGORIES[details.type]?.icon || Swords : Swords;
                                                            return (
                                                                <span key={ atk } className="flex items-center gap-1 text-[10px] bg-slate-900 text-slate-300 px-1.5 py-0.5 rounded border border-slate-700">
                                                                    <CatIcon className="w-3 h-3 text-slate-500" /> { atk }
                                                                </span>
                                                            )
                                                        }) }
                                                        { c.attacks.length > 3 && <span className="text-[10px] text-slate-500 bg-slate-900 px-1.5 py-0.5 rounded">+{ c.attacks.length - 3 }</span> }
                                                    </div>
                                                </div>
                                            )
                                        }) }
                                        { library.length === 0 && (
                                            <div className="col-span-full h-64 flex items-center justify-center text-slate-600 border border-dashed border-slate-700 rounded-lg">
                                                No Creatures Generated
                                            </div>
                                        ) }
                                    </div>
                                </div>
                            ) }

                            { activeTab === 'attacks' && (
                                <div className="flex-1 p-6 overflow-y-auto bg-slate-900">
                                    <h2 className="text-lg font-bold text-white mb-6">Attack Definitions (Runtime Database)</h2>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div className="bg-slate-800 p-4 rounded border border-slate-700 h-fit sticky top-0">
                                            <h3 className="text-xs uppercase font-bold text-slate-500 mb-4">Damage Categories</h3>
                                            <div className="space-y-3">
                                                { Object.entries(ATTACK_CATEGORIES).map(([cat, info]) => {
                                                    const CatIcon = info.icon;
                                                    return (
                                                        <div key={ cat } className="flex items-center gap-3 bg-slate-900 p-2 rounded">
                                                            <CatIcon className={ `w-5 h-5 ${info.color}` } />
                                                            <span className={ `w-20 text-sm font-bold ${info.color}` }>{ cat }</span>
                                                            <span className="text-xs text-slate-400">{ info.desc }</span>
                                                        </div>
                                                    )
                                                }) }
                                            </div>
                                        </div>
                                        <div className="space-y-2">
                                            <h3 className="text-xs uppercase font-bold text-slate-500 mb-2">Registered Attacks ({ Object.keys(FULL_ATTACK_DATABASE).length })</h3>
                                            { Object.entries(FULL_ATTACK_DATABASE).map(([name, data]) => {
                                                const CatIcon = ATTACK_CATEGORIES[data.type]?.icon || Swords;
                                                return (
                                                    <div key={ name } className="flex items-center justify-between bg-slate-800 p-3 rounded border border-slate-700">
                                                        <div className="flex items-center gap-3">
                                                            <div className="bg-slate-900 p-2 rounded">
                                                                <CatIcon className={ `w-4 h-4 ${ATTACK_CATEGORIES[data.type]?.color || 'text-white'}` } />
                                                            </div>
                                                            <div>
                                                                <div className="font-bold text-sm text-slate-200">{ name }</div>
                                                                <div className="text-xs text-slate-500">{ data.type } { data.effect !== 'None' ? ` ${data.effect}` : '' }</div>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="font-mono text-sm text-slate-400 bg-slate-950 px-2 py-1 rounded mb-1 border border-slate-800">
                                                                { data.damage }
                                                            </div>
                                                            <div className="text-[10px] text-indigo-400">{ data.anatomyTag }</div>
                                                        </div>
                                                    </div>
                                                )
                                            }) }
                                        </div>
                                    </div>
                                </div>
                            ) }

                            { activeTab === 'loot' && <LootReferenceTab /> }
                            { activeTab === 'modifiers' && <ModifiersReferenceTab /> }

                            {/* DETAIL MODAL */ }
                            <CreatureDetailModal creature={ selectedCreature } onClose={ () => setSelectedCreature(null) } />
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BestiaryArchitect />);
    </script>
</body>

</html>